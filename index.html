<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF é–±è®€åœ°åœ– (Ultimate V10.3 - Full Structure)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <style>
        /* =========================================
           1. å…¨åŸŸè®Šæ•¸èˆ‡é…è‰² (CSS Variables)
           ========================================= */
        :root {
            --bg-color: #525659;
            --sidebar-bg: #f8f9fa;
            --sidebar-text: #333;
            --item-bg: white;
            --item-border: #ddd;
            --text-color: #333;
            --modal-bg: white;
            --input-bg: white;
            --input-text: #000;
            --link-color: #007bff;
        }

        body.dark-mode {
            --bg-color: #1e1e1e;
            --sidebar-bg: #252526;
            --sidebar-text: #ccc;
            --item-bg: #333333;
            --item-border: #444;
            --text-color: #eee;
            --modal-bg: #2d2d2d;
            --input-bg: #3c3c3c;
            --input-text: #eee;
            --link-color: #4da3ff;
        }

        body { 
            margin: 0; padding: 0; background: #333; 
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
            color: var(--text-color);
        }

        /* =========================================
           2. å·¥å…·åˆ— (Toolbar)
           ========================================= */
        .toolbar { 
            background: #222; color: white; padding: 10px 20px; 
            display: flex; align-items: center; gap: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 100; flex-shrink: 0; flex-wrap: wrap; 
        }
        .reader-toolbar { 
            background: #202b38; color: white; padding: 15px 20px; 
            display: none; align-items: center; justify-content: space-between; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 101; flex-shrink: 0; 
        }
        h1 { margin: 0; font-size: 1.1em; color: #fff; margin-right: 10px; display: flex; align-items: center; gap: 5px; user-select: none; }
        
        button { 
            padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; 
            font-weight: bold; background: #444; color: white; transition: 0.2s; 
            white-space: nowrap; font-size: 0.9em; display: inline-flex; align-items: center; gap: 4px; 
        }
        button:hover { background: #666; transform: translateY(-1px); }
        button.primary { background: #28a745; } button.primary:hover { background: #218838; }
        button.export { background: #17a2b8; } button.info { background: #138496; }
        button.warning { background: #ffc107; color: #333; } button.danger { background: #dc3545; }
        button.ai-btn { background: #6f42c1; } button.ai-btn:hover { background: #59359a; }

        .zoom-btn { width: 30px; justify-content: center; padding: 6px 0; }
        
        .mode-switch { display: flex; background: #444; border-radius: 20px; padding: 2px; border: 1px solid #555; margin-right: 5px; }
        .mode-btn { padding: 4px 12px; border-radius: 15px; cursor: pointer; font-size: 0.85em; color: #ccc; transition: 0.2s; user-select: none; }
        .mode-btn.active { background: #007bff; color: white; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        .direct-switch { display: flex; align-items: center; margin-right: 10px; cursor: pointer; user-select: none; background: #444; padding: 2px 8px; border-radius: 15px; border: 1px solid #555; }
        .direct-switch.active { background: #dc3545; border-color: #dc3545; }
        .direct-switch span { font-size: 0.8em; margin-left: 5px; color: #ccc; }
        .direct-switch.active span { color: white; font-weight: bold; }

        .search-box { display: flex; align-items: center; background: white; border-radius: 4px; overflow: hidden; margin-left: auto; }
        .search-input { border: none; padding: 6px 10px; outline: none; font-size: 0.9em; width: 140px; color: #333; }
        .search-btn { background: #ffc107; color: #333; border-radius: 0; padding: 6px 10px; }

        /* =========================================
           3. å·¥ä½œå€ (Workspace)
           ========================================= */
        .workspace { display: flex; flex: 1; overflow: hidden; position: relative; background: var(--bg-color); }
        .workspace.sidebar-left { flex-direction: row-reverse; }
        .workspace.sidebar-left .sidebar { border-left: none; border-right: 1px solid #ccc; }

        #viewerContainer { 
            flex: 1; overflow-y: auto; position: relative; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px; padding-bottom: 120px; user-select: none; 
        }
        body.grabbing-mode #viewerContainer, body.grabbing-mode .pdf-page { cursor: grab !important; }
        body.grabbing-mode #viewerContainer:active { cursor: grabbing !important; }

        .pdf-page { position: relative; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); background: white; cursor: crosshair; transition: filter 0.3s; }
        body.dark-mode .pdf-page { filter: invert(0.9) hue-rotate(180deg); }
        
        .selection-marquee { position: absolute; border: 2px dashed #007bff; background-color: rgba(0, 123, 255, 0.2); pointer-events: none; z-index: 100; }
        .textLayer { opacity: 1; line-height: 1.0; }
        .textLayer span { color: transparent; position: absolute; white-space: pre; cursor: crosshair; }
        
        .highlight-text { background-color: rgba(255, 235, 59, 0.4); border-bottom: 2px solid #e6a800; cursor: pointer; }
        .highlight-area { position: absolute; border: 3px solid #dc3545; background-color: rgba(220, 53, 69, 0.1); cursor: pointer; z-index: 50; transition: 0.2s; }
        .highlight-area:hover { background-color: rgba(220, 53, 69, 0.3); }
        .highlight-flash { animation: flash 1s ease-in-out; }
        @keyframes flash { 0%, 100% { opacity: 1; border-color: red; box-shadow: 0 0 15px red; } 50% { opacity: 0.2; } }

        /* =========================================
           4. å´é‚Šæ¬„ (Sidebar)
           ========================================= */
        .sidebar { 
            width: 320px; background: var(--sidebar-bg); border-left: 1px solid #ccc; 
            display: flex; flex-direction: column; z-index: 90; color: var(--sidebar-text);
            transition: background 0.3s;
        }
        .sidebar-tabs { display: flex; background: #ddd; border-bottom: 1px solid #bbb; }
        body.dark-mode .sidebar-tabs { background: #333; border-bottom: 1px solid #555; }
        
        .sidebar-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-size: 0.9em; font-weight: bold; color: #666; user-select: none; }
        body.dark-mode .sidebar-tab { color: #aaa; }
        .sidebar-tab.active { background: var(--sidebar-bg); color: var(--sidebar-text); border-top: 3px solid #007bff; }

        .sidebar-header { padding: 10px; background: var(--sidebar-bg); border-bottom: 1px solid #ddd; display: flex; flex-direction: column; gap: 8px; }
        body.dark-mode .sidebar-header { border-bottom: 1px solid #444; }

        #sidebarSearchInput {
            width: 100%; padding: 6px; font-size: 0.9em; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc;
            background: var(--input-bg); color: var(--input-text);
        }

        .sidebar-filter { width: 100%; padding: 5px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 4px; background: var(--input-bg); color: var(--input-text); }
        .sidebar-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .list-item { 
            background: var(--item-bg); padding: 10px; margin-bottom: 8px; border-radius: 8px; 
            border: 1px solid var(--item-border); cursor: pointer; border-left: 5px solid #ccc; 
            transition: 0.2s; position: relative; padding-right: 50px; 
        }
        .list-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .item-actions { position: absolute; top: 5px; right: 5px; display: flex; flex-direction: column; gap: 2px; }
        .icon-btn { width: 24px; height: 24px; border: none; background: transparent; border-radius: 4px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 14px; color: #666; transition: 0.2s; }
        .icon-btn:hover { background: #eee; color: #000; }
        .tag-badge { display: inline-block; padding: 2px 6px; border-radius: 10px; font-size: 0.75em; color: white; background: #999; margin-right: 5px; vertical-align: middle; }

        .bookmark-item { 
            background: var(--item-bg); padding: 10px; margin-bottom: 5px; border-radius: 4px; border: 1px solid var(--item-border); 
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        body.dark-mode .bookmark-item:hover { background: #444; }

        .memo-link { color: var(--link-color); text-decoration: underline; cursor: pointer; font-weight: bold; }
        .memo-link:hover { opacity: 0.8; }

        /* =========================================
           5. è¦–çª—èˆ‡å…ƒä»¶ (Modals & Widgets)
           ========================================= */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 3000; pointer-events: none; }
        .modal-card { 
            position: absolute; background: var(--modal-bg); color: var(--text-color); width: 450px; padding: 20px; 
            border-radius: 12px; display: flex; flex-direction: column; gap: 12px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); max-height: 90vh; overflow-y: auto; 
            pointer-events: auto; border: 1px solid #999;
        }
        
        #aiModal .modal-card { width: 600px; height: 80vh; }
        .ai-list { flex: 1; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: var(--input-bg); border-radius: 4px; }
        .ai-item { display: flex; align-items: center; gap: 10px; padding: 5px; border-bottom: 1px solid #eee; }
        .ai-item label { flex: 1; cursor: pointer; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ai-output { width: 100%; height: 150px; margin-top: 10px; padding: 10px; font-family: monospace; background: #222; color: #0f0; border: none; resize: vertical; }

        .preview-box { background: #f0f0f0; padding: 10px; font-size: 0.9em; max-height: 150px; overflow-y: auto; border-radius: 4px; margin-bottom: 10px; border: 1px solid #ccc; resize: vertical; outline: none; color:#333; }
        .rich-memo { 
            width: 100%; min-height: 100px; max-height: 200px; padding: 10px; 
            border: 1px solid #ddd; border-radius: 4px; overflow-y: auto; 
            background: var(--input-bg); color: var(--input-text);
            line-height: 1.5; font-size: 0.95em; overflow-wrap: break-word; word-wrap: break-word; resize: vertical; 
        }
        .memo-toolbar { display: flex; gap: 5px; margin-bottom: 5px; background: #eee; padding: 5px; border-radius: 4px; flex-wrap: wrap; }
        body.dark-mode .memo-toolbar { background: #444; }
        .memo-btn { font-size: 0.8em; padding: 3px 8px; background: white; color: #333; border: 1px solid #ccc; }
        
        #searchPanel { position: absolute; top: 60px; right: 340px; width: 320px; max-height: 500px; background: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; flex-direction: column; z-index: 2000; }
        .search-results { overflow-y: auto; padding: 5px; flex: 1; }
        .search-item { padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 0.9em; display: flex; gap: 10px; align-items: center; justify-content: space-between; }
        
        .floating-nav { 
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background: rgba(33, 37, 41, 0.95); padding: 8px 15px; border-radius: 50px; 
            display: flex; gap: 10px; align-items: center; color: white; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 200; backdrop-filter: blur(4px); border: 1px solid #555; 
        }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 4000; }
        .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; justify-content: center; align-items: center; cursor: zoom-out; flex-direction: column; }
        .lightbox img { max-width: 90%; max-height: 85%; box-shadow: 0 0 20px rgba(255,255,255,0.2); border: 2px solid white; object-fit: contain; }
        .list-item img { cursor: zoom-in; transition: 0.2s; } .list-item img:hover { opacity: 0.8; outline: 2px solid #007bff; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: inherit; background: var(--input-bg); color: var(--input-text); }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><h3 id="loaderText">è™•ç†ä¸­...</h3></div>

    <div class="toolbar" id="editToolbar">
        <h1>ğŸ› ï¸ V10.3</h1>
        <button onclick="toggleDarkMode()" title="åˆ‡æ›æ·±è‰²æ¨¡å¼">ğŸŒ™</button>
        <button onclick="toggleSidebarLayout()" title="åˆ‡æ›ä½ˆå±€">â¬…ï¸</button>

        <div class="mode-switch">
            <div class="mode-btn active" id="modeText" onclick="setMode('text')">ğŸ“ æ–‡å­—</div>
            <div class="mode-btn" id="modeArea" onclick="setMode('area')">ğŸ–¼ï¸ åœ–è¡¨</div>
        </div>

        <div class="direct-switch" id="directSwitch" onclick="toggleDirectMode()">ğŸ–ï¸<span>ç•«ç·š</span></div>

        <button class="ai-btn" onclick="openAIModal()">ğŸ¤– AI åŠ©æ‰‹</button>

        <button onclick="openSettings()">âš™ï¸ è¨­å®š</button>
        <button class="warning" onclick="openGlobalMemo()">ğŸ’¡ éˆæ„Ÿ</button>

        <button onclick="document.getElementById('pdfInput').click()">ğŸ“‚ PDF</button>
        <input type="file" id="pdfInput" accept="application/pdf" style="display:none" onchange="handlePdfUpload(this)">
        <button onclick="document.getElementById('projectInput').click()">ğŸ“¥ å°ˆæ¡ˆ</button>
        <input type="file" id="projectInput" accept=".json" style="display:none" onchange="handleProjectLoad(this)">
        
        <div style="flex:1"></div> 
        <button class="primary" onclick="saveProject()">ğŸ’¾</button>
        <button class="export" onclick="exportReaderHtml()">ğŸ“¦</button>
        <button class="danger" onclick="exportExcel()">ğŸ“Š</button>

        <div class="search-box">
            <input type="text" id="globalSearchInput" class="search-input" placeholder="å…¨åŸŸæœå°‹..." onkeydown="if(event.key==='Enter') performGlobalSearch()">
            <button class="search-btn" onclick="performGlobalSearch()">ğŸ”</button>
        </div>
    </div>

    <div class="reader-toolbar" id="readToolbar">
        <div style="display:flex; align-items:center; gap:15px;">
            <h1 style="color:#28a745;">ğŸ“– é–±è®€æ¨¡å¼</h1>
            <span style="font-size:0.9em; color:#bbb;" id="readerFileName"></span>
        </div>
        <div>
            <button class="primary" onclick="document.getElementById('readerPdfInput').click()">ğŸ“‚ é–‹å•ŸåŸå§‹ PDF</button>
            <input type="file" id="readerPdfInput" accept="application/pdf" style="display:none" onchange="handlePdfUpload(this)">
        </div>
    </div>

    <div class="workspace" id="workspace">
        <div id="viewerContainer">
            <div style="margin-top:100px; color:#aaa; text-align:center;" id="placeholder">
                <h3>è«‹åŒ¯å…¥ PDF</h3>
                <p>V10.3 (Full Source): AIã€æœå°‹ã€é€£çµ</p>
                <p>å·²ç¢ºèªæ‰€æœ‰å‡½å¼çš†å®Œæ•´å±•é–‹ï¼Œç„¡ç¸®æ¸›ã€‚</p>
            </div>
            <div id="searchPanel">
                <div class="search-header">
                    <span>âš¡ é€ŸæŸ¥</span><span style="cursor:pointer; font-size:1.2em;" onclick="closeSearch()">Ã—</span>
                </div>
                <div class="search-results" id="searchResultsList"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" id="tabIndex" onclick="switchSidebarTab('index')">ğŸ“ ç´¢å¼•</div>
                <div class="sidebar-tab" id="tabBookmark" onclick="switchSidebarTab('bookmark')">ğŸ”– æ›¸ç±¤</div>
            </div>

            <div id="panelIndex" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                <div class="sidebar-header">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold;">åˆ—è¡¨ (<span id="count">0</span>)</span>
                        <button style="font-size:0.75em; padding:2px 6px; background:#6c757d;" onclick="clearAutoSave()">æ¸…ç©º</button>
                    </div>
                    <input type="text" id="sidebarSearchInput" placeholder="ğŸ” æœå°‹ ID/æ¨™é¡Œ/æ¨™ç±¤/å…§æ–‡..." oninput="renderSidebar()">
                    
                    <select class="sidebar-filter" id="sidebarFilter" onchange="renderSidebar()" style="margin-top:5px;">
                        <option value="all">é¡¯ç¤ºå…¨éƒ¨</option>
                        <option value="High">ğŸ”´ High</option>
                        <option value="Pending">ğŸ•’ Pending</option>
                        <option value="Image">ğŸ–¼ï¸ åœ–ç‰‡</option>
                    </select>
                </div>
                <div class="sidebar-list" id="sidebarList"></div>
            </div>

            <div id="panelBookmark" style="display:none; flex-direction:column; flex:1; overflow:hidden;">
                <div class="sidebar-header">
                    <button class="primary" style="width:100%" onclick="addBookmark()">â• åŠ å…¥æ›¸ç±¤</button>
                </div>
                <div class="sidebar-list" id="bookmarkList"></div>
            </div>
        </div>
    </div>

    <div class="floating-nav" id="bottomNav" style="display:none;">
        <button class="zoom-btn" onclick="changeScale(-0.25)">-</button>
        <span id="zoomLevel" style="font-size:0.9em; min-width:40px; text-align:center; color:white;">150%</span>
        <button class="zoom-btn" onclick="changeScale(0.25)">+</button>
        <div style="width:1px; height:15px; background:#666; margin:0 10px;"></div>
        <button id="btnPrev" onclick="prevBatch()" style="border-radius:20px;">â¬…</button>
        <select id="jumpSelect" onchange="jumpToBatch(this.value)" style="width:auto; background:#333; color:white; border:none;"></select>
        <button id="btnNext" onclick="nextBatch()" style="border-radius:20px;" class="primary">â¡</button>
        <select id="batchSizeSelect" onchange="changeBatchSize()" style="width:auto; margin-left:10px; background:#333; color:white; border:none;">
            <option value="10">10 é </option>
            <option value="20">20 é </option>
        </select>
    </div>

    <div class="modal" id="aiModal">
        <div class="modal-card">
            <h3 style="margin:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ¤– AI æç¤ºè©ç”¢ç”Ÿå™¨</h3>
            <p style="font-size:0.9em; color:#666; margin:0;">å‹¾é¸å·¦å´å·²æ¨™è¨»çš„å…§å®¹ï¼Œé¸æ“‡æ¨¡æ¿ï¼Œè‡ªå‹•ç”Ÿæˆ Promptã€‚</p>
            
            <div style="display:flex; gap:10px; margin-bottom:5px;">
                <select id="aiTemplate" onchange="updateAIPromptPreview()">
                    <option value="summary">ğŸ“ æ‘˜è¦ç¸½çµ (Summarize)</option>
                    <option value="explain">ğŸ’¡ ç™½è©±è§£é‡‹ (Explain)</option>
                    <option value="check">âœ… é‚è¼¯æª¢æŸ¥ (Check Logic)</option>
                    <option value="qa">â“ å‡ºè€ƒé¡Œ (Generate Quiz)</option>
                    <option value="custom">ğŸ› ï¸ è‡ªå®šç¾© (Custom)</option>
                </select>
                <button onclick="selectAllForAI()">å…¨é¸</button>
            </div>

            <div id="aiSelectionList" class="ai-list"></div>
            
            <label style="margin-top:10px; font-weight:bold;">ç”Ÿæˆçµæœ (å¯ç›´æ¥ä¿®æ”¹)ï¼š</label>
            <textarea id="aiOutput" class="ai-output"></textarea>
            
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
                <button onclick="document.getElementById('aiModal').style.display='none'">é—œé–‰</button>
                <button class="primary" onclick="copyAIToClipboard()">ğŸ“‹ è¤‡è£½ Prompt</button>
            </div>
        </div>
    </div>

    <div class="modal" id="editorModal">
        <div class="modal-card" id="editorCard">
            <h3 id="modalTitle" class="modal-drag-handle" style="margin:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ–ï¸ ç·¨è¼¯</h3>
            <div id="quotePreview" class="preview-box"></div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>ID</label><input type="text" id="rtmId"></div>
                <div style="flex:2"><label>æ¨™é¡Œ</label><input type="text" id="rtmTitle"></div>
            </div>
            <div style="margin-top:10px;">
                <div style="display:flex; gap:5px;">
                    <input type="text" id="codeName" placeholder="æ¨™ç±¤..." style="flex:1">
                    <input type="color" id="codeColor" value="#ffeb3b" style="height:35px; width:40px; border:none;">
                </div>
                <div id="quickTagArea" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;"></div>
            </div>
            <div id="customFieldsContainer" class="custom-fields-area" style="display:none;"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <div style="flex:1"><label>å„ªå…ˆç´š</label><select id="rtmPriority"><option value="High">ğŸ”´ High</option><option value="Medium">ğŸŸ¡ Medium</option><option value="Low">ğŸŸ¢ Low</option></select></div>
                <div style="flex:1"><label>ç‹€æ…‹</label><select id="rtmStatus"><option value="New">New</option><option value="Pending">Pending</option><option value="Closed">Closed</option></select></div>
            </div>
            <div>
                <label>ç­†è¨˜ (æ”¯æ´ [[ID]] é€£çµ)</label>
                <div class="memo-toolbar">
                    <button class="memo-btn" onclick="memoExec('hilite')">ğŸ–Šï¸</button>
                    <button class="memo-btn" onclick="memoExec('checkbox')">â˜‘ï¸</button>
                    <button class="memo-btn" onclick="triggerImageUpload('codeMemo')">ğŸ“·</button>
                    <button class="memo-btn" onclick="insertLinkPlaceholder()">ğŸ”— [[é€£çµ]]</button>
                    <button class="memo-btn" onclick="memoExec('clear')">ğŸ§¹</button>
                </div>
                <div id="codeMemo" class="rich-memo" contenteditable="true"></div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button onclick="closeModal()">å–æ¶ˆ</button>
                <button class="primary btn-save" onclick="confirmAnnotation()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <div class="modal" id="globalMemoModal">
        <div class="modal-card">
            <h3 style="margin:0; padding-bottom:10px;">ğŸ’¡ å…¨å±€éˆæ„Ÿç­†è¨˜</h3>
            <div class="memo-toolbar"><button class="memo-btn" onclick="globalMemoExec('hilite')">ğŸ–Šï¸</button><button class="memo-btn" onclick="globalMemoExec('checkbox')">â˜‘ï¸</button></div>
            <div id="globalMemoEditor" class="rich-memo" style="flex:1;" contenteditable="true"></div>
            <div style="text-align:right; margin-top:20px;"><button class="primary" onclick="saveGlobalMemo()">å„²å­˜</button></div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-card">
            <h3>âš™ï¸ è¨­å®š</h3>
            <div style="margin-bottom:10px;"><button class="info" onclick="saveAsTemplate()">å­˜ç‚ºé è¨­æ¨£æ¿</button> <button class="warning" onclick="loadFromTemplate()">è¼‰å…¥æ¨£æ¿</button></div>
            <div style="background:#f8f9fa; padding:10px; margin-bottom:10px;"><input type="text" id="newTagName" placeholder="æ¨™ç±¤å..."><button class="primary" onclick="addPreset()">æ–°å¢</button></div>
            <div id="presetList" style="max-height:100px; overflow-y:auto; display:flex; flex-wrap:wrap; gap:5px; color:#333;"></div>
            <div style="margin-top:20px;"><button class="danger" onclick="resetAllData()">âš ï¸ é‡ç½®ç³»çµ±</button> <button onclick="document.getElementById('settingsModal').style.display='none'">é—œé–‰</button></div>
        </div>
    </div>

    <div class="modal" id="previewModal">
        <div class="modal-card"><h3>ğŸ‘€ é è¦½</h3><div class="preview-table-container"><div id="previewContent"></div></div><div style="text-align:right; margin-top:20px;"><button onclick="document.getElementById('previewModal').style.display='none'">é—œé–‰</button></div></div>
    </div>

    <input type="file" id="imageUploadInput" accept="image/*" style="display:none">
    <script id="embedded-data" type="application/json"></script>
    <div class="lightbox" id="imageLightbox" onclick="this.style.display='none'"><img id="lightboxImg" src=""><span>é—œé–‰</span></div>

    <script>
        // =========================================
        // 1. å…¨åŸŸè®Šæ•¸ (Global Variables)
        // =========================================
        let pdfDoc = null;
        let annotations = [];
        let bookmarks = [];
        let BATCH_SIZE = 10;
        let currentBatchIndex = 0;
        let totalBatches = 0;
        let currentSelection = null;
        let editMode = 'text';
        let isReaderMode = false;
        let globalMemo = "";
        let lastUsedSettings = { code: 'é‡é»', color: '#ffeb3b', priority: 'Medium', status: 'New' };
        let customFields = [];
        let currentScale = 1.5;
        let isDirectMode = false;
        let activeMemoId = '';
        let isSpacePressed = false;
        const AUTOSAVE_KEY = 'pdf_ult_v10_full';
        const TEMPLATE_KEY = 'pdf_ult_v10_tpl';
        let tagPresets = [{ name: "åŠŸèƒ½éœ€æ±‚", color: "#ffc107" }, { name: "è³‡å®‰è¦ç¯„", color: "#dc3545" }];

        // =========================================
        // 2. åˆå§‹åŒ–èˆ‡äº‹ä»¶ç›£è½ (Initialization)
        // =========================================
        window.onload = function() {
            // è¼‰å…¥æ¨£æ¿èˆ‡æš«å­˜
            loadFromTemplate(true); 
            checkEmbeddedData(); 
            if(!isReaderMode) checkAutoSave();
            
            // æ¢å¾© UI ç‹€æ…‹
            if(localStorage.getItem('isDarkMode') === 'true') document.body.classList.add('dark-mode');
            if(localStorage.getItem('isSidebarLeft') === 'true') document.getElementById('workspace').classList.add('sidebar-left');
            
            // éµç›¤äº‹ä»¶
            window.addEventListener('keydown', (e) => {
                // ESC é—œé–‰æ‰€æœ‰è¦–çª—
                if(e.key === 'Escape') {
                    document.querySelectorAll('.modal,#searchPanel').forEach(el => el.style.display = 'none');
                }
                // Ctrl+Enter ç¢ºèªæ¨™è¨»
                if(e.key === 'Enter' && (e.ctrlKey || e.metaKey) && document.getElementById('editorModal').style.display === 'flex') {
                    confirmAnnotation();
                }
                // Space éµç›¤å¹³ç§» (æ’é™¤è¼¸å…¥æ¡†)
                if(e.code === 'Space' && !e.repeat && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName) && !document.activeElement.isContentEditable) { 
                    isSpacePressed = true; 
                    document.body.classList.add('grabbing-mode'); 
                    e.preventDefault(); 
                }
            });

            window.addEventListener('keyup', (e) => { 
                if(e.code === 'Space') { 
                    isSpacePressed = false; 
                    document.body.classList.remove('grabbing-mode'); 
                }
            });

            document.getElementById('imageUploadInput').addEventListener('change', handleImageInsert);
            makeDraggable(document.getElementById("editorCard"), document.getElementById("modalTitle"));
        };

        // =========================================
        // 3. AI åŠ©æ‰‹åŠŸèƒ½ (AI Copilot)
        // =========================================
        function openAIModal() {
            const list = document.getElementById('aiSelectionList'); 
            list.innerHTML = '';
            
            annotations.forEach(a => {
                const div = document.createElement('div'); div.className = 'ai-item';
                div.innerHTML = `<input type="checkbox" value="${a.id}" id="ai_chk_${a.id}"> <label for="ai_chk_${a.id}">[${a.rtmId}] ${a.title || a.text.substring(0,20)}</label>`;
                list.appendChild(div);
            });
            
            updateAIPromptPreview();
            document.getElementById('aiModal').style.display = 'flex';
        }

        function selectAllForAI() { 
            document.querySelectorAll('#aiSelectionList input').forEach(c => c.checked = true); 
            updateAIPromptPreview(); 
        }

        function updateAIPromptPreview() {
            const tmpl = document.getElementById('aiTemplate').value;
            const ids = Array.from(document.querySelectorAll('#aiSelectionList input:checked')).map(c => c.value);
            const selAnns = annotations.filter(a => ids.includes(a.id));
            
            let context = selAnns.map(a => 
                `ã€ID: ${a.rtmId} | æ¨™é¡Œ: ${a.title}ã€‘\nå…§å®¹: ${a.text}\nç­†è¨˜: ${a.memo.replace(/<[^>]+>/g,'')}`
            ).join('\n\n----------------\n\n');
            
            if(!context) context = "(è«‹å…ˆå‹¾é¸ä¸Šæ–¹çš„è³‡æ–™)";

            let prompt = "";
            if(tmpl === 'summary') prompt = "è«‹å¹«æˆ‘ç¸½çµä»¥ä¸‹æ¨™è¨»å…§å®¹ï¼Œæ­¸ç´å‡ºé‡é»æ‘˜è¦ï¼š\n\n";
            else if(tmpl === 'explain') prompt = "è«‹ç”¨ç™½è©±æ–‡è§£é‡‹ä»¥ä¸‹é€™æ®µå…§å®¹çš„å«ç¾©ï¼Œä¸¦èˆ‰ä¾‹èªªæ˜ï¼š\n\n";
            else if(tmpl === 'check') prompt = "è«‹æª¢æŸ¥ä»¥ä¸‹å…§å®¹æ˜¯å¦å­˜åœ¨é‚è¼¯çŸ›ç›¾æˆ–ä¸æ˜ç¢ºä¹‹è™•ï¼š\n\n";
            else if(tmpl === 'qa') prompt = "è«‹æ ¹æ“šä»¥ä¸‹å…§å®¹ï¼Œå‡º 3 é¡Œæ¸¬è©¦ç†è§£åº¦çš„é¸æ“‡é¡Œï¼ˆé™„ç­”æ¡ˆï¼‰ï¼š\n\n";
            else prompt = "è«‹æ ¹æ“šä»¥ä¸‹è³‡æ–™å›ç­”å•é¡Œï¼š\n\n";

            document.getElementById('aiOutput').value = prompt + context;
        }

        function copyAIToClipboard() {
            const txt = document.getElementById('aiOutput'); 
            txt.select(); 
            document.execCommand('copy');
            alert("âœ… Prompt å·²è¤‡è£½ï¼è«‹åˆ‡æ›åˆ° ChatGPT/Claude è²¼ä¸Šã€‚");
        }

        // =========================================
        // 4. å´é‚Šæ¬„èˆ‡æœå°‹ (Sidebar & Search)
        // =========================================
        function renderSidebar() {
            const list = document.getElementById('sidebarList'); 
            list.innerHTML = '';
            
            const filterVal = document.getElementById('sidebarFilter').value;
            const searchVal = document.getElementById('sidebarSearchInput').value.toLowerCase().trim();
            document.getElementById('count').innerText = annotations.length;

            let filtered = annotations.filter(a => {
                if(filterVal === 'High' && a.priority !== 'High') return false;
                if(filterVal === 'Pending' && a.status !== 'Pending') return false;
                if(filterVal === 'Image' && a.type !== 'area') return false;
                
                if(searchVal) {
                    const match = (a.title && a.title.toLowerCase().includes(searchVal)) || 
                                  (a.code && a.code.toLowerCase().includes(searchVal)) ||
                                  (a.rtmId && a.rtmId.toLowerCase().includes(searchVal)) ||
                                  (a.text && a.text.toLowerCase().includes(searchVal)) ||
                                  (a.memo && a.memo.toLowerCase().includes(searchVal));
                    if(!match) return false;
                }
                return true;
            });
            
            filtered.sort((a,b) => a.page - b.page);

            filtered.forEach(a => {
                const d = document.createElement('div'); 
                d.className = 'list-item'; 
                d.style.borderLeftColor = a.color;
                
                // Wiki Link æ ¼å¼åŒ–
                const displayMemo = formatMemoLinks(a.memo);
                
                d.innerHTML = `
                    <div style="display:flex;justify-content:space-between;font-size:0.85em;color:#888;">
                        <span>P.${a.page} ${a.type==='area'?'ğŸ–¼ï¸':'ğŸ“'}</span>
                        <span>${a.priority}</span>
                    </div>
                    <div style="font-weight:bold;margin:4px 0;font-size:1em;">${a.title||a.code}</div>
                    <div style="margin-bottom:4px;"><span class="tag-badge" style="background:${a.color}">${a.code}</span></div>
                    <div style="font-size:0.85em;color:#666;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">
                        ${a.rtmId ? `<b>[${a.rtmId}]</b> ` : ''}${a.text}
                    </div>
                    <div class="memo-content" style="margin-top:5px;border-top:1px dashed #eee;padding-top:5px;font-size:0.85em;color:#444;">
                        ${displayMemo}
                    </div>
                    <div class="item-actions">
                        <button class="icon-btn" onclick="event.stopPropagation();jumpAndEdit('${a.id}')">âœï¸</button>
                        <button class="icon-btn" onclick="event.stopPropagation();deleteItem('${a.id}')">ğŸ—‘ï¸</button>
                    </div>`;
                
                d.onclick = () => scrollToAnnotation(a);
                d.querySelectorAll('img').forEach(img => { 
                    img.onclick = (e) => { e.stopPropagation(); showLightbox(img.src); }
                });
                
                list.appendChild(d);
            });
        }

        // =========================================
        // 5. Wiki é€£çµé‚è¼¯ (Wiki Links)
        // =========================================
        function insertLinkPlaceholder() { 
            document.execCommand('insertText', false, '[[IDæˆ–é—œéµå­—]]'); 
        }
        
        function formatMemoLinks(html) {
            if(!html) return "";
            return html.replace(/\[\[(.*?)\]\]/g, (match, ref) => {
                return `<span class="memo-link" onclick="event.stopPropagation(); handleWikiLink('${ref}')">${match}</span>`;
            });
        }

        function handleWikiLink(ref) {
            const target = annotations.find(a => a.rtmId === ref || a.title === ref || a.code === ref);
            
            if(target) {
                scrollToAnnotation(target);
                // è¦–è¦ºå›é¥‹
                setTimeout(() => {
                   const el = document.getElementById('area-'+target.id) || document.querySelector(`.pdf-page[data-page-number="${target.page}"]`);
                   if(el) { 
                       const originalOutline = el.style.outline;
                       el.style.outline = "5px solid cyan"; 
                       setTimeout(() => el.style.outline = originalOutline, 1500); 
                   }
                }, 800);
            } else {
                if(confirm(`æ‰¾ä¸åˆ°å®Œå…¨åŒ¹é… "${ref}" çš„æ¨™è¨»ã€‚æ˜¯å¦é€²è¡Œæœå°‹ï¼Ÿ`)) {
                    document.getElementById('sidebarSearchInput').value = ref;
                    renderSidebar();
                    switchSidebarTab('index');
                }
            }
        }

        // =========================================
        // 6. UI èˆ‡ æ›¸ç±¤ (UI & Bookmarks)
        // =========================================
        function toggleDarkMode(){ 
            document.body.classList.toggle('dark-mode'); 
            localStorage.setItem('isDarkMode', document.body.classList.contains('dark-mode')); 
        }
        function toggleSidebarLayout(){ 
            document.getElementById('workspace').classList.toggle('sidebar-left'); 
            localStorage.setItem('isSidebarLeft', document.getElementById('workspace').classList.contains('sidebar-left')); 
        }
        function toggleDirectMode(){ 
            isDirectMode = !isDirectMode; 
            document.getElementById('directSwitch').classList.toggle('active', isDirectMode); 
        }
        
        function switchSidebarTab(t){ 
            document.getElementById('tabIndex').classList.toggle('active', t==='index'); 
            document.getElementById('tabBookmark').classList.toggle('active', t==='bookmark'); 
            document.getElementById('panelIndex').style.display = t==='index'?'flex':'none'; 
            document.getElementById('panelBookmark').style.display = t==='bookmark'?'flex':'none'; 
            if(t==='bookmark') renderBookmarks(); 
        }
        
        function addBookmark(){ 
            const p = findCenterPage(); 
            const t = prompt("æ›¸ç±¤åç¨±ï¼š", `Page ${p}`); 
            if(t){ 
                bookmarks.push({id:Date.now(), title:t, page:p}); 
                renderBookmarks(); 
                saveToLocal(); 
            } 
        }
        
        function findCenterPage(){ 
            const ps = document.querySelectorAll('.pdf-page'), c = document.getElementById('viewerContainer'), cr = c.getBoundingClientRect(); 
            let bp=1, md=Infinity; 
            ps.forEach(p=>{ 
                const r=p.getBoundingClientRect(), d=Math.abs((r.top+r.height/2)-(cr.top+cr.height/2)); 
                if(d<md){ md=d; bp=parseInt(p.dataset.pageNumber); } 
            }); 
            return bp; 
        }
        
        function renderBookmarks(){ 
            const l=document.getElementById('bookmarkList'); l.innerHTML=''; 
            bookmarks.sort((a,b) => a.page - b.page); 
            bookmarks.forEach(b => { 
                l.innerHTML += `
                    <div class="bookmark-item">
                        <div onclick="jumpToPage(${b.page})">
                            <span style="color:#007bff;font-weight:bold;">P.${b.page}</span> ${b.title}
                        </div>
                        <button class="icon-btn" onclick="deleteBookmark(${b.id})">ğŸ—‘ï¸</button>
                    </div>`; 
            }); 
        }
        
        function deleteBookmark(id){ 
            if(confirm('åˆªé™¤æ›¸ç±¤?')){ 
                bookmarks = bookmarks.filter(b => b.id !== id); 
                renderBookmarks(); 
                saveToLocal(); 
            } 
        }

        // =========================================
        // 7. PDF æ ¸å¿ƒ (Core PDF)
        // =========================================
        async function handlePdfUpload(i){ 
            const f=i.files[0]; if(!f) return; 
            showLoader("è§£æä¸­..."); 
            try { 
                pdfDoc = await pdfjsLib.getDocument(await f.arrayBuffer()).promise; 
                calculateBatches(); 
                document.getElementById('placeholder').style.display='none'; 
                document.getElementById('bottomNav').style.display='flex'; 
                await renderCurrentBatch(); 
            } catch(e) { 
                alert("è®€å–å¤±æ•—"); console.error(e); 
            } finally { 
                hideLoader(); i.value=''; 
            } 
        }
        
        function calculateBatches(){ 
            totalBatches = Math.ceil(pdfDoc.numPages / BATCH_SIZE); 
            const s = document.getElementById('jumpSelect'); s.innerHTML = ''; 
            for(let i=0; i<totalBatches; i++) s.add(new Option(`ç¬¬ ${i*BATCH_SIZE+1}-${Math.min((i+1)*BATCH_SIZE, pdfDoc.numPages)} é `, i)); 
            updateNav(); 
        }
        
        async function renderCurrentBatch(){ 
            if(!pdfDoc) return; 
            showLoader("è¼‰å…¥ä¸­..."); 
            document.querySelectorAll('.pdf-page').forEach(p => p.remove()); 
            document.getElementById('jumpSelect').value = currentBatchIndex; 
            updateNav(); 
            for(let i = (currentBatchIndex * BATCH_SIZE) + 1; i <= Math.min((currentBatchIndex + 1) * BATCH_SIZE, pdfDoc.numPages); i++) await renderPage(i); 
            hideLoader(); 
        }
        
        async function renderPage(n){ 
            const p = await pdfDoc.getPage(n), v = p.getViewport({scale: currentScale}); 
            const d = document.createElement('div'); d.className = 'pdf-page'; 
            d.style.width = v.width+'px'; d.style.height = v.height+'px'; d.dataset.pageNumber = n; 
            d.style.cursor = editMode==='text'?'text':'crosshair'; 
            
            const c = document.createElement('canvas'); c.width = v.width; c.height = v.height; 
            const t = document.createElement('div'); t.className = 'textLayer'; t.style.width = v.width+'px'; t.style.height = v.height+'px'; 
            d.append(c, t); 
            document.getElementById('viewerContainer').appendChild(d); 
            
            await p.render({canvasContext: c.getContext('2d'), viewport: v}).promise; 
            pdfjsLib.renderTextLayer({textContent: await p.getTextContent(), container: t, viewport: v, textDivs: []}); 
            
            if(!isReaderMode) enableBoxSelection(d, n); 
            restoreHighlights(n, d); 
        }
        
        // =========================================
        // 8. ç•«ç·šèˆ‡é¸å– (Selection & Drawing)
        // =========================================
        function enableBoxSelection(div, n){
            let isD = false, sx, sy, m = null;
            
            div.onmousedown = e => { 
                if(isSpacePressed || e.target.closest('.highlight-text, .highlight-area')) return; 
                isD = true; 
                const r = div.getBoundingClientRect(); sx = e.clientX - r.left; sy = e.clientY - r.top; 
                m = document.createElement('div'); m.className = 'selection-marquee'; m.style.left = sx+'px'; m.style.top = sy+'px'; div.appendChild(m); 
            };
            
            window.onmousemove = e => { 
                if(!isD) return; 
                const r = div.getBoundingClientRect(), cx = e.clientX - r.left, cy = e.clientY - r.top; 
                m.style.width = Math.abs(cx - sx)+'px'; m.style.height = Math.abs(cy - sy)+'px'; 
                m.style.left = Math.min(cx, sx)+'px'; m.style.top = Math.min(cy, sy)+'px'; 
            };
            
            window.onmouseup = () => { 
                if(!isD) return; 
                isD = false; 
                if(m) { 
                    const w = parseFloat(m.style.width), h = parseFloat(m.style.height), l = parseFloat(m.style.left), t = parseFloat(m.style.top); 
                    m.remove(); 
                    if(w > 5 && h > 5) processSelection(n, {left:l, top:t, width:w, height:h}, div); 
                } 
            };
        }

        function processSelection(p, r, div){
            const nr = {left: r.left/currentScale, top: r.top/currentScale, width: r.width/currentScale, height: r.height/currentScale};
            
            if(editMode === 'text'){
                let txt = "", s = div.querySelectorAll('.textLayer span'), hs = []; 
                s.forEach(el => { 
                    if(!(el.offsetLeft+el.offsetWidth < r.left || el.offsetLeft > r.left+r.width || el.offsetTop+el.offsetHeight < r.top || el.offsetTop > r.top+r.height)) 
                        hs.push(el); 
                });
                hs.sort((a,b) => Math.abs(a.offsetTop - b.offsetTop) < 10 ? a.offsetLeft - b.offsetLeft : a.offsetTop - b.offsetTop)
                  .forEach(e => txt += e.innerText+" ");
                
                if(txt.trim()) { 
                    currentSelection = {id: null, type: 'text', page: p, text: txt.trim(), rect: nr}; 
                    if(isDirectMode) quickSave(); else openModal(); 
                }
            } else {
                const c = document.createElement('canvas'); c.width = r.width; c.height = r.height; 
                c.getContext('2d').drawImage(div.querySelector('canvas'), r.left, r.top, r.width, r.height, 0, 0, r.width, r.height);
                currentSelection = {id: null, type: 'area', page: p, text: '[åœ–ç‰‡]', rect: nr, imageData: c.toDataURL()}; 
                if(isDirectMode) quickSave(); else openModal();
            }
        }

        function genId(){ 
            let m = 0; 
            annotations.forEach(a => { const v = (a.rtmId || "").match(/^REQ-(\d+)$/); if(v) m = Math.max(m, parseInt(v[1])); }); 
            return `REQ-${String(m + 1).padStart(4, '0')}`; 
        }

        function quickSave(){ 
            const newId = Date.now().toString();
            annotations.push({
                id: newId, 
                ...currentSelection, 
                rtmId: genId(), 
                title: currentSelection.text.substring(0, 10), 
                code: lastUsedSettings.code, 
                color: lastUsedSettings.color, 
                priority: 'Medium', status: 'New', memo: '', 
                timestamp: new Date().toISOString()
            }); 
            renderSidebar(); saveToLocal(); renderCurrentBatch(); 
        }

        function openModal(ex = null){ 
            const m = document.getElementById('editorModal'), c = document.getElementById('editorCard'); c.style.top = "50px"; 
            renderCustomFields(ex ? ex.customData : {}); renderQuickTags();
            document.getElementById('rtmId').value = ex ? ex.rtmId : genId(); 
            document.getElementById('rtmTitle').value = ex ? ex.title || ex.code : ''; 
            document.getElementById('codeName').value = ex ? ex.code : lastUsedSettings.code; 
            document.getElementById('codeColor').value = ex ? ex.color : lastUsedSettings.color;
            document.getElementById('codeMemo').innerHTML = ex ? ex.memo : ''; 
            currentSelection.id = ex ? ex.id : null;
            document.getElementById('quotePreview').innerHTML = currentSelection.type === 'area' ? `<img src="${currentSelection.imageData}">` : currentSelection.text;
            m.style.display = 'flex'; 
        }

        function confirmAnnotation(){
            const cd = {}; document.querySelectorAll('#customFieldsContainer input').forEach(i => cd[i.dataset.key] = i.value);
            const nd = {
                type: currentSelection.type, 
                page: currentSelection.page, 
                text: currentSelection.type === 'text' ? document.getElementById('quotePreview').innerText : currentSelection.text, 
                rect: currentSelection.rect, 
                imageData: currentSelection.imageData, 
                rtmId: document.getElementById('rtmId').value, 
                title: document.getElementById('rtmTitle').value, 
                code: document.getElementById('codeName').value, 
                color: document.getElementById('codeColor').value, 
                priority: document.getElementById('rtmPriority').value, 
                status: document.getElementById('rtmStatus').value, 
                memo: document.getElementById('codeMemo').innerHTML, 
                customData: cd, 
                timestamp: new Date().toISOString()
            };
            lastUsedSettings = {code: nd.code, color: nd.color};
            
            if(currentSelection.id){ 
                const i = annotations.findIndex(a => a.id === currentSelection.id); 
                annotations[i] = {...annotations[i], ...nd}; 
            } else {
                annotations.push({id: Date.now().toString(), ...nd});
            }
            renderSidebar(); saveToLocal(); closeModal(); renderCurrentBatch();
        }

        function restoreHighlights(p, div){
            annotations.filter(a => a.page === p).forEach(a => {
                if(a.type === 'text') {
                    div.querySelectorAll('.textLayer span').forEach(s => { 
                        if(s.innerText.length > 1 && a.text.includes(s.innerText)){ 
                            s.classList.add('highlight-text'); s.style.borderBottomColor = a.color; 
                            s.onclick = (e) => { e.stopPropagation(); jumpAndEdit(a.id); }
                        } 
                    });
                } else { 
                    const d = document.createElement('div'); d.className = 'highlight-area'; d.id = 'area-' + a.id; 
                    d.style.left = (a.rect.left * currentScale) + 'px'; d.style.top = (a.rect.top * currentScale) + 'px'; 
                    d.style.width = (a.rect.width * currentScale) + 'px'; d.style.height = (a.rect.height * currentScale) + 'px'; 
                    d.style.borderColor = a.color; 
                    d.onclick = (e) => { e.stopPropagation(); jumpAndEdit(a.id); }; 
                    div.appendChild(d); 
                }
            });
        }

        function scrollToAnnotation(a){ 
            const b = Math.floor((a.page - 1) / BATCH_SIZE); 
            if(b !== currentBatchIndex){ 
                currentBatchIndex = b; 
                renderCurrentBatch().then(() => setTimeout(() => doScroll(a), 500)); 
            } else doScroll(a); 
        }

        function doScroll(a){ 
            const el = document.querySelector(`.pdf-page[data-page-number="${a.page}"]`); 
            if(el){ 
                el.scrollIntoView({behavior: 'smooth', block: 'center'}); 
                if(a.type !== 'area') el.classList.add('highlight-flash'); 
            } 
        }

        // =========================================
        // 9. è¼”åŠ©å·¥å…· (Utilities)
        // =========================================
        function showLightbox(s){ document.getElementById('lightboxImg').src = s; document.getElementById('imageLightbox').style.display = 'flex'; }
        
        function makeDraggable(e, h){
            let p1=0, p2=0, p3=0, p4=0;
            h.onmousedown = ev => { 
                ev.preventDefault(); p3 = ev.clientX; p4 = ev.clientY; 
                document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; }; 
                document.onmousemove = v => { 
                    v.preventDefault(); p1 = p3 - v.clientX; p2 = p4 - v.clientY; p3 = v.clientX; p4 = v.clientY; 
                    e.style.top = (e.offsetTop - p2) + "px"; e.style.left = (e.offsetLeft - p1) + "px"; 
                } 
            };
        }

        function saveToLocal(){ if(!isReaderMode) localStorage.setItem(AUTOSAVE_KEY, JSON.stringify({annotations, bookmarks, globalMemo})); }
        
        function checkAutoSave(){
            const s = localStorage.getItem(AUTOSAVE_KEY);
            if(s){
                try {
                    const d = JSON.parse(s);
                    if((d.annotations.length || d.bookmarks.length) && confirm("å¾©åŸæœªå­˜æª”çš„æ¨™è¨»ç´€éŒ„?")){
                        annotations = d.annotations; bookmarks = d.bookmarks || []; globalMemo = d.globalMemo || ""; 
                        renderSidebar(); renderBookmarks();
                    }
                } catch(e){}
            }
        }

        function saveProject(){ 
            download(JSON.stringify({annotations, bookmarks, presets: tagPresets, customFields, globalMemo, lastBatch: currentBatchIndex}), `Proj_${new Date().toISOString().slice(0,10)}.json`, 'application/json'); 
        }

        function handleProjectLoad(i){
            const r = new FileReader();
            r.onload = e => {
                const d = JSON.parse(e.target.result);
                annotations = d.annotations || []; bookmarks = d.bookmarks || []; tagPresets = d.presets || tagPresets; globalMemo = d.globalMemo || ""; currentBatchIndex = d.lastBatch || 0;
                renderSidebar(); renderBookmarks(); saveToLocal(); renderCurrentBatch();
            };
            r.readAsText(i.files[0]); i.value = '';
        }

        function exportReaderHtml(){ 
            let h = document.documentElement.outerHTML; 
            const d = JSON.stringify({annotations, bookmarks, presets: tagPresets, customFields, globalMemo}); 
            download(h.replace(/<script id="embedded-data".*?<\/script>/, `<script id="embedded-data" type="application/json">${d}<\/script>`), 'Reader.html', 'text/html'); 
        }

        function download(c, n, t){ const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c], {type: t})); a.download = n; a.click(); }
        function showLoader(t){ document.getElementById('loader').style.display = 'flex'; } 
        function hideLoader(){ document.getElementById('loader').style.display = 'none'; }
        
        function jumpAndEdit(id){ const a = annotations.find(x => x.id === id); if(a){ currentSelection = {...a}; scrollToAnnotation(a); setTimeout(() => openModal(a), 600); } }
        function deleteItem(id){ if(confirm('åˆªé™¤?')){ annotations = annotations.filter(x => x.id !== id); renderSidebar(); saveToLocal(); renderCurrentBatch(); } }
        
        function memoExec(c){ document.execCommand(c === 'hilite' ? 'hiliteColor' : (c === 'checkbox' ? 'insertHTML' : 'removeFormat'), false, c === 'hilite' ? '#ffeb3b' : (c === 'checkbox' ? '&#x2610; ' : null)); }
        function globalMemoExec(c){ document.getElementById('globalMemoEditor').focus(); memoExec(c); }
        function openGlobalMemo(){ document.getElementById('globalMemoEditor').innerHTML = globalMemo; document.getElementById('globalMemoModal').style.display = 'flex'; }
        function saveGlobalMemo(){ globalMemo = document.getElementById('globalMemoEditor').innerHTML; saveToLocal(); document.getElementById('globalMemoModal').style.display = 'none'; }
        
        // =========================================
        // 10. è¨­å®šèˆ‡å…¨åŸŸæœå°‹ (Settings & Global Search)
        // =========================================
        function openSettings(){
            const l = document.getElementById('presetList'); l.innerHTML = '';
            tagPresets.forEach((t, i) => l.innerHTML += `<div style="border:1px solid ${t.color};padding:2px 5px;cursor:pointer;" onclick="tagPresets.splice(${i}, 1); openSettings()">â— ${t.name} Ã—</div>`);
            document.getElementById('settingsModal').style.display = 'flex';
        }
        function addPreset(){ tagPresets.push({name: document.getElementById('newTagName').value, color: '#17a2b8'}); openSettings(); }
        function renderQuickTags(){ const a = document.getElementById('quickTagArea'); a.innerHTML = ''; tagPresets.forEach(t => a.innerHTML += `<div class="mode-btn" style="border:1px solid ${t.color}" onclick="document.getElementById('codeName').value='${t.name}';document.getElementById('codeColor').value='${t.color}'">${t.name}</div>`); }
        function loadFromTemplate(s){ const t = localStorage.getItem(TEMPLATE_KEY); if(t){ const d = JSON.parse(t); tagPresets = d.presets; customFields = d.customFields; if(!s) openSettings(); } else if(!s) alert("ç„¡æ¨£æ¿"); }
        function saveAsTemplate(){ localStorage.setItem(TEMPLATE_KEY, JSON.stringify({presets: tagPresets, customFields})); alert("å·²å„²å­˜"); }
        function resetAllData(){ localStorage.clear(); location.reload(); }
        
        function updateNav(){ document.getElementById('btnPrev').disabled = currentBatchIndex === 0; document.getElementById('btnNext').disabled = currentBatchIndex >= totalBatches - 1; }
        function nextBatch(){ if(currentBatchIndex < totalBatches - 1){ currentBatchIndex++; renderCurrentBatch(); } }
        function prevBatch(){ if(currentBatchIndex > 0){ currentBatchIndex--; renderCurrentBatch(); } }
        function jumpToBatch(v){ currentBatchIndex = parseInt(v); renderCurrentBatch(); }
        function changeBatchSize(){ BATCH_SIZE = parseInt(document.getElementById('batchSizeSelect').value); currentBatchIndex = 0; calculateBatches(); renderCurrentBatch(); }
        function changeScale(d){ currentScale += d; renderCurrentBatch(); document.getElementById('zoomLevel').innerText = Math.round(currentScale * 100) + '%'; }
        function closeModal(){ document.getElementById('editorModal').style.display = 'none'; }
        function checkEmbeddedData(){ const s = document.getElementById('embedded-data'); if(s && s.textContent.trim()){ const d = JSON.parse(s.textContent); annotations = d.annotations; bookmarks = d.bookmarks; isReaderMode = true; document.body.classList.add('mode-read'); renderSidebar(); renderBookmarks(); } }
        function renderCustomFields(d){ const c = document.getElementById('customFieldsContainer'); c.innerHTML = ''; customFields.forEach(f => { c.innerHTML += `<div><label>${f.label}</label><input data-key="${f.key}" value="${d[f.key] || ''}"></div>`; }); c.style.display = customFields.length ? 'block' : 'none'; }
        
        async function exportExcel(){ 
            if(!annotations.length) return alert("ç„¡è³‡æ–™"); 
            const w = new ExcelJS.Workbook(), s = w.addWorksheet('RTM'); 
            s.columns = [{header: 'ID', key: 'id'}, {header: 'Title', key: 't'}, {header: 'Text', key: 'txt'}, {header: 'Memo', key: 'm'}]; 
            annotations.forEach(a => s.addRow({id: a.rtmId, t: a.title, txt: a.text, m: a.memo.replace(/<[^>]+>/g, '')})); 
            download(await w.xlsx.writeBuffer(), 'RTM.xlsx', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'); 
        }
        
        async function performGlobalSearch(){ 
            const q = document.getElementById('globalSearchInput').value; if(!q) return; 
            const l = document.getElementById('searchResultsList'); l.innerHTML = 'æœå°‹ä¸­...'; document.getElementById('searchPanel').style.display = 'flex'; 
            let r = []; 
            for(let i = 1; i <= pdfDoc.numPages; i++){ 
                const t = (await(await pdfDoc.getPage(i)).getTextContent()).items.map(s => s.str).join(''); 
                if(t.includes(q)) r.push({p: i, t: t.substring(t.indexOf(q) - 10, t.indexOf(q) + 20)}); 
            } 
            l.innerHTML = r.length ? '' : 'ç„¡çµæœ'; 
            r.forEach(x => l.innerHTML += `<div class="search-item" onclick="jumpToPage(${x.p})">P.${x.p} ...${x.t}...</div>`); 
        }
        function jumpToPage(p){ currentBatchIndex = Math.floor((p - 1) / BATCH_SIZE); renderCurrentBatch().then(() => setTimeout(() => scrollToP(p), 500)); }
        function scrollToP(p){ const el = document.querySelector(`.pdf-page[data-page-number="${p}"]`); if(el) el.scrollIntoView({behavior: 'smooth', block: 'center'}); }
        function closeSearch(){ document.getElementById('searchPanel').style.display = 'none'; }

        function handleImageInsert(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const imgTag = `<img src="${event.target.result}" style="max-width:100%; display:block; margin:5px 0;">`;
                const target = document.getElementById(activeMemoId); target.focus(); document.execCommand('insertHTML', false, imgTag);
            };
            reader.readAsDataURL(file); e.target.value = '';
        }
        function triggerImageUpload(targetId) { activeMemoId = targetId; document.getElementById('imageUploadInput').click(); }
        function setMode(m) { editMode = m; document.getElementById('modeText').classList.toggle('active', m === 'text'); document.getElementById('modeArea').classList.toggle('active', m === 'area'); document.querySelectorAll('.pdf-page').forEach(p => p.style.cursor = m === 'text' ? 'text' : 'crosshair'); }
    </script>
</body>
</html>
