<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF/Htmlé–±è®€åœ°åœ–</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // è¨­å®š PDF Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* --- 1. æ ¸å¿ƒä½ˆå±€ --- */
        body { margin: 0; padding: 0; background: #525659; font-family: "Microsoft JhengHei", -apple-system, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* ç·¨è¼¯æ¨¡å¼å·¥å…·åˆ— */
        .toolbar { 
            background: #2c2c2c; color: white; padding: 10px 20px; display: flex; align-items: center; gap: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 100; flex-shrink: 0; flex-wrap: wrap; 
        }
        
        /* é–±è®€æ¨¡å¼å·¥å…·åˆ— (é è¨­éš±è—) */
        .reader-toolbar { 
            background: #202b38; color: white; padding: 15px 20px; display: none; align-items: center; justify-content: space-between; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 101; flex-shrink: 0; 
        }

        h1 { margin: 0; font-size: 1.2em; color: #fff; margin-right: 15px; display:flex; align-items:center; gap:8px;}
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: #444; color: white; transition: 0.2s; white-space: nowrap; font-size: 0.9em; }
        button:hover { background: #666; transform: translateY(-1px); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        button.primary { background: #28a745; }
        button.export { background: #17a2b8; }
        button.danger { background: #dc3545; }

        /* æœå°‹æ¡† */
        .search-box { display: flex; align-items: center; background: white; border-radius: 4px; overflow: hidden; margin-left: auto; }
        .search-input { border: none; padding: 6px 10px; outline: none; font-size: 0.9em; width: 160px; color:#333; }
        .search-btn { background: #ffc107; color: #333; border-radius: 0; padding: 6px 10px; }
        .search-btn:hover { background: #e0a800; }

        /* --- 2. å·¥ä½œå€ --- */
        .workspace { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* PDF å®¹å™¨ */
        #viewerContainer { 
            flex: 1; overflow-y: auto; overflow-x: auto; position: relative; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px; padding-bottom: 80px; 
            background: #525659;
        }
        
        /* å–®é  PDF æ¨£å¼ */
        .pdf-page { position: relative; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); background: white; }
        /* æ–‡å­—å±¤ (é€æ˜ä½†å¯é¸å–) */
        .textLayer { opacity: 0.2; mix-blend-mode: multiply; }
        
        /* æ¨™è¨»é«˜äº® */
        .highlight-span { background-color: rgba(255, 235, 59, 0.4); cursor: pointer; border-bottom: 2px solid transparent; }
        .highlight-span:hover { background-color: rgba(255, 235, 59, 0.6); }

        /* --- 3. å´é‚Šæ¬„ --- */
        .sidebar { 
            width: 320px; background: #f8f9fa; border-left: 1px solid #ccc; 
            display: flex; flex-direction: column; box-shadow: -2px 0 5px rgba(0,0,0,0.1); z-index: 90; 
        }
        .sidebar-header { padding: 12px 15px; background: white; border-bottom: 1px solid #ddd; display:flex; justify-content:space-between; align-items:center; }
        .sidebar-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .list-item { 
            background: white; padding: 10px; margin-bottom: 8px; border-radius: 6px; 
            border: 1px solid #ddd; cursor: pointer; border-left: 4px solid #ccc; transition:0.2s;
        }
        .list-item:hover { transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .rtm-tag { font-size:0.75em; background:#eee; padding:2px 6px; border-radius:4px; color:#555; margin-right:5px; font-weight:bold; }
        .priority-dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:5px; }

        /* --- 4. æµ®å‹•å…ƒä»¶ --- */
        /* åˆ†æ‰¹æ§åˆ¶å™¨ */
        .pagination-bar { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.85); padding: 8px 20px; border-radius: 30px; 
            display: flex; gap: 15px; align-items: center; color: white; 
            backdrop-filter: blur(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1000; 
        }

        /* æœå°‹é¢æ¿ */
        #searchPanel { 
            position: absolute; top: 60px; right: 340px; width: 320px; max-height: 500px; 
            background: white; border: 1px solid #ccc; border-radius: 8px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; flex-direction: column; z-index: 2000; 
        }
        .search-header { padding: 10px; background: #f1f3f5; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; font-weight: bold; color:#333; }
        .search-results { overflow-y: auto; padding: 5px; flex:1; }
        .search-item { padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 0.9em; display:flex; gap:10px; align-items:center; justify-content:space-between; }
        .search-item:hover { background: #f8f9fa; }
        .search-tag { background: #e9ecef; color: #333; border: 1px solid #ced4da; font-size: 0.8em; padding: 4px 10px; border-radius: 15px; cursor:pointer; }
        .search-tag:hover { background: #007bff; color: white; border-color: #007bff; }

        /* Modal */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:3000; backdrop-filter: blur(2px); }
        .modal-card { background:white; width:500px; padding:25px; border-radius:12px; display:flex; flex-direction:column; gap:12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-label { font-size:0.85em; color:#666; font-weight:bold; display:block; margin-bottom:4px; }
        .form-row { display:flex; gap:15px; margin-bottom:5px; }
        .form-group { flex:1; }
        input, select, textarea { width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; font-size:0.95em; }
        textarea { resize: vertical; min-height:80px; }

        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 4000; }
        .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom:15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ¨¡å¼åˆ‡æ› */
        body.mode-read .toolbar { display: none; }
        body.mode-read .reader-toolbar { display: flex; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><h3 id="loaderText">ç³»çµ±è™•ç†ä¸­...</h3></div>

    <div class="toolbar" id="editToolbar">
        <h1>ğŸ—ºï¸ PDF/Htmlé–±è®€åœ°åœ–</h1>
        
        <button onclick="document.getElementById('pdfInput').click()">ğŸ“‚ åŒ¯å…¥ PDF</button>
        <input type="file" id="pdfInput" accept="application/pdf" style="display:none" onchange="handlePdfUpload(this)">
        
        <button onclick="document.getElementById('projectInput').click()">ğŸ“¥ è¼‰å…¥å°ˆæ¡ˆ</button>
        <input type="file" id="projectInput" accept=".json" style="display:none" onchange="handleProjectLoad(this)">
        
        <div style="width:1px; height:20px; background:#555; margin:0 5px;"></div>
        
        <button class="primary" onclick="saveProject()">ğŸ’¾ å­˜æª” (JSON)</button>
        <button class="export" onclick="exportReaderHtml()">ğŸ“¦ åŒ¯å‡ºé–±è®€ç‰ˆ HTML</button>
        <button class="danger" onclick="exportExcel()">ğŸ“Š åŒ¯å‡º RTM å ±è¡¨</button>

        <div class="search-box">
            <input type="text" id="globalSearchInput" class="search-input" placeholder="å…¨åŸŸé—œéµå­—..." onkeydown="if(event.key==='Enter') performGlobalSearch()">
            <button class="search-btn" onclick="performGlobalSearch()">ğŸ”</button>
        </div>
    </div>

    <div class="reader-toolbar" id="readToolbar">
        <div style="display:flex; align-items:center; gap:15px;">
            <h1 style="color:#28a745;">ğŸ“– PDF/Html æˆæœé–±è®€å™¨</h1>
            <span style="font-size:0.9em; color:#bbb;" id="readerFileName">å°šæœªè¼‰å…¥æ–‡ä»¶...</span>
        </div>
        <div>
            <button class="primary" onclick="document.getElementById('readerPdfInput').click()">ğŸ“‚ è«‹å…ˆé–‹å•ŸåŸå§‹ PDF æª”</button>
            <input type="file" id="readerPdfInput" accept="application/pdf" style="display:none" onchange="handlePdfUpload(this)">
        </div>
    </div>

    <div class="workspace">
        <div id="viewerContainer">
            <div style="margin-top:100px; color:#aaa; text-align:center;" id="placeholder">
                <h3>æ­¡è¿ä½¿ç”¨é–±è®€åœ°åœ–</h3>
                <p>è«‹å¾å·¦ä¸Šè§’åŒ¯å…¥ PDF æ–‡ä»¶é–‹å§‹åˆ†æã€‚<br>æ”¯æ´åˆ†æ‰¹è¼‰å…¥ï¼Œå¤§å‹æ–‡ä»¶ä¹Ÿä¸å¡é “ã€‚</p>
            </div>
            
            <div class="pagination-bar" id="paginationBar" style="display:none;">
                <button onclick="prevBatch()">â¬… ä¸Šä¸€æ‰¹</button>
                <span style="font-family:monospace; margin:0 15px; font-size:1.1em;" id="batchInfo">Page 1 - 10</span>
                <button onclick="nextBatch()">ä¸‹ä¸€æ‰¹ â¡</button>
                <select id="batchSizeSelect" onchange="changeBatchSize()" style="margin-left:10px; width:auto; padding:4px; font-size:0.8em; color:#333;">
                    <option value="5">5 é /æ‰¹</option>
                    <option value="10" selected>10 é /æ‰¹</option>
                    <option value="20">20 é /æ‰¹</option>
                    <option value="50">50 é  (éœ€é«˜æ•ˆèƒ½)</option>
                </select>
            </div>

            <div id="searchPanel">
                <div class="search-header">
                    <span>âš¡ é€ŸæŸ¥é€Ÿæ¨™ (Quick Mark)</span>
                    <span style="cursor:pointer; font-size:1.2em;" onclick="closeSearch()">Ã—</span>
                </div>
                <div style="padding:10px; background:#f8f9fa; border-bottom:1px solid #eee; display:flex; gap:5px; flex-wrap:wrap;">
                    <button class="search-tag" onclick="searchKeyword('äº¤ä»˜')">äº¤ä»˜</button>
                    <button class="search-tag" onclick="searchKeyword('é©—æ”¶')">é©—æ”¶</button>
                    <button class="search-tag" onclick="searchKeyword('ç½°å‰‡')">ç½°å‰‡</button>
                    <button class="search-tag" onclick="searchKeyword('è³‡å®‰')">è³‡å®‰</button>
                    <button class="search-tag" onclick="searchKeyword('ä¿å›º')">ä¿å›º</button>
                </div>
                <div class="search-results" id="searchResultsList"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <span style="font-weight:bold;">éœ€æ±‚ç´¢å¼• (<span id="count">0</span>)</span>
                <button style="font-size:0.7em; padding:2px 8px; background:#6c757d;" onclick="clearAutoSave()">â™»ï¸ æ¸…é™¤å¿«å–</button>
            </div>
            <div class="sidebar-list" id="sidebarList"></div>
        </div>
    </div>

    <div class="modal" id="editorModal">
        <div class="modal-card">
            <h3 id="modalTitle" style="margin:0; padding-bottom:10px; border-bottom:1px solid #eee;">ğŸ–ï¸ ç·¨è¼¯éœ€æ±‚</h3>
            
            <div class="form-row">
                <div class="form-group" style="flex:1;">
                    <label class="modal-label">RTM ID (ç·¨è™Ÿ)</label>
                    <input type="text" id="rtmId" placeholder="ä¾‹: REQ-001">
                </div>
                <div class="form-group" style="flex:2;">
                    <label class="modal-label">åˆ†é¡æ¨™ç±¤ (Tag)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="codeName" placeholder="ä¾‹: åŠŸèƒ½éœ€æ±‚" style="flex:1;">
                        <input type="color" id="codeColor" value="#ffeb3b" style="width:40px; padding:0; height:36px; border:none; background:none;">
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="modal-label">å„ªå…ˆç´š (Priority)</label>
                    <select id="rtmPriority">
                        <option value="High">ğŸ”´ High (é«˜)</option>
                        <option value="Medium" selected>ğŸŸ¡ Medium (ä¸­)</option>
                        <option value="Low">ğŸŸ¢ Low (ä½)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="modal-label">ç‹€æ…‹ (Status)</label>
                    <select id="rtmStatus">
                        <option value="New">New (æ–°å¢)</option>
                        <option value="Pending">Pending (å¾…è­°)</option>
                        <option value="Closed">Closed (å·²çµæ¡ˆ)</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="modal-label">åŸæ–‡æ‘˜è¦</label>
                <div id="quoteText" style="font-size:0.85em; color:#555; background:#f5f5f5; padding:8px; border-radius:4px; max-height:60px; overflow-y:auto; margin-bottom:10px; font-style:italic;"></div>
                
                <label class="modal-label">åˆ†æç­†è¨˜ / é©—æ”¶æ¨™æº–</label>
                <textarea id="codeMemo" placeholder="è¼¸å…¥åˆ†æèªªæ˜..."></textarea>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px; padding-top:15px; border-top:1px solid #eee;">
                <button class="danger btn-delete" onclick="deleteAnnotation()">åˆªé™¤</button>
                <button style="background:#6c757d;" onclick="closeModal()">é—œé–‰</button>
                <button class="primary btn-save" onclick="confirmAnnotation()">ç¢ºå®šå„²å­˜</button>
            </div>
        </div>
    </div>

    <script id="embedded-data" type="application/json"></script>

    <script>
        // --- 1. å…¨åŸŸè®Šæ•¸è¨­å®š ---
        let pdfDoc = null; 
        let annotations = []; 
        let currentSelection = null;
        let BATCH_SIZE = 10; 
        let currentBatchIndex = 0; 
        let totalBatches = 0;
        let isReaderMode = false;
        const AUTOSAVE_KEY = 'pdf_map_autosave_v1';

        // --- 2. åˆå§‹åŒ– ---
        window.onload = function() {
            // æª¢æŸ¥æ˜¯å¦ç‚ºé–±è®€ç‰ˆ (æœ‰ç„¡å…§åµŒæ•¸æ“š)
            checkEmbeddedData();
            // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰æœªå­˜æª”çš„å¿«å–
            if(!isReaderMode) checkAutoSave();
        };

        function checkEmbeddedData() {
            const script = document.getElementById('embedded-data');
            if (script && script.textContent.trim()) {
                try {
                    const data = JSON.parse(script.textContent);
                    annotations = data.annotations || [];
                    isReaderMode = true; 
                    document.body.classList.add('mode-read');
                    renderSidebar();
                    alert("æ­¡è¿ä½¿ç”¨é–±è®€åœ°åœ–ï¼\né€™æ˜¯ä¸€å€‹å”¯è®€ç‰ˆæœ¬ï¼Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•è¼‰å…¥å°æ‡‰çš„ PDF æª”ã€‚");
                } catch(e) { console.error("Embedded data error", e); }
            }
        }

        // --- 3. è‡ªå‹•å­˜æª”ç³»çµ± ---
        function saveToLocal() {
            if(isReaderMode) return;
            const data = { annotations: annotations, timestamp: Date.now() };
            localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
        }

        function checkAutoSave() {
            const saved = localStorage.getItem(AUTOSAVE_KEY);
            if(saved) {
                try {
                    const data = JSON.parse(saved);
                    // å¦‚æœæœ‰è³‡æ–™ä¸”æ™‚é–“åœ¨ 24 å°æ™‚å…§
                    if(data.annotations.length > 0 && (Date.now() - data.timestamp < 86400000)) {
                        if(confirm(`ç™¼ç¾æœªå„²å­˜çš„è‰ç¨¿ (${new Date(data.timestamp).toLocaleString()})ï¼Œå…± ${data.annotations.length} ç­†æ¨™è¨»ï¼Œæ˜¯å¦é‚„åŸï¼Ÿ`)) {
                            annotations = data.annotations;
                            renderSidebar();
                            alert("è‰ç¨¿å·²é‚„åŸï¼Œè«‹è¨˜å¾—åŒ¯å…¥ PDFã€‚");
                        }
                    }
                } catch(e) {}
            }
        }

        function clearAutoSave() {
            if(confirm("ç¢ºå®šæ¸…é™¤ç€è¦½å™¨å¿«å–ï¼Ÿé€™ä¸æœƒåˆªé™¤å·²å­˜æª”çš„ JSONã€‚")) {
                localStorage.removeItem(AUTOSAVE_KEY);
                alert("å¿«å–å·²æ¸…é™¤ã€‚");
            }
        }

        // --- 4. PDF è¼‰å…¥èˆ‡åˆ†æ‰¹æ ¸å¿ƒ ---
        async function handlePdfUpload(input) {
            const file = input.files[0];
            if(!file) return;
            
            showLoader("æ­£åœ¨è§£æ PDF...");
            if(isReaderMode) document.getElementById('readerFileName').innerText = file.name;
            
            // ç·¨è¼¯æ¨¡å¼æ› PDF = é‡ä¾† (é–±è®€æ¨¡å¼å‰‡ä¿ç•™æ•¸æ“š)
            if (!isReaderMode && annotations.length === 0) {
                 // ä¿æŒ annotations ç©ºçš„
            }

            try {
                const buffer = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument(buffer).promise;
                
                // é‡ç½®åˆ†æ‰¹ç‹€æ…‹
                currentBatchIndex = 0;
                calculateBatches();
                
                document.getElementById('placeholder').style.display = 'none';
                document.getElementById('paginationBar').style.display = 'flex';
                
                await renderCurrentBatch();
            } catch(e) {
                console.error(e);
                alert("PDF è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæœªæå£ä¸”éåŠ å¯†æ–‡ä»¶ã€‚");
            } finally {
                hideLoader();
                input.value = '';
            }
        }

        function calculateBatches() {
            totalBatches = Math.ceil(pdfDoc.numPages / BATCH_SIZE);
            updatePaginationUI();
        }

        function changeBatchSize() {
            BATCH_SIZE = parseInt(document.getElementById('batchSizeSelect').value);
            if(pdfDoc) {
                currentBatchIndex = 0;
                calculateBatches();
                renderCurrentBatch();
            }
        }

        async function renderCurrentBatch() {
            if(!pdfDoc) return;
            showLoader(`æ­£åœ¨æ¸²æŸ“ç¬¬ ${currentBatchIndex+1} / ${totalBatches} æ‰¹é é¢...`);
            
            // æ¸…ç©ºèˆŠé é¢ (é‡‹æ”¾è¨˜æ†¶é«”)
            document.querySelectorAll('.pdf-page').forEach(p => p.remove());

            const start = (currentBatchIndex * BATCH_SIZE) + 1;
            const end = Math.min(start + BATCH_SIZE - 1, pdfDoc.numPages);
            updatePaginationUI(start, end);

            for(let i = start; i <= end; i++) {
                await renderPage(i);
            }
            
            hideLoader();
            document.getElementById('viewerContainer').scrollTop = 0;
        }

        function prevBatch() { if(currentBatchIndex > 0) { currentBatchIndex--; renderCurrentBatch(); } }
        function nextBatch() { if(currentBatchIndex < totalBatches - 1) { currentBatchIndex++; renderCurrentBatch(); } }
        function updatePaginationUI(s, e) {
            const info = document.getElementById('batchInfo');
            if(s && e) info.innerText = `Page ${s} - ${e} / ${pdfDoc.numPages}`;
        }

        async function renderPage(num) {
            const page = await pdfDoc.getPage(num);
            const scale = 1.5; // æ¸…æ™°åº¦
            const viewport = page.getViewport({ scale: scale });
            
            const div = document.createElement('div'); 
            div.className='pdf-page'; 
            div.style.width=`${viewport.width}px`; 
            div.style.height=`${viewport.height}px`; 
            div.dataset.pageNumber=num;
            
            const cvs = document.createElement('canvas'); 
            const ctx = cvs.getContext('2d');
            cvs.width=viewport.width; cvs.height=viewport.height;
            
            const textLayer = document.createElement('div'); 
            textLayer.className='textLayer';
            textLayer.style.width=`${viewport.width}px`; 
            textLayer.style.height=`${viewport.height}px`;

            div.appendChild(cvs); 
            div.appendChild(textLayer);
            document.getElementById('viewerContainer').insertBefore(div, document.getElementById('paginationBar'));
            
            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            
            const content = await page.getTextContent();
            pdfjsLib.renderTextLayer({ 
                textContent: content, 
                container: textLayer, 
                viewport: viewport, 
                textDivs: [] 
            });
            
            // ç¶å®šé¸å–äº‹ä»¶
            if(!isReaderMode) {
                textLayer.addEventListener('mouseup', (e) => handleSelection(e, num));
            }

            // æ¢å¾©æ—¢æœ‰æ¨™è¨»çš„é«˜äº®
            restoreHighlights(num, textLayer);
        }

        // --- 5. æ¨™è¨»èˆ‡é«˜äº®é‚è¼¯ ---
        function restoreHighlights(pageNum, layer) {
            const pageAnns = annotations.filter(a => a.page === pageNum);
            if(pageAnns.length === 0) return;
            
            const spans = layer.children;
            if(spans.length === 0) return;

            pageAnns.forEach(ann => {
                // ç°¡æ˜“æ–‡å­—æ¯”å°é«˜äº®
                for(let s of spans) {
                    if(s.textContent.includes(ann.text) || ann.text.includes(s.textContent)) {
                        s.style.backgroundColor = ann.color + '66'; // åŠ é€æ˜åº¦
                        s.style.borderBottom = `2px solid ${ann.color}`;
                    }
                }
            });
        }

        function handleSelection(e, page) {
            if (isReaderMode) return;
            const sel = window.getSelection(); 
            if(sel.isCollapsed) return;
            const text = sel.toString(); 
            if(!text.trim()) return;
            
            currentSelection = { range: sel.getRangeAt(0), text: text, page: page, id: null };
            openModal(text);
        }

        // --- 6. ç·¨è¼¯è¦–çª—é‚è¼¯ ---
        function openModal(text, existing=null) {
            const m = document.getElementById('editorModal');
            
            // å¡«å€¼
            document.getElementById('rtmId').value = existing ? (existing.rtmId || '') : '';
            document.getElementById('codeName').value = existing ? existing.code : '';
            document.getElementById('codeColor').value = existing ? existing.color : '#ffeb3b';
            document.getElementById('rtmPriority').value = existing ? (existing.priority || 'Medium') : 'Medium';
            document.getElementById('rtmStatus').value = existing ? (existing.status || 'New') : 'New';
            document.getElementById('codeMemo').value = existing ? existing.memo : '';
            document.getElementById('quoteText').innerText = existing ? existing.text : text;

            // æ¨™é¡Œèˆ‡æ¬Šé™
            document.getElementById('modalTitle').innerText = isReaderMode ? "ğŸ‘ï¸ éœ€æ±‚è©³æƒ…" : (existing ? "âœï¸ ç·¨è¼¯éœ€æ±‚" : "ğŸ–ï¸ æ–°å¢éœ€æ±‚");
            const inputs = m.querySelectorAll('input, select, textarea');
            inputs.forEach(el => el.disabled = isReaderMode);
            m.querySelector('.btn-save').style.display = isReaderMode ? 'none' : 'block';
            m.querySelector('.btn-delete').style.display = isReaderMode ? 'none' : 'block';

            if(existing) currentSelection = { id: existing.id };
            m.style.display = 'flex';
        }

        function closeModal() { 
            document.getElementById('editorModal').style.display = 'none'; 
            window.getSelection().removeAllRanges(); 
        }

        function confirmAnnotation() {
            if(isReaderMode) return closeModal();
            
            const newData = {
                page: currentSelection.page,
                text: currentSelection.text || document.getElementById('quoteText').innerText,
                rtmId: document.getElementById('rtmId').value.trim(),
                code: document.getElementById('codeName').value,
                color: document.getElementById('codeColor').value,
                priority: document.getElementById('rtmPriority').value,
                status: document.getElementById('rtmStatus').value,
                memo: document.getElementById('codeMemo').value,
                timestamp: new Date().toISOString()
            };

            if(currentSelection.id) {
                const idx = annotations.findIndex(x => x.id === currentSelection.id);
                if(idx !== -1) annotations[idx] = { ...annotations[idx], ...newData };
            } else {
                annotations.push({ id: Date.now().toString(), ...newData });
            }

            renderSidebar(); 
            saveToLocal(); 
            closeModal();

            // å˜—è©¦æ›´æ–°ç•¶å‰é é¢é«˜äº®
            const pageDiv = document.querySelector(`.pdf-page[data-page-number="${currentSelection.page}"] .textLayer`);
            if(pageDiv) restoreHighlights(currentSelection.page, pageDiv);
        }

        function deleteAnnotation() {
            if(isReaderMode || !currentSelection.id) return;
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤éœ€æ±‚æ¨™è¨»ï¼Ÿ")) {
                annotations = annotations.filter(a => a.id !== currentSelection.id);
                renderSidebar(); 
                saveToLocal(); 
                closeModal();
                // é€™è£¡ä¸è‡ªå‹•åˆ·æ–°é é¢(å¤ªè€—æ•ˆèƒ½)ï¼Œå»ºè­°æ‰‹å‹•æ›é æˆ–å¿½ç•¥
            }
        }

        // --- 7. å…¨åŸŸæœå°‹èˆ‡é€ŸæŸ¥é€Ÿæ¨™ ---
        function searchKeyword(k) {
            document.getElementById('globalSearchInput').value = k;
            performGlobalSearch();
        }

        async function performGlobalSearch() {
            if(!pdfDoc) return;
            const query = document.getElementById('globalSearchInput').value.trim();
            if(!query) return;

            const list = document.getElementById('searchResultsList');
            document.getElementById('searchPanel').style.display = 'flex';
            list.innerHTML = '<div style="text-align:center; padding:20px;">æ­£åœ¨å…¨æ–‡ä»¶æƒæä¸­...<br>(é æ•¸å¤šæ™‚è«‹ç¨å€™)</div>';
            
            let results = [];
            
            // æƒæå…¨æ–‡ä»¶æ–‡å­—
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                const page = await pdfDoc.getPage(i);
                const content = await page.getTextContent();
                const text = content.items.map(item => item.str).join('');
                
                if (text.toLowerCase().includes(query.toLowerCase())) {
                    const idx = text.toLowerCase().indexOf(query.toLowerCase());
                    const snippet = text.substring(Math.max(0, idx - 15), Math.min(text.length, idx + 25));
                    results.push({ page: i, snippet: snippet });
                }
            }

            list.innerHTML = '';
            if(results.length === 0) { list.innerHTML = '<div style="padding:10px; text-align:center; color:#888;">æŸ¥ç„¡çµæœ</div>'; return; }

            results.forEach(res => {
                const div = document.createElement('div');
                div.className = 'search-item';
                
                // å·¦é‚Šï¼šè·³è½‰æ–‡å­—
                const info = document.createElement('div');
                info.style.flex = "1";
                info.style.cursor = "pointer";
                info.innerHTML = `<b style="color:#007bff;">P.${res.page}</b> <span style="color:#555;">...${res.snippet}...</span>`;
                info.onclick = () => jumpToPage(res.page);

                // å³é‚Šï¼šä¸€éµæ¨™è¨˜æŒ‰éˆ•
                const btn = document.createElement('button');
                btn.className = "danger";
                btn.style.padding = "2px 6px";
                btn.style.fontSize = "0.75em";
                btn.innerHTML = "ğŸ“Œ æ¨™è¨˜";
                btn.onclick = (e) => {
                    e.stopPropagation();
                    quickMark(res.page, res.snippet);
                    btn.innerHTML = "âœ”";
                    btn.className = "primary";
                    btn.disabled = true;
                };

                div.appendChild(info);
                div.appendChild(btn);
                list.appendChild(div);
            });
        }

        function closeSearch() { document.getElementById('searchPanel').style.display = 'none'; }

        function quickMark(pageNum, text) {
            const newId = Date.now().toString() + Math.floor(Math.random()*1000);
            annotations.push({
                id: newId,
                page: pageNum,
                text: text,
                rtmId: '-',
                code: 'é‡é»ç« ç¯€',
                color: '#aaaaaa',
                priority: 'High',
                status: 'New',
                memo: 'å¿«é€Ÿæœå°‹ç´¢å¼•',
                timestamp: new Date().toISOString()
            });
            renderSidebar();
            saveToLocal();
        }

        function jumpToPage(p) {
            const targetBatch = Math.floor((p - 1) / BATCH_SIZE);
            if(targetBatch !== currentBatchIndex) {
                currentBatchIndex = targetBatch;
                renderCurrentBatch().then(() => setTimeout(() => {
                    const el = document.querySelector(`.pdf-page[data-page-number="${p}"]`);
                    if(el) el.scrollIntoView({behavior:'smooth'});
                }, 500));
            } else {
                const el = document.querySelector(`.pdf-page[data-page-number="${p}"]`);
                if(el) el.scrollIntoView({behavior:'smooth'});
            }
        }

        // --- 8. å´é‚Šæ¬„æ¸²æŸ“ ---
        function renderSidebar() {
            const list = document.getElementById('sidebarList');
            document.getElementById('count').innerText = annotations.length;
            list.innerHTML = '';

            // æ’åºï¼šé ç¢¼ -> RTM ID
            annotations.sort((a,b) => a.page - b.page);

            annotations.forEach(a => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.style.borderLeftColor = a.color;
                
                // å„ªå…ˆç´šé¡è‰²
                let pColor = '#ccc';
                if(a.priority === 'High') pColor = '#dc3545';
                if(a.priority === 'Low') pColor = '#28a745';

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <div>
                            <span style="font-weight:bold; color:#007bff; font-size:0.9em;">P.${a.page}</span>
                            ${a.rtmId && a.rtmId!=='-' ? `<span style="font-size:0.8em; background:#eee; padding:1px 4px; border-radius:3px;">${a.rtmId}</span>` : ''}
                        </div>
                        <div style="font-size:0.8em; color:#666;">
                            <span class="priority-dot" style="background:${pColor}"></span>${a.priority}
                        </div>
                    </div>
                    <div style="margin-bottom:5px;">
                        <span class="rtm-tag" style="background:${a.color}33; color:#333;">${a.code}</span>
                    </div>
                    <div style="font-size:0.85em; color:#444; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                        "${a.text.substring(0, 30)}..."
                    </div>
                `;
                
                div.onclick = () => {
                    if(isReaderMode) openModal(null, a);
                    else jumpToPage(a.page);
                };
                list.appendChild(div);
            });
        }

        // --- 9. åŒ¯å‡ºåŠŸèƒ½ ---
        function saveProject() {
            const data = { version: "final-v1", annotations: annotations };
            download(JSON.stringify(data), `RTM_Project_${getDateStr()}.json`, 'application/json');
        }

        async function exportExcel() {
            if(annotations.length === 0) return alert("ç„¡è³‡æ–™");
            
            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('éœ€æ±‚è¿½è¹¤è¡¨ (RTM)');
            
            ws.columns = [
                { header: 'ID', key: 'id', width: 6 },
                { header: 'RTM ç·¨è™Ÿ', key: 'rtmId', width: 15 },
                { header: 'é ç¢¼', key: 'page', width: 8 },
                { header: 'æ¨™ç±¤', key: 'code', width: 20 },
                { header: 'å„ªå…ˆç´š', key: 'priority', width: 12 },
                { header: 'ç‹€æ…‹', key: 'status', width: 12 },
                { header: 'åŸæ–‡ (Segment)', key: 'text', width: 50 },
                { header: 'ç­†è¨˜ (Memo)', key: 'memo', width: 40 }
            ];

            // Header Style
            ws.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
            ws.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF444444' } };

            annotations.forEach((a, i) => {
                const row = ws.addRow({
                    id: i+1, rtmId: a.rtmId, page: a.page, code: a.code,
                    priority: a.priority, status: a.status, text: a.text, memo: a.memo
                });
                // Color Code Cell
                const cleanColor = a.color.replace('#','');
                row.getCell('code').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF'+cleanColor } };
            });

            const buf = await wb.xlsx.writeBuffer();
            download(buf, `RTM_Report_${getDateStr()}.xlsx`, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        }

        function exportReaderHtml() {
            if(annotations.length === 0) return alert("ç„¡è³‡æ–™ï¼Œç„¡æ³•æ‰“åŒ…ã€‚");
            let html = document.documentElement.outerHTML;
            
            // æ³¨å…¥æ•¸æ“š
            const data = JSON.stringify({ version: "reader-v1", annotations: annotations });
            const scriptTag = `<script id="embedded-data" type="application/json">${data}<\/script>`;
            
            // æ›¿æ›åŸæœ¬çš„ç©º script
            html = html.replace('<script id="embedded-data" type="application/json"><\/script>', scriptTag);
            
            download(html, `PDF_Reader_Report_${getDateStr()}.html`, 'text/html');
        }

        function download(content, name, type) {
            const blob = new Blob([content], { type: type });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
        }

        function handleProjectLoad(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    annotations = d.annotations || [];
                    renderSidebar(); saveToLocal();
                    alert("å°ˆæ¡ˆè¼‰å…¥æˆåŠŸï¼è«‹åŒ¯å…¥ PDFã€‚");
                } catch(err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
            };
            r.readAsText(f); input.value = '';
        }

        function showLoader(txt) { document.getElementById('loader').style.display = 'flex'; document.getElementById('loaderText').innerText = txt; }
        function hideLoader() { document.getElementById('loader').style.display = 'none'; }
        function getDateStr() { return new Date().toISOString().slice(0,10); }

    </script>
</body>
</html>
