<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF é–±è®€åœ°åœ– (Ultimate V13.2 - ID Collision Fix)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* =========================================
           1. å…¨åŸŸè®Šæ•¸èˆ‡ä¸»é¡Œ
           ========================================= */
        :root {
            --bg-color: #525659;
            --sidebar-bg: #f8f9fa;
            --sidebar-text: #333;
            --item-bg: white;
            --item-border: #ddd;
            --text-color: #333;
            --modal-bg: white;
            --input-bg: white;
            --input-text: #000;
            --link-color: #007bff;
        }

        body.dark-mode {
            --bg-color: #1e1e1e;
            --sidebar-bg: #252526;
            --sidebar-text: #ccc;
            --item-bg: #333333;
            --item-border: #444;
            --text-color: #eee;
            --modal-bg: #2d2d2d;
            --input-bg: #3c3c3c;
            --input-text: #eee;
            --link-color: #4da3ff;
        }

        body { 
            margin: 0; padding: 0; background: #333; 
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
            color: var(--text-color);
        }

        /* =========================================
           2. å·¥å…·åˆ—æ¨£å¼
           ========================================= */
        .toolbar { 
            background: #222; color: white; padding: 10px 20px; 
            display: flex; align-items: center; gap: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 100; flex-shrink: 0; flex-wrap: wrap; 
        }

        .advanced-toolbar {
            background: #333; color: white; padding: 8px 20px;
            display: none; align-items: center; gap: 15px; 
            border-bottom: 1px solid #555; animation: slideDown 0.3s ease-out; z-index: 99;
        }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .reader-toolbar { 
            background: #202b38; color: white; padding: 15px 20px; 
            display: none; align-items: center; justify-content: space-between; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 101; flex-shrink: 0; 
        }

        h1 { margin: 0; font-size: 1.1em; color: #fff; margin-right: 10px; display: flex; align-items: center; gap: 5px; user-select: none; }
        
        button { 
            padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; 
            font-weight: bold; background: #444; color: white; transition: 0.2s; 
            white-space: nowrap; font-size: 0.9em; display: inline-flex; align-items: center; gap: 4px; 
        }
        button:hover { background: #666; transform: translateY(-1px); }
        button.primary { background: #28a745; } button.primary:hover { background: #218838; }
        button.export { background: #17a2b8; } button.info { background: #138496; }
        button.warning { background: #ffc107; color: #333; } button.danger { background: #dc3545; }
        button.ai-btn { background: #6f42c1; } button.ai-btn:hover { background: #59359a; }

        .zoom-btn { width: 30px; justify-content: center; padding: 6px 0; }

        .mode-switch { display: flex; background: #444; border-radius: 20px; padding: 2px; border: 1px solid #555; margin-right: 10px; }
        .mode-btn { padding: 4px 12px; border-radius: 15px; cursor: pointer; font-size: 0.85em; color: #ccc; transition: 0.2s; user-select: none; }
        .mode-btn.active { background: #007bff; color: white; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        .direct-switch { display: flex; align-items: center; cursor: pointer; user-select: none; background: #555; padding: 4px 10px; border-radius: 15px; border: 1px solid #777; }
        .direct-switch.active { background: #dc3545; border-color: #dc3545; }
        .direct-switch span { font-size: 0.85em; margin-left: 5px; color: #ddd; }
        .direct-switch.active span { color: white; font-weight: bold; }

        .search-box { display: flex; align-items: center; background: white; border-radius: 4px; overflow: hidden; margin-left: auto; }
        .search-input { border: none; padding: 6px 10px; outline: none; font-size: 0.9em; width: 140px; color: #333; }
        .search-btn { background: #ffc107; color: #333; border-radius: 0; padding: 6px 10px; }

        /* =========================================
           3. å·¥ä½œå€ (Workspace)
           ========================================= */
        .workspace { display: flex; flex: 1; overflow: hidden; position: relative; background: var(--bg-color); }
        .workspace.sidebar-left { flex-direction: row-reverse; }
        .workspace.sidebar-left .sidebar { border-left: none; border-right: 1px solid #ccc; }

        #viewerContainer { 
            flex: 1; overflow-y: auto; position: relative; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px; padding-bottom: 120px; user-select: none; 
        }
        body.grabbing-mode #viewerContainer, body.grabbing-mode .pdf-page { cursor: grab !important; }
        body.grabbing-mode #viewerContainer:active { cursor: grabbing !important; }

        .pdf-page { position: relative; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); background: white; cursor: crosshair; transition: filter 0.3s; }
        body.dark-mode .pdf-page { filter: invert(0.9) hue-rotate(180deg); }

        .selection-marquee { position: absolute; border: 2px dashed #007bff; background-color: rgba(0, 123, 255, 0.2); pointer-events: none; z-index: 100; }
        .textLayer { opacity: 1; line-height: 1.0; }
        .textLayer span { color: transparent; position: absolute; white-space: pre; cursor: crosshair; }
        
        .highlight-text { background-color: rgba(255, 235, 59, 0.4); border-bottom: 2px solid #e6a800; cursor: pointer; }
        
        .highlight-area { 
            position: absolute; 
            border: 2px solid; 
            background-color: rgba(255, 235, 59, 0.3); 
            cursor: pointer; 
            z-index: 60; 
            transition: 0.2s; 
            pointer-events: auto; 
        }
        .highlight-area:hover { 
            background-color: rgba(255, 235, 59, 0.5); 
            box-shadow: 0 0 8px rgba(0,0,0,0.2);
        }
        
        .highlight-flash { animation: flash 1s ease-in-out; }
        @keyframes flash { 0%, 100% { opacity: 1; border-color: red; box-shadow: 0 0 15px red; } 50% { opacity: 0.2; } }

        /* =========================================
           4. å´é‚Šæ¬„ (Sidebar)
           ========================================= */
        .sidebar { width: 320px; background: var(--sidebar-bg); border-left: 1px solid #ccc; display: flex; flex-direction: column; z-index: 90; color: var(--sidebar-text); transition: background 0.3s; }
        
        .sidebar-tabs { display: none; background: #ddd; border-bottom: 1px solid #bbb; }
        body.dark-mode .sidebar-tabs { background: #333; border-bottom: 1px solid #555; }
        .sidebar-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; font-size: 0.9em; font-weight: bold; color: #666; user-select: none; }
        body.dark-mode .sidebar-tab { color: #aaa; }
        .sidebar-tab.active { background: var(--sidebar-bg); color: var(--sidebar-text); border-top: 3px solid #007bff; }

        .sidebar-header { padding: 10px; background: var(--sidebar-bg); border-bottom: 1px solid #ddd; display: flex; flex-direction: column; gap: 8px; }
        body.dark-mode .sidebar-header { border-bottom: 1px solid #444; }

        #sidebarSearchInput { display: none; width: 100%; padding: 6px; font-size: 0.9em; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc; background: var(--input-bg); color: var(--input-text); box-sizing: border-box; }
        .sidebar-filter { width: 100%; padding: 5px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 4px; background: var(--input-bg); color: var(--input-text); }
        .sidebar-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .list-item { background: var(--item-bg); padding: 10px; margin-bottom: 8px; border-radius: 8px; border: 1px solid var(--item-border); cursor: pointer; border-left: 5px solid #ccc; transition: 0.2s; position: relative; padding-right: 50px; }
        .list-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); background-color: #fafafa; }
        .item-actions { position: absolute; top: 5px; right: 5px; display: flex; flex-direction: column; gap: 2px; }
        .icon-btn { width: 24px; height: 24px; border: none; background: transparent; border-radius: 4px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 14px; color: #666; transition: 0.2s; }
        .icon-btn:hover { background: #eee; color: #000; }
        .tag-badge { display: inline-block; padding: 2px 6px; border-radius: 10px; font-size: 0.75em; color: white; background: #999; margin-right: 5px; vertical-align: middle; }

        .bookmark-item { background: var(--item-bg); padding: 10px; margin-bottom: 5px; border-radius: 4px; border: 1px solid var(--item-border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        body.dark-mode .bookmark-item:hover { background: #444; }
        .outline-item { cursor: pointer; padding: 6px 5px; font-size: 0.9em; border-bottom: 1px solid #eee; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        body.dark-mode .outline-item { border-bottom: 1px solid #444; }
        .outline-item:hover { background-color: rgba(0, 123, 255, 0.1); color: #007bff; }
        .memo-link { color: var(--link-color); text-decoration: underline; cursor: pointer; font-weight: bold; }

        /* =========================================
           5. è¦–çª—å…ƒä»¶ (Modals)
           ========================================= */
        #searchPanel { position: absolute; top: 60px; right: 340px; width: 320px; max-height: 500px; background: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; flex-direction: column; z-index: 2000; }
        .search-header { padding: 10px; background: #f1f3f5; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; font-weight: bold; color: #333; }
        .search-results { overflow-y: auto; padding: 5px; flex: 1; }
        .search-item { padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 0.9em; display: flex; gap: 10px; align-items: center; justify-content: space-between; }
        .search-item:hover { background: #f8f9fa; }
        .search-tag { background: #e9ecef; color: #333; border: 1px solid #ced4da; font-size: 0.8em; padding: 4px 10px; border-radius: 15px; cursor: pointer; }
        .search-tag:hover { background: #007bff; color: white; border-color: #007bff; }

        .floating-nav { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(33, 37, 41, 0.95); padding: 8px 15px; border-radius: 50px; display: flex; gap: 10px; align-items: center; color: white; box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 200; backdrop-filter: blur(4px); border: 1px solid #555; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 3000; pointer-events: none; }
        .modal-card { 
            position: absolute; 
            background: var(--modal-bg); color: var(--text-color); 
            width: 450px; padding: 20px; 
            border-radius: 12px; display: flex; flex-direction: column; gap: 12px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); max-height: 90vh; overflow-y: auto; 
            pointer-events: auto; border: 1px solid #999;
            top: 50px; right: 20px; left: auto;
        }
        .modal-drag-handle { cursor: move; user-select: none; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: inherit; background: var(--input-bg); color: var(--input-text); }
        .preview-box { background: #f0f0f0; padding: 10px; font-size: 0.9em; max-height: 150px; overflow-y: auto; border-radius: 4px; margin-bottom: 10px; border: 1px solid #ccc; resize: vertical; outline: none; color:#333; }
        .memo-toolbar { display: flex; gap: 5px; margin-bottom: 5px; background: #eee; padding: 5px; border-radius: 4px; flex-wrap: wrap; }
        body.dark-mode .memo-toolbar { background: #444; }
        .rich-memo { width: 100%; min-height: 100px; max-height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; overflow-y: auto; background: var(--input-bg); color: var(--input-text); line-height: 1.5; font-size: 0.95em; }
        .custom-fields-area { border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 5px; }
        
        #aiModal .modal-card { width: 600px; height: 80vh; right: auto; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        .ai-list { flex: 1; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: var(--input-bg); border-radius: 4px; }
        .ai-item { display: flex; align-items: center; gap: 10px; padding: 5px; border-bottom: 1px solid #eee; }
        .ai-output { width: 100%; height: 150px; margin-top: 10px; padding: 10px; font-family: monospace; background: #222; color: #0f0; border: none; resize: vertical; }

        .preview-table-container { flex: 1; overflow: auto; border: 1px solid #eee; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9em; background: white; color: #333; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        .data-table th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; font-weight: bold; color: #333; }
        .data-table tr:nth-child(even) { background-color: #f9f9f9; }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 4000; }
        .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; justify-content: center; align-items: center; cursor: zoom-out; flex-direction: column; }
        .lightbox img { max-width: 90%; max-height: 85%; box-shadow: 0 0 20px rgba(255,255,255,0.2); border: 2px solid white; object-fit: contain; }
        .list-item img { cursor: zoom-in; transition: 0.2s; } .list-item img:hover { opacity: 0.8; outline: 2px solid #007bff; }
        
        /* Markdown & Patch Styles */
        .memo-content blockquote { border-left: 4px solid #ddd; margin: 0; padding-left: 10px; color: #666; }
        .memo-content pre { background: #f4f4f4; padding: 5px; border-radius: 4px; overflow-x: auto; }
        .memo-content code { font-family: monospace; background: #eee; padding: 2px 4px; border-radius: 3px; }
        .memo-content ul, .memo-content ol { margin: 5px 0; padding-left: 20px; }
        .memo-content img { max-width: 100%; border: 1px solid #ccc; margin-top: 5px; }
        
        #wikiTooltip {
            display: none; position: fixed; z-index: 9999; background: #fff; 
            border: 1px solid #999; padding: 10px; border-radius: 4px; 
            box-shadow: 4px 4px 12px rgba(0,0,0,0.3); max-width: 300px; 
            font-size: 0.9em; pointer-events: none;
        }
        
        .patch-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 6000; justify-content: center; align-items: center;
        }
        .patch-card {
            background: white; width: 80%; height: 85%; border-radius: 8px;
            display: flex; flex-direction: column; padding: 20px; position: relative;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        .patch-close {
            position: absolute; top: 10px; right: 15px; font-size: 1.5em; 
            cursor: pointer; color: #666;
        }
        .patch-body { flex: 1; overflow-y: auto; padding: 10px; }
        .dashboard-grid { display: flex; flex-wrap: wrap; gap: 20px; height: 100%; }
        .chart-container { flex: 1; min-width: 300px; min-height: 300px; border: 1px solid #eee; padding: 10px; border-radius: 8px; }
        .memo-link:hover { background-color: rgba(255, 255, 0, 0.3); text-decoration: none; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><h3 id="loaderText">è™•ç†ä¸­...</h3></div>

    <div class="toolbar" id="editToolbar">
        <h1>ğŸ› ï¸ V13.2</h1>
        
        <div class="mode-switch">
            <div class="mode-btn" id="modeText" onclick="setMode('text')">ğŸ“ æŠ“æ–‡å­—</div>
            <div class="mode-btn active" id="modeArea" onclick="setMode('area')">ğŸ–ï¸ è¢å…‰ç­†</div>
        </div>

        <button onclick="openSettings()">âš™ï¸ è¨­å®š</button>
        <button class="warning" onclick="openGlobalMemo()">ğŸ’¡ éˆæ„Ÿ</button>

        <button onclick="document.getElementById('pdfInput').click()">ğŸ“‚ PDF</button>
        <input type="file" id="pdfInput" accept="application/pdf" style="display:none" onchange="handlePdfUpload(this)">
        <button onclick="document.getElementById('projectInput').click()">ğŸ“¥ å°ˆæ¡ˆ</button>
        <input type="file" id="projectInput" accept=".json" style="display:none" onchange="handleProjectLoad(this)">
        
        <button onclick="toggleAdvancedUI()" style="border:1px dashed #777; margin-left: 5px;">ğŸ”¨ å·¥å…·ç®±</button>

        <div style="flex:1"></div> 
        
        <button class="primary" onclick="saveProject()">ğŸ’¾ å­˜æª”json</button>
        <button class="export" onclick="exportReaderHtml()">ğŸ“¦ æ‰“åŒ…html</button>
        <button class="info" onclick="openDataPreview()">ğŸ‘€ é è¦½excel</button>
        <button class="danger" onclick="exportExcel()">ğŸ“Š ä¸‹è¼‰Excel</button>

        <div class="search-box">
            <input type="text" id="globalSearchInput" class="search-input" placeholder="å…¨åŸŸæœå°‹..." onkeydown="if(event.key==='Enter') performGlobalSearch()">
            <button class="search-btn" onclick="performGlobalSearch()">ğŸ”</button>
        </div>
    </div>

    <div class="advanced-toolbar" id="advancedToolbar">
        <span style="font-weight:bold; color:#aaa; font-size:0.9em;">[é€²éšåŠŸèƒ½]</span>
        <button onclick="toggleDarkMode()" title="é™ä½è¢å¹•äº®åº¦">ğŸŒ™ æ·±è‰²æ¨¡å¼</button>
        <button onclick="toggleSidebarLayout()" title="å°‡åˆ—è¡¨ç§»è‡³å·¦å´">â¬…ï¸ å´æ¬„æ›é‚Š</button>
        
        <div class="direct-switch" id="directSwitch" onclick="toggleDirectMode()">
            ğŸ–ï¸<span>ç›´æ¥ç•«ç·š (éœé»˜)</span>
        </div>

        <button class="ai-btn" onclick="openAIModal()">ğŸ¤– AI æç¤ºè©åŠ©æ‰‹</button>
    </div>

    <div class="reader-toolbar" id="readToolbar">
        <div style="display:flex; align-items:center; gap:15px;">
            <h1 style="color:#28a745;">ğŸ“– é–±è®€æ¨¡å¼</h1>
            <span style="font-size:0.9em; color:#bbb;" id="readerFileName">å°šæœªè¼‰å…¥æ–‡ä»¶...</span>
        </div>
        <div>
            <button class="primary" onclick="document.getElementById('readerPdfInput').click()">ğŸ“‚ é–‹å•ŸåŸå§‹ PDF</button>
            <input type="file" id="readerPdfInput" accept="application/pdf" style="display:none" onchange="handlePdfUpload(this)">
        </div>
    </div>

    <div class="workspace" id="workspace">
        <div id="viewerContainer">
            <div style="margin-top:100px; color:#aaa; text-align:center;" id="placeholder">
                <h3>è«‹åŒ¯å…¥ PDF</h3>
                <p>V13.2 (ID Collision Fixed)</p>
                <p style="font-size:0.8em; color:#666;">ä¿®å¾© ID é‡è¤‡å°è‡´åˆªé™¤ç•°å¸¸å•é¡Œ</p>
            </div>
            
            <div id="searchPanel">
                <div class="search-header">
                    <span>âš¡ é€ŸæŸ¥é€Ÿæ¨™</span>
                    <span style="cursor:pointer; font-size:1.2em;" onclick="closeSearch()">Ã—</span>
                </div>
                <div style="padding:10px; background:#f8f9fa; border-bottom:1px solid #eee; display:flex; gap:5px; flex-wrap:wrap;">
                    <button class="search-tag" onclick="searchKeyword('äº¤ä»˜')">äº¤ä»˜</button>
                    <button class="search-tag" onclick="searchKeyword('é©—æ”¶')">é©—æ”¶</button>
                    <button class="search-tag" onclick="searchKeyword('ç½°å‰‡')">ç½°å‰‡</button>
                    <button class="search-tag" onclick="searchKeyword('è³‡å®‰')">è³‡å®‰</button>
                </div>
                <div class="search-results" id="searchResultsList"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-tabs" id="sidebarTabs">
                <div class="sidebar-tab active" id="tabIndex" onclick="switchSidebarTab('index')">ğŸ“ ç´¢å¼•</div>
                <div class="sidebar-tab" id="tabOutline" onclick="switchSidebarTab('outline')">ğŸ“‘ ç›®éŒ„</div>
                <div class="sidebar-tab" id="tabBookmark" onclick="switchSidebarTab('bookmark')">ğŸ”– æ›¸ç±¤</div>
            </div>

            <div id="panelIndex" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                <div class="sidebar-header">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold;">ç´¢å¼•åˆ—è¡¨ (<span id="count">0</span>)</span>
                        <button style="font-size:0.75em; padding:2px 6px; background:#6c757d;" onclick="clearAutoSave()">æ¸…ç©ºåˆ—è¡¨</button>
                    </div>
                    <input type="text" id="sidebarSearchInput" placeholder="ğŸ” æœå°‹ ID/æ¨™é¡Œ/æ¨™ç±¤/å…§æ–‡..." oninput="renderSidebar()">
                    
                    <select class="sidebar-filter" id="sidebarFilter" onchange="renderSidebar()" style="margin-top:5px;">
                        <option value="all">é¡¯ç¤ºå…¨éƒ¨</option>
                        <option value="High">ğŸ”´ åªé¡¯ç¤º High</option>
                        <option value="Pending">ğŸ•’ åªé¡¯ç¤º Pending</option>
                        <option value="Image">ğŸ–¼ï¸ åªé¡¯ç¤ºåœ–ç‰‡</option>
                    </select>
                </div>
                <div class="sidebar-list" id="sidebarList"></div>
            </div>

            <div id="panelOutline" style="display:none; flex-direction:column; flex:1; overflow:hidden;">
                <div class="sidebar-header" style="background:#eee; font-weight:bold; font-size:0.9em; color:#555;">PDF åŸç”Ÿç›®éŒ„</div>
                <div class="sidebar-list" id="outlineList">
                    <div style="text-align:center; padding:20px; color:#999;">å°šæœªè¼‰å…¥ PDF æˆ– ç„¡ç›®éŒ„</div>
                </div>
            </div>

            <div id="panelBookmark" style="display:none; flex-direction:column; flex:1; overflow:hidden;">
                <div class="sidebar-header">
                    <button class="primary" style="width:100%" onclick="addBookmark()">â• å°‡æ­¤é åŠ å…¥æ›¸ç±¤</button>
                </div>
                <div class="sidebar-list" id="bookmarkList"></div>
            </div>
        </div>
    </div>

    <div class="floating-nav" id="bottomNav" style="display:none;">
        <div style="display:flex; gap:5px; border-right:1px solid #666; padding-right:10px; margin-right:10px; align-items:center;">
            <button class="zoom-btn" onclick="changeScale(-0.25)">-</button>
            <span id="zoomLevel" style="font-size:0.9em; min-width:40px; text-align:center; color:white;">150%</span>
            <button class="zoom-btn" onclick="changeScale(0.25)">+</button>
        </div>

        <button id="btnPrev" onclick="prevBatch()" style="border-radius:20px; padding:6px 15px;">â¬…</button>
        <select id="jumpSelect" onchange="jumpToBatch(this.value)" style="width:auto; padding:4px; background:#333; color:white; border:none; margin:0 5px;">
            <option value="0">Page 1 - ...</option>
        </select>
        <button id="btnNext" onclick="nextBatch()" style="border-radius:20px; padding:6px 15px;" class="primary">â¡</button>
        <div style="width:1px; height:15px; background:#666; margin:0 5px;"></div>
        <select id="batchSizeSelect" onchange="changeBatchSize()" style="width:auto; padding:4px; font-size:0.85em; background:#333; color:white; border:none;">
            <option value="10">10 é </option>
            <option value="20">20 é </option>
            <option value="50">50 é </option>
        </select>
    </div>

    <div class="modal" id="editorModal">
        <div class="modal-card" id="editorCard">
            <h3 id="modalTitle" class="modal-drag-handle" style="margin:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ–ï¸ ç·¨è¼¯æ¨™è¨»</h3>
            <label style="font-size:0.8em; color:#666; margin-top:10px;">å…§å®¹é è¦½</label>
            <div id="quotePreview" class="preview-box"></div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>RTM ID</label><input type="text" id="rtmId" placeholder="ä¾‹: REQ-0001"></div>
                <div style="flex:2"><label>æ¨™é¡Œ</label><input type="text" id="rtmTitle" placeholder="è¼¸å…¥æ¨™é¡Œ..."></div>
            </div>
            <div style="margin-top:10px;">
                <label>åˆ†é¡æ¨™ç±¤</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="codeName" placeholder="æ¨™ç±¤åç¨±..." style="flex:1">
                    <input type="color" id="codeColor" value="#ffeb3b" style="height:35px; width:40px; padding:0; border:none; cursor:pointer;">
                </div>
                <div id="quickTagArea" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;"></div>
            </div>
            <div id="customFieldsContainer" class="custom-fields-area" style="display:none;"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <div style="flex:1"><label>å„ªå…ˆç´š</label><select id="rtmPriority"><option value="High">ğŸ”´ High</option><option value="Medium">ğŸŸ¡ Medium</option><option value="Low">ğŸŸ¢ Low</option></select></div>
                <div style="flex:1"><label>ç‹€æ…‹</label><select id="rtmStatus"><option value="New">New</option><option value="Pending">Pending</option><option value="Closed">Closed</option></select></div>
            </div>
            <div>
                <label>ç­†è¨˜ (æ”¯æ´ [[WikiLink]])</label>
                <div class="memo-toolbar">
                    <button class="memo-btn" onclick="memoExec('hilite')">ğŸ–Šï¸ è¢å…‰ç­†</button>
                    <button class="memo-btn" onclick="memoExec('checkbox')">â˜‘ï¸ å¾…è¾¦</button>
                    <button class="memo-btn" onclick="triggerImageUpload('codeMemo')">ğŸ“· æ’å…¥åœ–ç‰‡</button>
                    <button class="memo-btn" onclick="insertLinkPlaceholder()">ğŸ”— é€£çµ</button>
                    <button class="memo-btn" onclick="memoExec('clear')">ğŸ§¹ æ¸…æ ¼å¼</button>
                </div>
                <div id="codeMemo" class="rich-memo" contenteditable="true" placeholder="å¯ç›´æ¥è²¼ä¸Šæˆªåœ–..."></div>
            </div>
            <div style="display:flex; justify-content:space-between; gap:10px; margin-top:15px;">
                <button class="danger" id="btnModalDelete" onclick="">ğŸ—‘ï¸ åˆªé™¤</button>
                <div style="display:flex; gap:10px;">
                    <button onclick="closeModal()">å–æ¶ˆ (Esc)</button>
                    <button class="primary btn-save" onclick="confirmAnnotation()">ç¢ºå®š (Enter)</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="aiModal">
        <div class="modal-card">
            <h3 style="margin:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ¤– AI æç¤ºè©ç”¢ç”Ÿå™¨</h3>
            <p style="font-size:0.9em; color:#666; margin:0;">å‹¾é¸å·¦å´æ¨™è¨»ï¼Œç”Ÿæˆ Promptã€‚</p>
            <div style="display:flex; gap:10px; margin-bottom:5px;">
                <select id="aiTemplate" onchange="updateAIPromptPreview()">
                    <option value="summary">ğŸ“ æ‘˜è¦ç¸½çµ</option>
                    <option value="explain">ğŸ’¡ ç™½è©±è§£é‡‹</option>
                    <option value="check">âœ… é‚è¼¯æª¢æŸ¥</option>
                    <option value="qa">â“ å‡ºè€ƒé¡Œ</option>
                    <option value="custom">ğŸ› ï¸ è‡ªå®šç¾©</option>
                </select>
                <button onclick="selectAllForAI()">å…¨é¸</button>
            </div>
            <div id="aiSelectionList" class="ai-list"></div>
            <textarea id="aiOutput" class="ai-output"></textarea>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
                <button onclick="document.getElementById('aiModal').style.display='none'">é—œé–‰</button>
                <button class="primary" onclick="copyAIToClipboard()">ğŸ“‹ è¤‡è£½ Prompt</button>
            </div>
        </div>
    </div>

    <div class="modal" id="globalMemoModal">
        <div class="modal-card">
            <h3 style="margin:0; padding-bottom:10px;">ğŸ’¡ å…¨å±€éˆæ„Ÿç­†è¨˜</h3>
            <div class="memo-toolbar"><button class="memo-btn" onclick="globalMemoExec('hilite')">ğŸ–Šï¸</button><button class="memo-btn" onclick="globalMemoExec('checkbox')">â˜‘ï¸</button></div>
            <div id="globalMemoEditor" class="rich-memo" style="flex:1;" contenteditable="true"></div>
            <div style="text-align:right; margin-top:20px;"><button class="primary" onclick="saveGlobalMemo()">å„²å­˜ä¸¦é—œé–‰</button></div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-card">
            <h3 style="margin:0;">âš™ï¸ ç³»çµ±è¨­å®š</h3>
            <div style="margin-bottom:10px; display:flex; justify-content:space-between;">
                <span>æ¨£æ¿ç®¡ç†</span>
                <div>
                    <button class="info" onclick="saveAsTemplate()">å­˜ç‚ºé è¨­</button> 
                    <button class="warning" onclick="loadFromTemplate()">è¼‰å…¥æ¨£æ¿</button>
                </div>
            </div>
            <div style="background:#f8f9fa; padding:10px; margin-bottom:10px; display:flex; gap:5px;">
                <input type="text" id="newTagName" placeholder="åç¨±..." style="flex:1">
                <input type="color" id="newTagColor" value="#17a2b8" style="width:40px; border:none; height:36px;">
                <button class="primary" onclick="addPreset()">æ–°å¢</button>
            </div>
            <div id="presetList" style="max-height:100px; overflow-y:auto; border:1px solid #eee; padding:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>
            <div id="customFieldList" style="margin-top:10px; border:1px solid #eee; padding:10px;"></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="danger" onclick="resetAllData()">âš ï¸ é‡ç½®ç³»çµ±</button> 
                <button onclick="document.getElementById('settingsModal').style.display='none'">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div class="modal" id="previewModal">
        <div class="modal-card">
            <h3 style="margin:0; padding-bottom:10px;">ğŸ‘€ æ•¸æ“šé è¦½</h3>
            <div class="preview-table-container"><div id="previewContent"></div></div>
            <div style="text-align:right; margin-top:20px;"><button onclick="document.getElementById('previewModal').style.display='none'">é—œé–‰</button></div>
        </div>
    </div>

    <input type="file" id="imageUploadInput" accept="image/*" style="display:none">
    <script id="embedded-data" type="application/json"></script>
    <div class="lightbox" id="imageLightbox" onclick="this.style.display='none'"><img id="lightboxImg" src=""><span>é—œé–‰</span></div>

    <div id="wikiTooltip"></div>
    
    <div id="graphModal" class="patch-modal">
        <div class="patch-card">
            <span class="patch-close" onclick="document.getElementById('graphModal').style.display='none'">Ã—</span>
            <h2 style="margin-top:0;">ğŸ•¸ï¸ çŸ¥è­˜é—œè¯åœ– (Mermaid Graph)</h2>
            <div class="patch-body" style="background:#f9f9f9; border:1px solid #ddd; display:flex; justify-content:center; align-items:center;">
                <div id="mermaidGraph" style="width:100%; text-align:center;"></div>
            </div>
            <div style="text-align:center; padding-top:10px; color:#666; font-size:0.8em;">
                ç³»çµ±æœƒè‡ªå‹•åˆ†æç­†è¨˜ä¸­çš„ [[ID]] æˆ– [[æ¨™é¡Œ]] é€£çµä¸¦ç¹ªè£½æˆåœ–ã€‚
            </div>
        </div>
    </div>
    
    <div id="dashboardModal" class="patch-modal">
        <div class="patch-card">
            <span class="patch-close" onclick="document.getElementById('dashboardModal').style.display='none'">Ã—</span>
            <h2 style="margin-top:0;">ğŸ“Š æ•¸æ“šçµ±è¨ˆå„€è¡¨æ¿</h2>
            <div class="patch-body dashboard-grid">
                <div class="chart-container">
                    <h4 style="text-align:center; margin:0 0 10px 0;">å„ªå…ˆç´šåˆ†ä½ˆ (Priority)</h4>
                    <canvas id="chartPriority"></canvas>
                </div>
                <div class="chart-container">
                    <h4 style="text-align:center; margin:0 0 10px 0;">æ¨™ç±¤é¡åˆ¥çµ±è¨ˆ (Category)</h4>
                    <canvas id="chartCategory"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div id="batchTagModal" class="patch-modal">
        <div class="patch-card" style="width:500px; height:auto; max-height:80vh;">
            <span class="patch-close" onclick="document.getElementById('batchTagModal').style.display='none'">Ã—</span>
            <h2 style="margin-top:0;">ğŸ·ï¸ æ¨™ç±¤æ‰¹æ¬¡ç®¡ç†</h2>
            <div class="patch-body">
                <p style="color:#666; font-size:0.9em;">å°‡èˆŠæ¨™ç±¤çµ±ä¸€ä¿®æ”¹ç‚ºæ–°åç¨±æˆ–æ–°é¡è‰²ã€‚</p>
                <label>é¸æ“‡èˆŠæ¨™ç±¤</label>
                <select id="batchOldTag" onchange="updateBatchColorPreview()" style="margin-bottom:10px;"></select>
                
                <label>æ–°åç¨± (ç•™ç©ºå‰‡ä¸æ”¹å)</label>
                <input type="text" id="batchNewName" placeholder="è¼¸å…¥æ–°æ¨™ç±¤åç¨±..." style="margin-bottom:10px;">
                
                <label>æ–°é¡è‰²</label>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <input type="color" id="batchNewColor" style="height:38px; width:50px;">
                    <span id="batchCountBadge" style="padding:8px; background:#eee; border-radius:4px; font-size:0.9em;">å½±éŸ¿ç­†æ•¸: 0</span>
                </div>
                
                <button class="primary" style="width:100%" onclick="applyBatchTagUpdate()">ğŸš€ åŸ·è¡Œæ‰¹æ¬¡æ›´æ–°</button>
            </div>
        </div>
    </div>

    <script>
        // =========================================
        // 1. å…¨åŸŸè®Šæ•¸
        // =========================================
        let pdfDoc = null;
        let annotations = [];
        let bookmarks = [];
        let BATCH_SIZE = 10;
        let currentBatchIndex = 0;
        let totalBatches = 0;
        let currentSelection = null;
        let editMode = 'area';
        let isReaderMode = false;
        let globalMemo = "";
        let lastUsedSettings = { code: 'é‡é»', color: '#ffeb3b', priority: 'Medium', status: 'New' };
        let customFields = [];
        let currentScale = 1.5;
        let isDirectMode = false;
        let activeMemoId = '';
        let isSpacePressed = false;
        
        let isMouseDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let currentMarquee = null;
        let activePageDiv = null;
        let activePageNum = 0;

        const AUTOSAVE_KEY = 'pdf_ult_v13_2'; // æ–° key é¿å…èˆŠè³‡æ–™æ±™æŸ“
        const TEMPLATE_KEY = 'pdf_ult_v13_tpl';
        let tagPresets = [{ name: "åŠŸèƒ½éœ€æ±‚", color: "#ffc107" }, { name: "è³‡å®‰è¦ç¯„", color: "#dc3545" }];

        // =========================================
        // 2. åˆå§‹åŒ–
        // =========================================
        window.onload = function() {
            loadFromTemplate(true); 
            checkEmbeddedData(); 
            if (!isReaderMode) checkAutoSave();
            
            if (localStorage.getItem('isDarkMode') === 'true') document.body.classList.add('dark-mode');
            if (localStorage.getItem('isSidebarLeft') === 'true') document.getElementById('workspace').classList.add('sidebar-left');
            
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal,#searchPanel').forEach(el => el.style.display = 'none');
                }
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey) && document.getElementById('editorModal').style.display === 'flex') {
                    confirmAnnotation();
                }
                if (e.code === 'Space' && !e.repeat && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName) && !document.activeElement.isContentEditable) { 
                    isSpacePressed = true; 
                    document.body.classList.add('grabbing-mode'); 
                    e.preventDefault(); 
                }
            });

            window.addEventListener('keyup', (e) => { 
                if (e.code === 'Space') { 
                    isSpacePressed = false; 
                    document.body.classList.remove('grabbing-mode'); 
                }
            });

            window.addEventListener('mousemove', handleGlobalMouseMove);
            window.addEventListener('mouseup', handleGlobalMouseUp);

            document.getElementById('imageUploadInput').addEventListener('change', handleImageInsert);
            makeDraggable(document.getElementById("editorCard"), document.getElementById("modalTitle"));
            
            // åˆå§‹åŒ– Patch UI
            setTimeout(() => {
                initPatchUI();
                enablePasteImage();
                mermaid.initialize({ startOnLoad: false, theme: 'default' });
            }, 1000);
        };

        // =========================================
        // 3. UI é‚è¼¯
        // =========================================
        function toggleAdvancedUI() {
            const bar = document.getElementById('advancedToolbar');
            const tabs = document.getElementById('sidebarTabs');
            const search = document.getElementById('sidebarSearchInput');
            
            const isHidden = bar.style.display === 'none' || bar.style.display === '';
            
            if (isHidden) {
                bar.style.display = 'flex';
                tabs.style.display = 'flex';
                search.style.display = 'block';
            } else {
                bar.style.display = 'none';
                tabs.style.display = 'none';
                search.style.display = 'none';
                switchSidebarTab('index');
            }
        }

        function toggleDarkMode() { 
            document.body.classList.toggle('dark-mode'); 
            localStorage.setItem('isDarkMode', document.body.classList.contains('dark-mode')); 
        }

        function toggleSidebarLayout() { 
            document.getElementById('workspace').classList.toggle('sidebar-left'); 
            localStorage.setItem('isSidebarLeft', document.getElementById('workspace').classList.contains('sidebar-left')); 
        }

        function toggleDirectMode() { 
            isDirectMode = !isDirectMode; 
            document.getElementById('directSwitch').classList.toggle('active', isDirectMode); 
        }

        function switchSidebarTab(t) { 
            document.getElementById('tabIndex').classList.toggle('active', t==='index'); 
            document.getElementById('tabOutline').classList.toggle('active', t==='outline');
            document.getElementById('tabBookmark').classList.toggle('active', t==='bookmark'); 
            
            document.getElementById('panelIndex').style.display = t==='index'?'flex':'none'; 
            document.getElementById('panelOutline').style.display = t==='outline'?'flex':'none';
            document.getElementById('panelBookmark').style.display = t==='bookmark'?'flex':'none'; 
            
            if(t==='bookmark') renderBookmarks(); 
        }

        // =========================================
        // 4. ç•«ç·šèˆ‡é¸å–
        // =========================================
        function enableBoxSelection(pageDiv, pageNum) {
            pageDiv.addEventListener('mousedown', (e) => {
                if (isSpacePressed || e.target.closest('.highlight-text, .highlight-area')) return;
                
                isMouseDragging = true;
                activePageDiv = pageDiv;
                activePageNum = pageNum;
                
                const rect = pageDiv.getBoundingClientRect();
                dragStartX = e.clientX - rect.left;
                dragStartY = e.clientY - rect.top;
                
                currentMarquee = document.createElement('div');
                currentMarquee.className = 'selection-marquee';
                currentMarquee.style.left = dragStartX + 'px';
                currentMarquee.style.top = dragStartY + 'px';
                pageDiv.appendChild(currentMarquee);
            });
        }

        function handleGlobalMouseMove(e) {
            if (!isMouseDragging || !activePageDiv) return;
            
            const rect = activePageDiv.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;
            
            const width = Math.abs(currentX - dragStartX);
            const height = Math.abs(currentY - dragStartY);
            const left = Math.min(currentX, dragStartX);
            const top = Math.min(currentY, dragStartY);
            
            if (currentMarquee) {
                currentMarquee.style.width = width + 'px';
                currentMarquee.style.height = height + 'px';
                currentMarquee.style.left = left + 'px';
                currentMarquee.style.top = top + 'px';
            }
        }

        function handleGlobalMouseUp(e) {
            if (!isMouseDragging) return;
            isMouseDragging = false;
            
            if (currentMarquee) {
                const w = parseFloat(currentMarquee.style.width);
                const h = parseFloat(currentMarquee.style.height);
                const l = parseFloat(currentMarquee.style.left);
                const t = parseFloat(currentMarquee.style.top);
                
                currentMarquee.remove();
                currentMarquee = null;
                
                // [ä¿®æ­£] å¢åŠ æœ€å°æ‹–æ›³è·é›¢åˆ¤æ–· (5px)ï¼Œé¿å…èª¤è§¸ç”¢ç”Ÿæ¥µå°æ¡†æ¡†
                if (w > 5 && h > 5 && activePageDiv) {
                    processSelection(activePageNum, {left:l, top:t, width:w, height:h}, activePageDiv);
                }
            }
            activePageDiv = null;
        }

        function processSelection(p, r, div) {
            const nr = {
                left: r.left / currentScale, 
                top: r.top / currentScale, 
                width: r.width / currentScale, 
                height: r.height / currentScale
            };
            
            window.getSelection().removeAllRanges();

            if (editMode === 'text') {
                let txt = "", spans = div.querySelectorAll('.textLayer span'), hits = []; 
                spans.forEach(span => { 
                    if (!(span.offsetLeft + span.offsetWidth < r.left || 
                          span.offsetLeft > r.left + r.width || 
                          span.offsetTop + span.offsetHeight < r.top || 
                          span.offsetTop > r.top + r.height)) {
                        hits.push(span);
                    }
                });
                hits.sort((a,b) => Math.abs(a.offsetTop - b.offsetTop) < 10 ? a.offsetLeft - b.offsetLeft : a.offsetTop - b.offsetTop)
                    .forEach(e => txt += e.innerText + " ");
                
                if (txt.trim()) { 
                    currentSelection = { id: null, type: 'text', page: p, text: txt.trim(), rect: nr }; 
                    if (isDirectMode) quickSave(); else openModal(); 
                }
            } else {
                currentSelection = { id: null, type: 'area', page: p, text: '[è¢å…‰ç­†æ¨™è¨˜]', rect: nr, imageData: null }; 
                if (isDirectMode) quickSave(); else openModal();
            }
        }

        // =========================================
        // 5. æ¨™è¨»è³‡æ–™ (CRUD)
        // =========================================
        function genId() { 
            let m = 0; 
            annotations.forEach(a => { 
                const v = (a.rtmId || "").match(/^REQ-(\d+)$/); 
                if (v) m = Math.max(m, parseInt(v[1])); 
            }); 
            return `REQ-${String(m + 1).padStart(4, '0')}`; 
        }
        
        // [ä¿®æ­£] ID ç”Ÿæˆä½¿ç”¨ Random é¿å…è¡çª
        function generateUniqueId() {
            return Date.now().toString() + '-' + Math.random().toString(36).substr(2, 5);
        }

        function quickSave() { 
            const newId = generateUniqueId();
            const newAnn = {
                id: newId, ...currentSelection, rtmId: genId(), 
                title: currentSelection.text.substring(0, 10), 
                code: lastUsedSettings.code, color: lastUsedSettings.color, 
                priority: 'Medium', status: 'New', memo: '', timestamp: new Date().toISOString()
            };
            annotations.push(newAnn);
            
            renderSidebar(); saveToLocal();
            const div = document.querySelector(`.pdf-page[data-page-number="${newAnn.page}"]`);
            if(div) drawSingleHighlight(newAnn, div);
        }

        function openModal(ex = null) { 
            const m = document.getElementById('editorModal'), c = document.getElementById('editorCard'); 
            c.style.top = "50px"; 
            
            renderCustomFieldsInModal(ex ? ex.customData : {}); renderQuickTags();
            document.getElementById('rtmId').value = ex ? ex.rtmId : genId(); 
            document.getElementById('rtmTitle').value = ex ? (ex.title || ex.code) : ''; 
            document.getElementById('codeName').value = ex ? ex.code : lastUsedSettings.code; 
            document.getElementById('codeColor').value = ex ? ex.color : lastUsedSettings.color;
            document.getElementById('codeMemo').innerHTML = ex ? ex.memo : ''; 
            currentSelection.id = ex ? ex.id : null;
            document.getElementById('quotePreview').innerHTML = currentSelection.type === 'area' ? '(è¢å…‰ç­†å€åŸŸ)' : currentSelection.text;
            
            // [æ–°å¢] ç¶å®šåˆªé™¤æŒ‰éˆ•
            if (ex && ex.id) {
                document.getElementById('btnModalDelete').style.display = 'block';
                document.getElementById('btnModalDelete').onclick = () => { deleteItem(ex.id); closeModal(); };
            } else {
                document.getElementById('btnModalDelete').style.display = 'none';
            }
            
            m.style.display = 'flex'; 
        }

        function confirmAnnotation() {
            const cd = {}; 
            document.querySelectorAll('#customFieldsContainer input').forEach(i => cd[i.dataset.key] = i.value);
            const nd = {
                type: currentSelection.type, page: currentSelection.page, 
                text: currentSelection.type === 'text' ? document.getElementById('quotePreview').innerText : currentSelection.text, 
                rect: currentSelection.rect, imageData: currentSelection.imageData, 
                rtmId: document.getElementById('rtmId').value, title: document.getElementById('rtmTitle').value, 
                code: document.getElementById('codeName').value, color: document.getElementById('codeColor').value, 
                priority: document.getElementById('rtmPriority').value, status: document.getElementById('rtmStatus').value, 
                memo: document.getElementById('codeMemo').innerHTML, customData: cd, timestamp: new Date().toISOString()
            };
            lastUsedSettings = { code: nd.code, color: nd.color };
            
            if (currentSelection.id) { 
                const i = annotations.findIndex(a => a.id === currentSelection.id); 
                annotations[i] = { ...annotations[i], ...nd }; 
                renderCurrentBatch(); 
            } else {
                // [ä¿®æ­£] ç¢ºä¿æ–°å¢æ™‚ ID å”¯ä¸€
                const newId = generateUniqueId();
                const finalData = { id: newId, ...nd };
                annotations.push(finalData);
                const div = document.querySelector(`.pdf-page[data-page-number="${finalData.page}"]`);
                if(div) drawSingleHighlight(finalData, div); 
            }
            renderSidebar(); saveToLocal(); closeModal(); 
        }

        function drawSingleHighlight(ann, div) {
            if (ann.type === 'text') {
                div.querySelectorAll('.textLayer span').forEach(span => { 
                    if (span.innerText.length > 1 && ann.text.includes(span.innerText)) { 
                        span.classList.add('highlight-text', 'hl-' + ann.id); 
                        span.style.borderBottomColor = ann.color; 
                        span.onclick = (e) => { e.stopPropagation(); jumpAndEdit(ann.id); } 
                    } 
                });
            } else { 
                const area = document.createElement('div'); 
                area.className = 'highlight-area'; 
                area.id = 'area-' + ann.id; 
                area.style.left = (ann.rect.left * currentScale) + 'px'; 
                area.style.top = (ann.rect.top * currentScale) + 'px'; 
                area.style.width = (ann.rect.width * currentScale) + 'px'; 
                area.style.height = (ann.rect.height * currentScale) + 'px'; 
                
                area.style.backgroundColor = ann.color + '4D'; 
                area.style.borderColor = ann.color;
                
                area.onclick = (e) => { e.stopPropagation(); jumpAndEdit(ann.id); }; 
                div.appendChild(area); 
            }
        }

        function deleteItem(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨™è¨»ï¼Ÿ')) return;
            
            // [ä¿®æ­£] å¼·åˆ¶å­—ä¸²æ¯”å°ï¼Œä¸¦ç¢ºä¿éæ¿¾æ­£ç¢º
            const originalLength = annotations.length;
            annotations = annotations.filter(a => String(a.id) !== String(id));
            
            renderSidebar();
            saveToLocal();

            // [ä¿®æ­£] ä½¿ç”¨ querySelectorAll ç§»é™¤æ‰€æœ‰å¯èƒ½é‡è¤‡ ID çš„ DOM å…ƒç´  (å¼·åŠ›æ¸…é™¤)
            const areaEls = document.querySelectorAll(`[id='area-${id}']`);
            areaEls.forEach(el => el.remove());

            const textSpans = document.querySelectorAll('.hl-' + id);
            textSpans.forEach(span => {
                span.classList.remove('highlight-text', 'hl-' + id);
                span.style.backgroundColor = '';
                span.style.borderBottomColor = '';
                span.onclick = null;
            });
        }

        function restoreHighlights(p, div) {
            annotations.filter(a => a.page === p).forEach(ann => drawSingleHighlight(ann, div));
        }

        // =========================================
        // 6. å´é‚Šæ¬„èˆ‡é€£çµ
        // =========================================
        function renderSidebar() {
            const list = document.getElementById('sidebarList'); 
            list.innerHTML = '';
            
            const filterVal = document.getElementById('sidebarFilter').value;
            const searchVal = document.getElementById('sidebarSearchInput').value.toLowerCase().trim();
            document.getElementById('count').innerText = annotations.length;

            let filtered = annotations.filter(a => {
                if (filterVal === 'High' && a.priority !== 'High') return false;
                if (filterVal === 'Pending' && a.status !== 'Pending') return false;
                if (filterVal === 'Image' && a.type !== 'area') return false;
                
                if (searchVal) {
                    const match = (a.title && a.title.toLowerCase().includes(searchVal)) || 
                                  (a.code && a.code.toLowerCase().includes(searchVal)) || 
                                  (a.rtmId && a.rtmId.toLowerCase().includes(searchVal)) || 
                                  (a.text && a.text.toLowerCase().includes(searchVal)) || 
                                  (a.memo && a.memo.toLowerCase().includes(searchVal));
                    if (!match) return false;
                }
                return true;
            });
            filtered.sort((a,b) => a.page - b.page);

            filtered.forEach(a => {
                const d = document.createElement('div'); 
                d.className = 'list-item'; 
                d.style.borderLeftColor = a.color;
                const displayMemo = formatMemoLinks(a.memo);
                
                d.innerHTML = `
                    <div style="display:flex;justify-content:space-between;font-size:0.85em;color:#888;">
                        <span>P.${a.page} ${a.type==='area'?'ğŸ–¼ï¸':'ğŸ“'}</span><span>${a.priority}</span>
                    </div>
                    <div style="font-weight:bold;margin:4px 0;font-size:1em;">${a.title||a.code}</div>
                    <div style="margin-bottom:4px;"><span class="tag-badge" style="background:${a.color}">${a.code}</span></div>
                    <div style="font-size:0.85em;color:#666;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">${a.rtmId ? `<b>[${a.rtmId}]</b> ` : ''}${a.text}</div>
                    <div class="memo-content" style="margin-top:5px;border-top:1px dashed #eee;padding-top:5px;font-size:0.85em;color:#444;">${displayMemo}</div>
                    <div class="item-actions">
                        <button class="icon-btn" onclick="event.stopPropagation();jumpAndEdit('${a.id}')">âœï¸</button>
                        <button class="icon-btn" onclick="event.stopPropagation();deleteItem('${a.id}')">ğŸ—‘ï¸</button>
                    </div>`;
                
                d.onclick = () => scrollToAnnotation(a);
                d.querySelectorAll('img').forEach(img => { 
                    img.onclick = (e) => { e.stopPropagation(); showLightbox(img.src); }
                });
                list.appendChild(d);
            });
        }

        window.formatMemoLinks = function(rawText) {
            if (!rawText) return "";
            let processed = rawText;
            if (typeof marked !== 'undefined') {
                try { processed = marked.parse(processed); } catch (e) {}
            }
            return processed.replace(/\[\[(.*?)\]\]/g, (match, ref) => {
                const cleanRef = ref.replace(/<[^>]+>/g, ''); 
                return `<span class="memo-link" 
                          onclick="event.stopPropagation(); handleWikiLink('${cleanRef}')"
                          onmousemove="showTooltip('${cleanRef}', event)"
                          onmouseleave="document.getElementById('wikiTooltip').style.display='none'"
                        >[[${cleanRef}]]</span>`;
            });
        };
        
        function handleWikiLink(ref) {
            const target = annotations.find(a => a.rtmId === ref || a.title === ref || a.code === ref);
            if (target) {
                scrollToAnnotation(target);
                setTimeout(() => {
                   const el = document.getElementById('area-'+target.id) || document.querySelector(`.pdf-page[data-page-number="${target.page}"]`);
                   if (el) { 
                       const originalOutline = el.style.outline; 
                       el.style.outline = "5px solid cyan"; 
                       setTimeout(() => el.style.outline = originalOutline, 1500); 
                   }
                }, 800);
            } else {
                if (confirm(`æ‰¾ä¸åˆ° "${ref}"ã€‚æœå°‹ï¼Ÿ`)) { 
                    toggleAdvancedUI(); 
                    document.getElementById('sidebarSearchInput').value = ref; 
                    renderSidebar(); 
                    switchSidebarTab('index'); 
                }
            }
        }

        // =========================================
        // 7. AI & PDF æ ¸å¿ƒ
        // =========================================
        function openAIModal() {
            const list = document.getElementById('aiSelectionList'); list.innerHTML = '';
            annotations.forEach(a => {
                const div = document.createElement('div'); div.className = 'ai-item';
                div.innerHTML = `<input type="checkbox" value="${a.id}" id="ai_chk_${a.id}"> <label for="ai_chk_${a.id}">[${a.rtmId}] ${a.title || a.text.substring(0,20)}</label>`;
                list.appendChild(div);
            });
            updateAIPromptPreview();
            document.getElementById('aiModal').style.display = 'flex';
        }

        function selectAllForAI() { 
            document.querySelectorAll('#aiSelectionList input').forEach(c => c.checked = true); 
            updateAIPromptPreview(); 
        }

        function updateAIPromptPreview() {
            const tmpl = document.getElementById('aiTemplate').value;
            const ids = Array.from(document.querySelectorAll('#aiSelectionList input:checked')).map(c => c.value);
            const selAnns = annotations.filter(a => ids.includes(a.id));
            let context = selAnns.map(a => `ã€ID: ${a.rtmId} | æ¨™é¡Œ: ${a.title}ã€‘\nå…§å®¹: ${a.text}\nç­†è¨˜: ${a.memo.replace(/<[^>]+>/g,'')}`).join('\n\n----------------\n\n');
            if(!context) context = "(è«‹å…ˆå‹¾é¸ä¸Šæ–¹çš„è³‡æ–™)";
            
            let prompt = "";
            switch(tmpl) {
                case 'summary': prompt = "è«‹å¹«æˆ‘ç¸½çµä»¥ä¸‹æ¨™è¨»å…§å®¹ï¼Œæ­¸ç´å‡ºé‡é»æ‘˜è¦ï¼š\n\n"; break;
                case 'explain': prompt = "è«‹ç”¨ç™½è©±æ–‡è§£é‡‹ä»¥ä¸‹é€™æ®µå…§å®¹çš„å«ç¾©ï¼Œä¸¦èˆ‰ä¾‹èªªæ˜ï¼š\n\n"; break;
                case 'check': prompt = "è«‹æª¢æŸ¥ä»¥ä¸‹å…§å®¹æ˜¯å¦å­˜åœ¨é‚è¼¯çŸ›ç›¾æˆ–ä¸æ˜ç¢ºä¹‹è™•ï¼š\n\n"; break;
                case 'qa': prompt = "è«‹æ ¹æ“šä»¥ä¸‹å…§å®¹ï¼Œå‡º 3 é¡Œæ¸¬è©¦ç†è§£åº¦çš„é¸æ“‡é¡Œï¼ˆé™„ç­”æ¡ˆï¼‰ï¼š\n\n"; break;
                default: prompt = "è«‹æ ¹æ“šä»¥ä¸‹è³‡æ–™å›ç­”å•é¡Œï¼š\n\n";
            }
            document.getElementById('aiOutput').value = prompt + context;
        }

        function copyAIToClipboard() {
            const txt = document.getElementById('aiOutput'); txt.select(); document.execCommand('copy');
            alert("âœ… Prompt å·²è¤‡è£½ï¼è«‹åˆ‡æ›åˆ° ChatGPT/Claude è²¼ä¸Šã€‚");
        }

        async function handlePdfUpload(i){ 
            const f = i.files[0]; 
            if (!f) return; 
            
            showLoader("è§£æä¸­..."); 
            try { 
                pdfDoc = await pdfjsLib.getDocument(await f.arrayBuffer()).promise; 
                calculateBatches(); 
                document.getElementById('placeholder').style.display = 'none'; 
                document.getElementById('bottomNav').style.display = 'flex'; 
                
                loadPdfOutline();
                await renderCurrentBatch(); 
            } catch(e) { 
                alert("è®€å–å¤±æ•—"); console.error(e); 
            } finally { 
                hideLoader(); i.value = ''; 
            } 
        }

        async function loadPdfOutline() {
            const outline = await pdfDoc.getOutline();
            const container = document.getElementById('outlineList');
            container.innerHTML = '';
            
            if (!outline || outline.length === 0) { 
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">æ­¤ PDF ç„¡ç›®éŒ„</div>'; 
                return; 
            }
            renderOutlineItems(outline, container);
        }

        function renderOutlineItems(items, container, level=0) {
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'outline-item';
                div.style.paddingLeft = (10 + level * 15) + 'px';
                div.innerText = item.title;
                div.onclick = async () => {
                    try {
                        let dest = item.dest;
                        if (typeof dest === 'string') { dest = await pdfDoc.getDestination(dest); }
                        if (dest && dest.length > 0) {
                            const ref = dest[0];
                            const pageIndex = await pdfDoc.getPageIndex(ref);
                            jumpToPage(pageIndex + 1);
                        }
                    } catch (e) { console.error('ç›®éŒ„è·³è½‰å¤±æ•—', e); }
                };
                container.appendChild(div);
                if (item.items && item.items.length > 0) { 
                    renderOutlineItems(item.items, container, level + 1); 
                }
            });
        }

        function calculateBatches(){ 
            totalBatches = Math.ceil(pdfDoc.numPages / BATCH_SIZE); 
            const s = document.getElementById('jumpSelect'); s.innerHTML = ''; 
            for(let i=0; i<totalBatches; i++) {
                s.add(new Option(`ç¬¬ ${i*BATCH_SIZE+1}-${Math.min((i+1)*BATCH_SIZE, pdfDoc.numPages)} é `, i));
            }
            updateNav(); 
        }

        async function renderCurrentBatch(){ 
            if(!pdfDoc) return; 
            showLoader("è¼‰å…¥ä¸­..."); 
            document.querySelectorAll('.pdf-page').forEach(p => p.remove()); 
            document.getElementById('jumpSelect').value = currentBatchIndex; 
            updateNav(); 
            for(let i = (currentBatchIndex * BATCH_SIZE) + 1; i <= Math.min((currentBatchIndex + 1) * BATCH_SIZE, pdfDoc.numPages); i++) {
                await renderPage(i); 
            }
            hideLoader(); 
        }

        async function renderPage(n){ 
            const p = await pdfDoc.getPage(n), v = p.getViewport({scale: currentScale}); 
            const d = document.createElement('div'); d.className = 'pdf-page'; 
            d.style.width = v.width+'px'; d.style.height = v.height+'px'; d.dataset.pageNumber = n; 
            d.style.cursor = editMode==='text'?'text':'crosshair'; 
            
            const c = document.createElement('canvas'); c.width = v.width; c.height = v.height; 
            const t = document.createElement('div'); t.className = 'textLayer'; t.style.width = v.width+'px'; t.style.height = v.height+'px'; 
            d.append(c, t); 
            document.getElementById('viewerContainer').appendChild(d); 
            
            await p.render({canvasContext: c.getContext('2d'), viewport: v}).promise; 
            pdfjsLib.renderTextLayer({textContent: await p.getTextContent(), container: t, viewport: v, textDivs: []}); 
            
            if(!isReaderMode) enableBoxSelection(d, n); 
            restoreHighlights(n, d); 
        }
        
        function scrollToAnnotation(a){ 
            const b = Math.floor((a.page - 1) / BATCH_SIZE); 
            if(b !== currentBatchIndex){ 
                currentBatchIndex = b; 
                renderCurrentBatch().then(() => setTimeout(() => doScroll(a), 500)); 
            } else doScroll(a); 
        }

        function doScroll(a){ 
            const el = document.querySelector(`.pdf-page[data-page-number="${a.page}"]`); 
            if(el){ 
                el.scrollIntoView({behavior: 'smooth', block: 'center'}); 
                if(a.type !== 'area') el.classList.add('highlight-flash'); 
            } 
        }
        
        // =========================================
        // 8. è¼”åŠ©å·¥å…·å‡½å¼
        // =========================================
        function showLightbox(s){ document.getElementById('lightboxImg').src = s; document.getElementById('imageLightbox').style.display = 'flex'; }
        
        function makeDraggable(e, h){
            let p1=0, p2=0, p3=0, p4=0;
            h.onmousedown = ev => { 
                ev.preventDefault(); p3 = ev.clientX; p4 = ev.clientY; 
                document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; }; 
                document.onmousemove = v => { 
                    v.preventDefault(); p1 = p3 - v.clientX; p2 = p4 - v.clientY; p3 = v.clientX; p4 = v.clientY; 
                    e.style.top = (e.offsetTop - p2) + "px"; e.style.left = (e.offsetLeft - p1) + "px"; 
                } 
            };
        }

        function saveToLocal(){ if(!isReaderMode) localStorage.setItem(AUTOSAVE_KEY, JSON.stringify({annotations, bookmarks, globalMemo})); }
        
        function checkAutoSave(){
            const s = localStorage.getItem(AUTOSAVE_KEY);
            if(s){
                try {
                    const d = JSON.parse(s);
                    if((d.annotations.length || d.bookmarks.length) && confirm("å¾©åŸæœªå­˜æª”?")){ 
                        annotations = d.annotations; bookmarks = d.bookmarks || []; globalMemo = d.globalMemo || ""; 
                        renderSidebar(); renderBookmarks(); 
                    }
                } catch(e){}
            }
        }
        
        function clearAutoSave() {
            if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰ç´¢å¼•åˆ—è¡¨ï¼Ÿ")) {
                annotations = [];
                renderSidebar();
                saveToLocal();
                document.querySelectorAll('.highlight-text, .highlight-area').forEach(el => el.remove());
            }
        }

        function saveProject(){ 
            download(JSON.stringify({annotations, bookmarks, presets: tagPresets, customFields, globalMemo, lastBatch: currentBatchIndex}), `Proj_${new Date().toISOString().slice(0,10)}.json`, 'application/json'); 
        }

        function handleProjectLoad(i){
            const r = new FileReader();
            r.onload = e => {
                const d = JSON.parse(e.target.result);
                annotations = d.annotations || []; bookmarks = d.bookmarks || []; tagPresets = d.presets || tagPresets; globalMemo = d.globalMemo || ""; currentBatchIndex = d.lastBatch || 0;
                renderSidebar(); renderBookmarks(); saveToLocal(); renderCurrentBatch();
            };
            r.readAsText(i.files[0]); i.value = '';
        }

        function exportReaderHtml(){ 
            let h = document.documentElement.outerHTML; 
            const d = JSON.stringify({annotations, bookmarks, presets: tagPresets, customFields, globalMemo}); 
            download(h.replace(/<script id="embedded-data".*?<\/script>/, `<script id="embedded-data" type="application/json">${d}<\/script>`), 'Reader.html', 'text/html'); 
        }

        function openDataPreview() { 
            if(annotations.length === 0) return alert("ç„¡è³‡æ–™"); 
            let html = '<table class="data-table"><thead><tr>'; 
            const headers = ['ID', 'Page', 'Title', 'Category', 'Priority', 'Status', 'Text/Content']; 
            customFields.forEach(f => headers.push(f.label)); headers.push('Memo'); headers.forEach(h => html += `<th>${h}</th>`); html += '</tr></thead><tbody>'; 
            annotations.forEach(a => { 
                html += '<tr>'; 
                html += `<td>${a.rtmId || ''}</td><td>${a.page}</td><td>${a.title||a.code}</td><td>${a.code}</td><td>${a.priority}</td><td>${a.status}</td>`; 
                const txtContent = a.type === 'area' ? (a.imageData ? '[åœ–ç‰‡]' : '[è¢å…‰ç­†æ¨™è¨˜]') : a.text;
                html += `<td>${txtContent}</td>`; 
                customFields.forEach(f => { html += `<td>${(a.customData && a.customData[f.key]) ? a.customData[f.key] : ''}</td>`; }); 
                html += `<td>${a.memo}</td></tr>`; 
            }); 
            html += '</tbody></table>'; 
            document.getElementById('previewContent').innerHTML = html; 
            document.getElementById('previewModal').style.display = 'flex'; 
        }

        async function exportExcel(){ 
            if(!annotations.length) return alert("ç„¡è³‡æ–™"); 
            const w = new ExcelJS.Workbook(), s = w.addWorksheet('RTM'); 
            s.columns = [{header: 'ID', key: 'id'}, {header: 'Title', key: 't'}, {header: 'Text', key: 'txt'}, {header: 'Memo', key: 'm'}]; 
            annotations.forEach(a => {
                 const txt = a.type === 'area' ? (a.imageData ? '[åœ–ç‰‡]' : '[è¢å…‰ç­†æ¨™è¨˜]') : a.text;
                 s.addRow({id: a.rtmId, t: a.title, txt: txt, m: a.memo.replace(/<[^>]+>/g, '')});
            }); 
            download(await w.xlsx.writeBuffer(), 'RTM.xlsx', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'); 
        }

        async function performGlobalSearch(){ 
            const q = document.getElementById('globalSearchInput').value; if(!q) return; 
            const l = document.getElementById('searchResultsList'); l.innerHTML = 'æœå°‹ä¸­...'; document.getElementById('searchPanel').style.display = 'flex'; 
            let r = []; 
            for(let i = 1; i <= pdfDoc.numPages; i++){ 
                const t = (await(await pdfDoc.getPage(i)).getTextContent()).items.map(s => s.str).join(''); 
                if(t.includes(q)) r.push({p: i, t: t.substring(t.indexOf(q) - 10, t.indexOf(q) + 20)}); 
            } 
            l.innerHTML = r.length ? '' : 'ç„¡çµæœ'; 
            r.forEach(x => l.innerHTML += `<div class="search-item" onclick="jumpToPage(${x.p})">P.${x.p} ...${x.t}...</div>`); 
        }

        function quickMark(page, text) { 
            const id = Date.now().toString(); 
            annotations.push({ 
                id, type: 'text', page, text, 
                title: 'é€Ÿæ¨™é …ç›®', rect: null, 
                code: 'é‡é»é€Ÿæ¨™', color: '#dc3545', 
                rtmId: '-', priority: 'High', status: 'New', 
                memo: 'æœå°‹æ¨™è¨˜', timestamp: new Date().toISOString() 
            }); 
            renderSidebar(); 
            saveToLocal(); 
        }

        function jumpToPage(p){ currentBatchIndex = Math.floor((p - 1) / BATCH_SIZE); renderCurrentBatch().then(() => setTimeout(() => scrollToP(p), 500)); }
        function scrollToP(p){ const el = document.querySelector(`.pdf-page[data-page-number="${p}"]`); if(el) el.scrollIntoView({behavior: 'smooth', block: 'center'}); }
        function closeSearch(){ document.getElementById('searchPanel').style.display = 'none'; }
        
        function handleImageInsert(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const imgTag = `<img src="${event.target.result}" style="max-width:100%; display:block; margin:5px 0;">`;
                const target = document.getElementById(activeMemoId); target.focus(); document.execCommand('insertHTML', false, imgTag);
            };
            reader.readAsDataURL(file); e.target.value = '';
        }
        function triggerImageUpload(targetId) { activeMemoId = targetId; document.getElementById('imageUploadInput').click(); }
        function insertLinkPlaceholder() { document.execCommand('insertText', false, '[[IDæˆ–é—œéµå­—]]'); }
        
        function setMode(m) { 
            editMode = m; 
            document.getElementById('modeText').classList.toggle('active', m === 'text'); 
            document.getElementById('modeArea').classList.toggle('active', m === 'area'); 
            document.querySelectorAll('.pdf-page').forEach(p => p.style.cursor = m === 'text' ? 'text' : 'crosshair'); 
        }

        // =========================================
        // 9. è£œå›éºå¤±çš„å·¥å…·å‡½å¼ (ä¿®å¾©åŠŸèƒ½)
        // =========================================
        
        function showLoader(text) {
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('loaderText').innerText = text || 'è™•ç†ä¸­...';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        function updateNav() {
            document.getElementById('btnPrev').disabled = currentBatchIndex === 0;
            document.getElementById('btnNext').disabled = currentBatchIndex >= totalBatches - 1;
            const start = currentBatchIndex * BATCH_SIZE + 1;
            const end = Math.min((currentBatchIndex + 1) * BATCH_SIZE, pdfDoc ? pdfDoc.numPages : 0);
            document.getElementById('readerFileName').innerText = pdfDoc ? `é¡¯ç¤ºé é¢: ${start} - ${end} / å…± ${pdfDoc.numPages} é ` : 'å°šæœªè¼‰å…¥';
        }

        function changeScale(delta) {
            currentScale = Math.max(0.5, currentScale + delta);
            document.getElementById('zoomLevel').innerText = Math.round(currentScale * 100) + '%';
            renderCurrentBatch();
        }

        function prevBatch() {
            if (currentBatchIndex > 0) {
                currentBatchIndex--;
                renderCurrentBatch();
            }
        }

        function nextBatch() {
            if (currentBatchIndex < totalBatches - 1) {
                currentBatchIndex++;
                renderCurrentBatch();
            }
        }

        function jumpToBatch(val) {
            currentBatchIndex = parseInt(val);
            renderCurrentBatch();
        }

        function changeBatchSize() {
            BATCH_SIZE = parseInt(document.getElementById('batchSizeSelect').value);
            calculateBatches();
            renderCurrentBatch();
        }

        function loadFromTemplate(init = false) {
            const saved = localStorage.getItem(TEMPLATE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    tagPresets = data.presets || tagPresets;
                    customFields = data.customFields || [];
                } catch (e) { console.error("Template load error", e); }
            }
            if (!init) alert("å·²è¼‰å…¥è¨­å®šæ¨£æ¿");
        }

        function checkEmbeddedData() {
            const script = document.getElementById('embedded-data');
            if (script && script.textContent.trim()) {
                try {
                    const data = JSON.parse(script.textContent);
                    annotations = data.annotations || [];
                    bookmarks = data.bookmarks || [];
                    tagPresets = data.presets || tagPresets;
                    customFields = data.customFields || [];
                    globalMemo = data.globalMemo || "";
                    renderSidebar();
                    renderBookmarks();
                    alert("å·²è¼‰å…¥å…§åµŒå°ˆæ¡ˆæ•¸æ“š");
                } catch (e) { console.error("Embedded data error", e); }
            }
        }

        function saveAsTemplate() {
            localStorage.setItem(TEMPLATE_KEY, JSON.stringify({ presets: tagPresets, customFields: customFields }));
            alert("ç›®å‰è¨­å®šå·²å­˜ç‚ºé è¨­æ¨£æ¿");
        }
        
        function resetAllData() {
            if(!confirm("ç¢ºå®šé‡ç½®æ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) return;
            localStorage.removeItem(AUTOSAVE_KEY);
            location.reload();
        }

        function download(content, fileName, contentType) {
            const a = document.createElement("a");
            const file = new Blob([content], { type: contentType });
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
        }

        function renderQuickTags() {
            const container = document.getElementById('quickTagArea');
            container.innerHTML = '';
            tagPresets.forEach(tag => {
                const btn = document.createElement('button');
                btn.innerText = tag.name;
                btn.style.backgroundColor = tag.color;
                btn.style.border = 'none';
                btn.style.padding = '2px 8px';
                btn.style.borderRadius = '10px';
                btn.style.fontSize = '0.8em';
                btn.style.cursor = 'pointer';
                btn.style.color = '#fff';
                btn.onclick = () => {
                    document.getElementById('codeName').value = tag.name;
                    document.getElementById('codeColor').value = tag.color;
                };
                container.appendChild(btn);
            });
        }

        function renderCustomFieldsInModal(currentData = {}) {
            const container = document.getElementById('customFieldsContainer');
            if (customFields.length === 0) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';
            container.innerHTML = '';
            customFields.forEach(f => {
                const div = document.createElement('div');
                div.style.marginBottom = '5px';
                div.innerHTML = `<label style="font-size:0.9em; color:#666;">${f.label}</label>
                                 <input type="text" data-key="${f.key}" value="${currentData[f.key] || ''}" placeholder="${f.label}...">`;
                container.appendChild(div);
            });
        }
        
        function openGlobalMemo() {
            document.getElementById('globalMemoEditor').innerHTML = globalMemo;
            document.getElementById('globalMemoModal').style.display = 'flex';
        }
        
        function saveGlobalMemo() {
            globalMemo = document.getElementById('globalMemoEditor').innerHTML;
            saveToLocal();
            document.getElementById('globalMemoModal').style.display = 'none';
        }
        
        function globalMemoExec(cmd) {
            if(cmd === 'hilite') document.execCommand('backColor', false, 'yellow');
            if(cmd === 'checkbox') document.execCommand('insertHTML', false, '&#9744; ');
        }
        
        function memoExec(cmd) {
            document.getElementById('codeMemo').focus();
            if(cmd === 'hilite') document.execCommand('backColor', false, 'yellow');
            if(cmd === 'checkbox') document.execCommand('insertHTML', false, '&#9744; ');
            if(cmd === 'clear') document.execCommand('removeFormat');
        }

        function jumpAndEdit(id) {
            const ann = annotations.find(a => String(a.id) === String(id));
            if (ann) {
                scrollToAnnotation(ann);
                setTimeout(() => openModal(ann), 300);
            }
        }
        
        function openSettings() {
             const list = document.getElementById('presetList');
             list.innerHTML = '';
             tagPresets.forEach((t, idx) => {
                 const span = document.createElement('span');
                 span.innerHTML = `<span style="background:${t.color}; color:white; padding:2px 6px; border-radius:4px;">${t.name}</span> <span style="cursor:pointer; color:red;" onclick="removePreset(${idx})">Ã—</span>`;
                 list.appendChild(span);
             });
             document.getElementById('settingsModal').style.display = 'flex';
        }
        
        function addPreset() {
            const name = document.getElementById('newTagName').value;
            const color = document.getElementById('newTagColor').value;
            if(name) {
                tagPresets.push({name, color});
                openSettings();
            }
        }
        
        function removePreset(idx) {
            tagPresets.splice(idx, 1);
            openSettings();
        }
        
        function addBookmark() {
            if(!pdfDoc) return;
            const page = Math.floor(currentBatchIndex * BATCH_SIZE) + 1;
            const title = prompt("è¼¸å…¥æ›¸ç±¤åç¨±:", `Page ${page}`);
            if(title) {
                bookmarks.push({ title, page, id: Date.now() });
                renderBookmarks();
                saveToLocal();
            }
        }
        
        function renderBookmarks() {
            const list = document.getElementById('bookmarkList');
            list.innerHTML = '';
            bookmarks.forEach(b => {
                const div = document.createElement('div');
                div.className = 'bookmark-item';
                div.innerHTML = `<span onclick="jumpToPage(${b.page})">ğŸ“‘ ${b.title} (P.${b.page})</span>
                                 <button class="icon-btn" onclick="deleteBookmark(${b.id})">Ã—</button>`;
                list.appendChild(div);
            });
        }
        
        function deleteBookmark(id) {
            bookmarks = bookmarks.filter(b => b.id !== id);
            renderBookmarks();
            saveToLocal();
        }
        
        function closeModal() {
            document.getElementById('editorModal').style.display = 'none';
        }

        // =========================================
        // 10. Patch Features (Mermaid & Charts)
        // =========================================
        function initPatchUI() {
            const bar = document.getElementById('advancedToolbar');
            if(!bar) return;
            
            // é¿å…é‡è¤‡åŠ å…¥
            if(document.getElementById('btnGraph')) return;

            const sep = document.createElement('span'); 
            sep.innerHTML = '|'; sep.style.color = '#555';
            bar.appendChild(sep);
        
            const btnGraph = createPatchBtn('ğŸ•¸ï¸ é—œè¯åœ–', openGraphModal, 'btnGraph');
            const btnDash = createPatchBtn('ğŸ“Š çµ±è¨ˆ', openDashboardModal, 'btnDash');
            const btnBatch = createPatchBtn('ğŸ·ï¸ ç®¡ç†æ¨™ç±¤', openBatchTagModal, 'btnBatch');
            
            bar.appendChild(btnGraph);
            bar.appendChild(btnDash);
            bar.appendChild(btnBatch);
        }
        
        function createPatchBtn(text, func, id) {
            const btn = document.createElement('button');
            btn.innerText = text;
            btn.onclick = func;
            if(id) btn.id = id;
            btn.style.marginLeft = "10px";
            btn.className = "info";
            return btn;
        }
        
        function enablePasteImage() {
            const memoBox = document.getElementById('codeMemo');
            if (!memoBox) return;
            memoBox.addEventListener('paste', function(e) {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const blob = items[i].getAsFile();
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            document.execCommand('insertHTML', false, `<img src="${event.target.result}" style="max-width:100%; margin:5px 0;"><br>`);
                        };
                        reader.readAsDataURL(blob);
                        break;
                    }
                }
            });
        }

        function showTooltip(text, e) {
            const tooltip = document.getElementById('wikiTooltip');
            const target = annotations.find(a => a.rtmId === text || a.title === text || a.code === text);
            let content = target 
                ? `<b>${target.rtmId} ${target.title}</b><br><span style="color:#666">${target.text.substring(0,80)}...</span>` 
                : `<span style="color:red">ç„¡æ­¤é€£çµ: ${text}</span>`;
                
            tooltip.innerHTML = content;
            tooltip.style.display = 'block';
            
            let l = e.clientX + 15, t = e.clientY + 15;
            if (l + 250 > window.innerWidth) l -= 260;
            if (t + 100 > window.innerHeight) t -= 110;
            tooltip.style.left = l + 'px'; tooltip.style.top = t + 'px';
        }
        
        function openGraphModal() {
            document.getElementById('graphModal').style.display = 'flex';
            renderMermaid();
        }
        
        function renderMermaid() {
            const el = document.getElementById('mermaidGraph');
            let graphDef = "graph TD;\n";
            let hasLinks = false;
            
            annotations.forEach(a => {
                const safeId = "N" + a.id.replace(/[^a-zA-Z0-9]/g, '');
                const label = (a.rtmId && a.rtmId.length < 10 ? a.rtmId : a.title).replace(/["()]/g, '');
                
                const links = [...a.memo.matchAll(/\[\[(.*?)\]\]/g)];
                links.forEach(match => {
                    const refText = match[1];
                    const target = annotations.find(t => t.rtmId === refText || t.title === refText || t.code === refText);
                    if (target) {
                        const safeTargetId = "N" + target.id.replace(/[^a-zA-Z0-9]/g, '');
                        graphDef += `  ${safeId}["${label}"] --> ${safeTargetId}["${target.rtmId||target.title}"];\n`;
                        hasLinks = true;
                    }
                });
            });
        
            if (!hasLinks) graphDef += "  Info[å°šæœªå»ºç«‹ä»»ä½•é€£çµ];\n  Tip[è«‹åœ¨ç­†è¨˜ä¸­ä½¿ç”¨ [[ID]] å»ºç«‹é—œè¯];";
            el.innerHTML = `<div class="mermaid">${graphDef}</div>`;
            mermaid.run({ nodes: [el.querySelector('.mermaid')] });
        }
        
        let myCharts = {};
        
        function openDashboardModal() {
            document.getElementById('dashboardModal').style.display = 'flex';
            setTimeout(renderCharts, 200);
        }
        
        function renderCharts() {
            const pCounts = { High: 0, Medium: 0, Low: 0 };
            const cCounts = {};
            
            annotations.forEach(a => {
                pCounts[a.priority] = (pCounts[a.priority] || 0) + 1;
                cCounts[a.code] = (cCounts[a.code] || 0) + 1;
            });
        
            drawChart('chartPriority', 'doughnut', {
                labels: Object.keys(pCounts),
                datasets: [{ data: Object.values(pCounts), backgroundColor: ['#dc3545', '#ffc107', '#28a745'] }]
            });
        
            drawChart('chartCategory', 'bar', {
                labels: Object.keys(cCounts),
                datasets: [{ label: 'æ•¸é‡', data: Object.values(cCounts), backgroundColor: '#17a2b8' }]
            });
        }
        
        function drawChart(id, type, data) {
            if (myCharts[id]) myCharts[id].destroy(); 
            const ctx = document.getElementById(id).getContext('2d');
            myCharts[id] = new Chart(ctx, { type: type, data: data, options: { responsive: true, maintainAspectRatio: false } });
        }
        
        function openBatchTagModal() {
            const sel = document.getElementById('batchOldTag');
            sel.innerHTML = '<option value="">-- è«‹é¸æ“‡æ¨™ç±¤ --</option>';
            const tags = [...new Set(annotations.map(a => a.code))];
            tags.forEach(t => sel.add(new Option(t, t)));
            document.getElementById('batchCountBadge').innerText = "å½±éŸ¿ç­†æ•¸: 0";
            document.getElementById('batchTagModal').style.display = 'flex';
        }
        
        function updateBatchColorPreview() {
            const oldTag = document.getElementById('batchOldTag').value;
            const count = annotations.filter(a => a.code === oldTag).length;
            document.getElementById('batchCountBadge').innerText = `å½±éŸ¿ç­†æ•¸: ${count}`;
            const sample = annotations.find(a => a.code === oldTag);
            if(sample) document.getElementById('batchNewColor').value = sample.color;
        }
        
        function applyBatchTagUpdate() {
            const oldTag = document.getElementById('batchOldTag').value;
            const newName = document.getElementById('batchNewName').value.trim();
            const newColor = document.getElementById('batchNewColor').value;
            
            if(!oldTag) return alert("è«‹é¸æ“‡è¦ä¿®æ”¹çš„æ¨™ç±¤");
            if(!confirm(`ç¢ºå®šè¦ä¿®æ”¹ ${oldTag} å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) return;
        
            let updatedCount = 0;
            annotations.forEach(a => {
                if (a.code === oldTag) {
                    if (newName) a.code = newName;
                    a.color = newColor;
                    updatedCount++;
                    const area = document.getElementById('area-' + a.id);
                    if(area) {
                        area.style.borderColor = newColor;
                        area.style.backgroundColor = newColor + '4D';
                    }
                    document.querySelectorAll('.hl-' + a.id).forEach(s => s.style.borderBottomColor = newColor);
                }
            });
        
            alert(`æˆåŠŸæ›´æ–° ${updatedCount} ç­†è³‡æ–™ï¼`);
            renderSidebar();
            saveToLocal();
            document.getElementById('batchTagModal').style.display = 'none';
        }
    </script>
</body>
</html>
