<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF é–±è®€åœ°åœ– (Pro Max)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <style>
        /* --- 1. æ ¸å¿ƒèˆ‡ä½ˆå±€ --- */
        body { margin: 0; padding: 0; background: #333; font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* ç·¨è¼¯æ¨¡å¼å·¥å…·åˆ— */
        .toolbar { background: #222; color: white; padding: 10px 20px; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 100; flex-shrink: 0; flex-wrap: wrap; }
        
        /* é–±è®€æ¨¡å¼å·¥å…·åˆ— */
        .reader-toolbar { background: #202b38; color: white; padding: 15px 20px; display: none; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 101; flex-shrink: 0; }

        h1 { margin: 0; font-size: 1.1em; color: #fff; margin-right: 10px; display:flex; align-items:center; gap:5px; user-select: none; }
        
        button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: #444; color: white; transition: 0.2s; white-space: nowrap; font-size: 0.9em; display: inline-flex; align-items: center; gap: 4px; }
        button:hover { background: #666; transform: translateY(-1px); }
        button:active { transform: translateY(1px); }
        button.primary { background: #28a745; }
        button.primary:hover { background: #218838; }
        button.export { background: #17a2b8; }
        button.danger { background: #dc3545; }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        /* æ¨¡å¼åˆ‡æ›é–‹é—œ */
        .mode-switch { display: flex; background: #444; border-radius: 20px; padding: 2px; border: 1px solid #555; margin-right: 10px; }
        .mode-btn { padding: 4px 12px; border-radius: 15px; cursor: pointer; font-size: 0.85em; color: #ccc; transition: 0.2s; user-select: none; }
        .mode-btn.active { background: #007bff; color: white; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        /* æœå°‹æ¡† */
        .search-box { display: flex; align-items: center; background: white; border-radius: 4px; overflow: hidden; margin-left: auto; }
        .search-input { border: none; padding: 6px 10px; outline: none; font-size: 0.9em; width: 140px; color:#333; }
        .search-btn { background: #ffc107; color: #333; border-radius: 0; padding: 6px 10px; }
        .search-btn:hover { background: #e0a800; }

        /* --- 2. å·¥ä½œå€èˆ‡ PDF --- */
        .workspace { display: flex; flex: 1; overflow: hidden; position: relative; }
        #viewerContainer { 
            flex: 1; overflow-y: auto; position: relative; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px; padding-bottom: 120px; 
            background: #525659; user-select: none; /* ç¦æ­¢åŸç”Ÿé¸å–ä»¥é…åˆæ¡†é¸ */
        }
        
        .pdf-page { position: relative; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); background: white; cursor: crosshair; }
        .selection-marquee { position: absolute; border: 2px dashed #007bff; background-color: rgba(0, 123, 255, 0.2); pointer-events: none; z-index: 100; }
        .textLayer { opacity: 1; line-height: 1.0; }
        .textLayer span { color: transparent; position: absolute; white-space: pre; cursor: crosshair; }
        
        /* é«˜äº®æ¨£å¼ */
        .highlight-text { background-color: rgba(255, 235, 59, 0.5); border-bottom: 2px solid #e6a800; cursor: pointer; }
        .highlight-area { position: absolute; border: 3px solid #dc3545; background-color: rgba(220, 53, 69, 0.1); cursor: pointer; z-index: 50; transition: 0.2s; }
        .highlight-area:hover { background-color: rgba(220, 53, 69, 0.3); }
        
        /* é–ƒçˆå‹•ç•« (ç”¨æ–¼è·³è½‰å®šä½) */
        .highlight-flash { animation: flash-animation 1.5s ease-in-out 3; z-index: 200 !important; box-shadow: 0 0 15px rgba(255,0,0,0.8); }
        @keyframes flash-animation { 0%, 100% { opacity: 1; border-color: inherit; } 50% { opacity: 0.2; border-color: red; background-color: rgba(255,0,0,0.5); } }

        /* --- 3. æ‡¸æµ®å°è¦½åˆ— (Floating Pill) --- */
        .floating-nav { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(33, 37, 41, 0.95); padding: 8px 15px; border-radius: 50px; display: flex; gap: 15px; align-items: center; color: white; box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 200; backdrop-filter: blur(4px); border: 1px solid #555; }
        .page-info { font-family: monospace; font-size: 1.1em; letter-spacing: 1px; }

        /* --- 4. å´é‚Šæ¬„ --- */
        .sidebar { width: 320px; background: #f8f9fa; border-left: 1px solid #ccc; display: flex; flex-direction: column; z-index: 90; }
        .sidebar-header { padding: 12px; background: white; border-bottom: 1px solid #ddd; display:flex; justify-content:space-between; align-items:center;}
        .sidebar-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .list-item { background: white; padding: 10px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; border-left: 5px solid #ccc; transition:0.2s; position: relative;}
        .list-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-color: #aaa; }
        .priority-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        
        /* --- 5. æœå°‹èˆ‡é€ŸæŸ¥é€Ÿæ¨™é¢æ¿ --- */
        #searchPanel { 
            position: absolute; top: 60px; right: 340px; width: 320px; max-height: 500px; 
            background: white; border: 1px solid #ccc; border-radius: 8px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; flex-direction: column; z-index: 2000; 
        }
        .search-header { padding: 10px; background: #f1f3f5; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; font-weight: bold; color:#333; align-items: center; }
        .search-results { overflow-y: auto; padding: 5px; flex:1; }
        .search-item { padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 0.9em; display:flex; gap:10px; align-items:center; justify-content:space-between; }
        .search-item:hover { background: #f8f9fa; }
        .search-tag { background: #e9ecef; color: #333; border: 1px solid #ced4da; font-size: 0.8em; padding: 4px 10px; border-radius: 15px; cursor:pointer; }
        .search-tag:hover { background: #007bff; color: white; border-color: #007bff; }

        /* --- 6. Modal èˆ‡è¨­å®š --- */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:3000; }
        .modal-card { background:white; width:500px; padding:25px; border-radius:12px; display:flex; flex-direction:column; gap:12px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-height:90vh; overflow-y:auto; animation: modalIn 0.2s ease-out; }
        @keyframes modalIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        input, textarea, select { width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; box-sizing:border-box; font-family: inherit; }
        input:focus, textarea:focus, select:focus { border-color: #007bff; outline: none; box-shadow: 0 0 0 2px rgba(0,123,255,0.2); }
        
        .tag-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
        .tag-chip { padding: 4px 10px; border-radius: 15px; font-size: 0.85em; cursor: pointer; border: 1px solid #ddd; display:flex; align-items:center; gap:5px; background: #f0f0f0; transition:0.2s;}
        .tag-chip:hover { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); background: #e2e6ea;}
        .tag-dot { width: 10px; height: 10px; border-radius: 50%; }

        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 4000; }
        .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom:15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        body.mode-read .toolbar { display: none; }
        body.mode-read .reader-toolbar { display: flex; }

        /* Helper */
        .shortcut-hint { font-size: 0.75em; color: #888; margin-left: auto; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><h3 id="loaderText">è™•ç†ä¸­...</h3></div>

    <div class="toolbar" id="editToolbar">
        <h1>ğŸ› ï¸ é–±è®€åœ°åœ– <span style="font-size:0.5em; opacity:0.6;">Pro</span></h1>
        
        <div class="mode-switch">
            <div class="mode-btn active" id="modeText" onclick="setMode('text')">ğŸ“ æŠ“æ–‡å­—</div>
            <div class="mode-btn" id="modeArea" onclick="setMode('area')">ğŸ–¼ï¸ æ¡†åœ–è¡¨</div>
        </div>

        <button onclick="openSettings()">âš™ï¸ è¨­å®š</button>

        <button onclick="document.getElementById('pdfInput').click()">ğŸ“‚ PDF</button>
        <input type="file" id="pdfInput" accept="application/pdf" style="display:none" onchange="handlePdfUpload(this)">
        <button onclick="document.getElementById('projectInput').click()">ğŸ“¥ å°ˆæ¡ˆ</button>
        <input type="file" id="projectInput" accept=".json" style="display:none" onchange="handleProjectLoad(this)">
        
        <div style="flex:1"></div> 
        <button class="primary" onclick="saveProject()">ğŸ’¾ å­˜æª”</button>
        <button class="export" onclick="exportReaderHtml()">ğŸ“¦ æ‰“åŒ… HTML</button>
        <button class="danger" onclick="exportExcel()">ğŸ“Š Excel</button>

        <div class="search-box">
            <input type="text" id="globalSearchInput" class="search-input" placeholder="å…¨åŸŸæœå°‹..." onkeydown="if(event.key==='Enter') performGlobalSearch()">
            <button class="search-btn" onclick="performGlobalSearch()">ğŸ”</button>
        </div>
    </div>

    <div class="reader-toolbar" id="readToolbar">
        <div style="display:flex; align-items:center; gap:15px;">
            <h1 style="color:#28a745;">ğŸ“– æˆæœé–±è®€å™¨</h1>
            <span style="font-size:0.9em; color:#bbb;" id="readerFileName">å°šæœªè¼‰å…¥æ–‡ä»¶...</span>
        </div>
        <div>
            <button class="primary" onclick="document.getElementById('readerPdfInput').click()">ğŸ“‚ é–‹å•ŸåŸå§‹ PDF</button>
            <input type="file" id="readerPdfInput" accept="application/pdf" style="display:none" onchange="handlePdfUpload(this)">
        </div>
    </div>

    <div class="workspace">
        <div id="viewerContainer">
            <div style="margin-top:100px; color:#aaa; text-align:center;" id="placeholder">
                <h3>è«‹åŒ¯å…¥ PDF</h3>
                <p>ä½¿ç”¨å·¦ä¸Šè§’é–‹é—œåˆ‡æ›ã€ŒæŠ“æ–‡å­—ã€æˆ–ã€Œæ¡†åœ–è¡¨ã€æ¨¡å¼</p>
                <p style="font-size:0.8em; margin-top:10px;">å¿«é€Ÿéµï¼šESC é—œé–‰è¦–çª— | Ctrl+Enter å„²å­˜</p>
            </div>
            
            <div id="searchPanel">
                <div class="search-header">
                    <span id="searchTitle">âš¡ é€ŸæŸ¥ (Quick Search)</span>
                    <button id="stopSearchBtn" class="danger" style="display:none; padding:2px 8px; font-size:0.75em;" onclick="stopSearching=true">â¹ åœæ­¢</button>
                    <span style="cursor:pointer; font-size:1.2em;" onclick="closeSearch()">Ã—</span>
                </div>
                <div style="padding:10px; background:#f8f9fa; border-bottom:1px solid #eee; display:flex; gap:5px; flex-wrap:wrap;">
                    <button class="search-tag" onclick="searchKeyword('äº¤ä»˜')">äº¤ä»˜</button>
                    <button class="search-tag" onclick="searchKeyword('é©—æ”¶')">é©—æ”¶</button>
                    <button class="search-tag" onclick="searchKeyword('ç½°å‰‡')">ç½°å‰‡</button>
                    <button class="search-tag" onclick="searchKeyword('è³‡å®‰')">è³‡å®‰</button>
                </div>
                <div class="search-results" id="searchResultsList"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <span style="font-weight:bold;">ç´¢å¼•åˆ—è¡¨ (<span id="count">0</span>)</span>
                <button style="font-size:0.75em; padding:2px 6px; background:#6c757d;" onclick="clearAutoSave()">æ¸…é™¤</button>
            </div>
            <div class="sidebar-list" id="sidebarList"></div>
        </div>
    </div>

    <div class="floating-nav" id="bottomNav" style="display:none;">
        <button id="btnPrev" onclick="prevBatch()" style="border-radius:20px; padding:6px 15px;">â¬…</button>
        <span class="page-info" id="batchInfo">Page 1 - 10</span>
        <button id="btnNext" onclick="nextBatch()" style="border-radius:20px; padding:6px 15px;" class="primary">â¡</button>
        <div style="width:1px; height:15px; background:#666; margin:0 5px;"></div>
        <select id="batchSizeSelect" onchange="changeBatchSize()" style="width:auto; padding:4px; font-size:0.85em; background:#333; color:white; border:none;">
            <option value="5">5 é </option>
            <option value="10" selected>10 é </option>
            <option value="20">20 é </option>
            <option value="50">50 é  (é«˜æ•ˆèƒ½)</option>
        </select>
    </div>

    <div class="modal" id="editorModal">
        <div class="modal-card">
            <h3 id="modalTitle" style="margin:0; border-bottom:1px solid #eee; padding-bottom:10px; display:flex; justify-content:space-between;">
                <span>ğŸ–ï¸ æ¨™è¨»å…§å®¹</span>
                <span class="shortcut-hint">Ctrl+Enter å­˜æª”</span>
            </h3>
            
            <div id="textInputGroup">
                <label style="font-size:0.8em; color:#666;">å…§å®¹é è¦½</label>
                <div id="quoteText" style="background:#f0f0f0; padding:10px; font-size:0.9em; max-height:60px; overflow-y:auto; border-radius:4px; margin-bottom:10px;"></div>
            </div>

            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>RTM ID</label>
                    <input type="text" id="rtmId" placeholder="ä¾‹: REQ-001">
                </div>
                <div style="flex:2">
                    <label>åˆ†é¡æ¨™ç±¤ (Tag)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="codeName" placeholder="è¼¸å…¥æˆ–é¸ä¸‹æ–¹...">
                        <input type="color" id="codeColor" value="#ffeb3b" style="height:35px; width:40px; padding:0; border:none; cursor:pointer;">
                    </div>
                </div>
            </div>

            <div id="quickTagArea" style="display:flex; flex-wrap:wrap; gap:5px; margin-top:-5px; margin-bottom:5px;"></div>

            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>å„ªå…ˆç´š</label>
                    <select id="rtmPriority">
                        <option value="High">ğŸ”´ High</option>
                        <option value="Medium">ğŸŸ¡ Medium</option>
                        <option value="Low">ğŸŸ¢ Low</option>
                    </select>
                </div>
                <div style="flex:1">
                    <label>ç‹€æ…‹</label>
                    <select id="rtmStatus">
                        <option value="New">New</option>
                        <option value="Pending">Pending</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
            </div>

            <div>
                <label>ç­†è¨˜ (Memo)</label>
                <textarea id="codeMemo" rows="3" placeholder="åˆ†æèªªæ˜..."></textarea>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px; border-top:1px solid #eee; padding-top:15px;">
                <button class="danger btn-delete" onclick="deleteAnnotation()">åˆªé™¤</button>
                <button onclick="closeModal()">å–æ¶ˆ (Esc)</button>
                <button class="primary btn-save" onclick="confirmAnnotation()">ç¢ºå®š (Enter)</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-card">
            <h3 style="margin:0;">âš™ï¸ è¨­å®šå¸¸ç”¨æ¨™ç±¤</h3>
            <div style="background:#f8f9fa; padding:10px; border-radius:8px; display:flex; gap:5px;">
                <input type="text" id="newTagName" placeholder="æ–°æ¨™ç±¤åç¨±..." style="flex:1">
                <input type="color" id="newTagColor" value="#17a2b8" style="width:40px; border:none; height:36px;">
                <button class="primary" onclick="addPreset()">æ–°å¢</button>
            </div>
            <div id="presetList" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:4px; padding:10px;"></div>
            <div style="text-align:right; margin-top:10px;">
                <button onclick="document.getElementById('settingsModal').style.display='none'">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script id="embedded-data" type="application/json"></script>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let pdfDoc = null;
        let annotations = []; 
        let BATCH_SIZE = 10;
        let currentBatchIndex = 0;
        let totalBatches = 0;
        let currentSelection = null;
        let editMode = 'text'; 
        let isReaderMode = false;
        let stopSearching = false; // æ§åˆ¶æœå°‹åœæ­¢
        
        // è¨˜æ†¶ä¸Šæ¬¡ä½¿ç”¨çš„è¨­å®š (UX å„ªåŒ–æ ¸å¿ƒ)
        let lastUsedSettings = {
            code: '',
            color: '#ffeb3b',
            priority: 'Medium',
            status: 'New'
        };

        const AUTOSAVE_KEY = 'pdf_ultimate_autosave_v2';
        const PRESETS_KEY = 'pdf_ultimate_presets';

        // é è¨­æ¨™ç±¤
        let tagPresets = [
            { name: "åŠŸèƒ½éœ€æ±‚", color: "#ffc107" },
            { name: "è³‡å®‰è¦ç¯„", color: "#dc3545" },
            { name: "äº¤ä»˜é …ç›®", color: "#28a745" },
            { name: "SLA", color: "#17a2b8" }
        ];

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            loadPresets();
            checkEmbeddedData();
            if(!isReaderMode) checkAutoSave();
            
            // éµç›¤äº‹ä»¶ç›£è½
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if(document.getElementById('editorModal').style.display === 'flex') closeModal();
                    else if(document.getElementById('settingsModal').style.display === 'flex') document.getElementById('settingsModal').style.display = 'none';
                    else if(document.getElementById('searchPanel').style.display === 'flex') closeSearch();
                }
                // Ctrl+Enter åœ¨ Modal ä¸­å­˜æª”
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    if(document.getElementById('editorModal').style.display === 'flex') confirmAnnotation();
                }
            });
        };

        // --- æ ¸å¿ƒï¼šPDF è¼‰å…¥èˆ‡åˆ†æ‰¹ ---
        async function handlePdfUpload(input) {
            const file = input.files[0]; if(!file) return;
            showLoader("æ­£åœ¨è§£æ PDF...");
            if(isReaderMode) document.getElementById('readerFileName').innerText = file.name;

            try {
                const buffer = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument(buffer).promise;
                currentBatchIndex = 0;
                calculateBatches();
                document.getElementById('placeholder').style.display = 'none';
                document.getElementById('bottomNav').style.display = 'flex';
                await renderCurrentBatch();
            } catch(e) { alert("è®€å–å¤±æ•—"); console.error(e); } 
            finally { hideLoader(); input.value=''; }
        }

        function calculateBatches() { totalBatches = Math.ceil(pdfDoc.numPages / BATCH_SIZE); updateNavUI(); }
        function changeBatchSize() { BATCH_SIZE = parseInt(document.getElementById('batchSizeSelect').value); currentBatchIndex=0; calculateBatches(); renderCurrentBatch(); }

        async function renderCurrentBatch() {
            if(!pdfDoc) return;
            showLoader(`è¼‰å…¥ç¬¬ ${currentBatchIndex+1} / ${totalBatches} æ‰¹...`);
            document.querySelectorAll('.pdf-page').forEach(p => p.remove());

            const start = (currentBatchIndex * BATCH_SIZE) + 1;
            const end = Math.min(start + BATCH_SIZE - 1, pdfDoc.numPages);
            updateNavUI(start, end);

            for(let i=start; i<=end; i++) await renderPage(i);
            
            hideLoader();
            document.getElementById('viewerContainer').scrollTop = 0;
        }

        async function renderPage(num) {
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: 1.5 });
            const div = document.createElement('div'); div.className='pdf-page'; 
            div.style.width=`${viewport.width}px`; div.style.height=`${viewport.height}px`; div.dataset.pageNumber=num;
            div.style.cursor = editMode === 'text' ? 'text' : 'crosshair';

            const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
            cvs.width=viewport.width; cvs.height=viewport.height;
            const textLayer = document.createElement('div'); textLayer.className='textLayer';
            textLayer.style.width=`${viewport.width}px`; textLayer.style.height=`${viewport.height}px`;

            div.append(cvs, textLayer);
            document.getElementById('viewerContainer').appendChild(div);

            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            const content = await page.getTextContent();
            pdfjsLib.renderTextLayer({ textContent: content, container: textLayer, viewport: viewport, textDivs: [] });
            
            if(!isReaderMode) enableBoxSelection(div, num);
            restoreHighlights(num, div);
        }

        // --- æ ¸å¿ƒï¼šMagic Box é¸å–é‚è¼¯ ---
        let isDrawing = false, startX, startY, marquee = null, activePageElement = null;

        function enableBoxSelection(pageDiv, pageNum) {
            pageDiv.addEventListener('mousedown', (e) => {
                if(e.target.classList.contains('highlight-text') || e.target.classList.contains('highlight-area')) return;
                isDrawing = true; activePageElement = pageDiv;
                const rect = pageDiv.getBoundingClientRect();
                startX = e.clientX - rect.left; startY = e.clientY - rect.top;
                
                marquee = document.createElement('div'); marquee.className = 'selection-marquee';
                marquee.style.borderColor = editMode === 'text' ? '#007bff' : '#dc3545';
                marquee.style.left = startX + 'px'; marquee.style.top = startY + 'px';
                pageDiv.appendChild(marquee);
            });

            pageDiv.addEventListener('mousemove', (e) => {
                if (!isDrawing || activePageElement !== pageDiv) return;
                const rect = pageDiv.getBoundingClientRect();
                const curX = e.clientX - rect.left; const curY = e.clientY - rect.top;
                marquee.style.width = Math.abs(curX - startX) + 'px'; marquee.style.height = Math.abs(curY - startY) + 'px';
                marquee.style.left = Math.min(curX, startX) + 'px'; marquee.style.top = Math.min(curY, startY) + 'px';
            });

            pageDiv.addEventListener('mouseup', (e) => {
                if (!isDrawing || activePageElement !== pageDiv) return;
                isDrawing = false;
                const mRect = { left: parseFloat(marquee.style.left), top: parseFloat(marquee.style.top), width: parseFloat(marquee.style.width), height: parseFloat(marquee.style.height) };
                
                if (mRect.width > 10 && mRect.height > 10) {
                    if (editMode === 'text') {
                        // æŠ“æ–‡å­— (å„ªåŒ–ç‰ˆ)
                        const spans = pageDiv.querySelectorAll('.textLayer span');
                        let captured = "";
                        const mR = mRect.left + mRect.width; const mB = mRect.top + mRect.height;
                        
                        // ç°¡æ˜“æ’åºï¼Œé¿å…æ–‡å­—é †åºéŒ¯äº‚
                        let hitSpans = [];
                        spans.forEach(s => {
                            const sl = s.offsetLeft; const st = s.offsetTop;
                            if (!(sl+s.offsetWidth < mRect.left || sl > mR || st+s.offsetHeight < mRect.top || st > mB)) {
                                hitSpans.push(s);
                            }
                        });
                        
                        // ä¾ç…§ Y è»¸ -> X è»¸ æ’åº
                        hitSpans.sort((a,b) => {
                             const diffY = a.offsetTop - b.offsetTop;
                             return Math.abs(diffY) < 10 ? a.offsetLeft - b.offsetLeft : diffY;
                        });

                        hitSpans.forEach(s => captured += s.innerText + " "); // è£œå€‹ç©ºæ ¼é¿å…é»å­—

                        if(captured.trim()) {
                            currentSelection = { id:null, type:'text', page:pageNum, text:captured.trim(), rect:null };
                            openModal();
                        }
                    } else {
                        // æ¡†åœ–è¡¨
                        currentSelection = { id:null, type:'area', page:pageNum, text:'[åœ–è¡¨æ¨™è¨˜]', rect:mRect };
                        openModal();
                    }
                }
                marquee.remove();
            });
        }

        // --- æ¨™è¨»æ¢å¾©èˆ‡é«˜äº® ---
        function restoreHighlights(pageNum, pageDiv) {
            const pageAnns = annotations.filter(a => a.page === pageNum);
            pageAnns.forEach(ann => {
                if(ann.type === 'text') {
                    const spans = pageDiv.querySelectorAll('.textLayer span');
                    spans.forEach(s => {
                        // ç°¡å–®çš„æ–‡å­—æ¯”å°é«˜äº®ï¼Œå¯¦éš›å°ˆæ¡ˆå¯ç”¨æ›´ç²¾ç¢ºçš„åº§æ¨™
                        if(s.innerText.length > 1 && ann.text.includes(s.innerText)) {
                            s.classList.add('highlight-text'); s.style.borderBottomColor = ann.color; s.style.backgroundColor = ann.color + '44';
                            s.onclick = (e) => { e.stopPropagation(); editAnnotation(ann); };
                        }
                    });
                } else if(ann.type === 'area') {
                    const area = document.createElement('div'); area.className = 'highlight-area'; area.id = 'area-'+ann.id;
                    area.style.left = ann.rect.left+'px'; area.style.top = ann.rect.top+'px';
                    area.style.width = ann.rect.width+'px'; area.style.height = ann.rect.height+'px';
                    area.style.borderColor = ann.color; area.style.backgroundColor = ann.color + '22';
                    area.onclick = (e) => { e.stopPropagation(); editAnnotation(ann); };
                    pageDiv.appendChild(area);
                }
            });
        }

        function editAnnotation(ann) {
            if(isReaderMode) { openModal(null, ann); return; }
            currentSelection = { ...ann }; openModal();
        }

        // --- æœå°‹å„ªåŒ– (Async + Chunking) ---
        function searchKeyword(k) { document.getElementById('globalSearchInput').value=k; performGlobalSearch(); }
        
        async function performGlobalSearch() {
            if(!pdfDoc) return;
            const q = document.getElementById('globalSearchInput').value.trim(); if(!q) return;
            
            const list = document.getElementById('searchResultsList');
            const title = document.getElementById('searchTitle');
            const stopBtn = document.getElementById('stopSearchBtn');
            
            document.getElementById('searchPanel').style.display='flex';
            list.innerHTML = '';
            stopBtn.style.display = 'inline-block';
            stopSearching = false;
            
            let count = 0;
            const CHUNK_SIZE = 5; // æ¯æ¬¡è™•ç† 5 é ï¼Œé¿å…å‡çµ

            for(let i=1; i<=pdfDoc.numPages; i++) {
                if(stopSearching) {
                    list.innerHTML += `<div style="text-align:center; padding:10px; color:#dc3545;">å·²åœæ­¢æœå°‹</div>`;
                    break;
                }

                // æ›´æ–° UI é€²åº¦
                title.innerText = `æœå°‹ä¸­... (${Math.round((i/pdfDoc.numPages)*100)}%)`;
                
                try {
                    const p = await pdfDoc.getPage(i); 
                    const c = await p.getTextContent();
                    const t = c.items.map(x=>x.str).join(''); // ç°¡å–®æ‹¼æ¥
                    
                    if(t.toLowerCase().includes(q.toLowerCase())) {
                        count++;
                        const idx = t.toLowerCase().indexOf(q.toLowerCase());
                        const snippet = t.substring(Math.max(0, idx-10), Math.min(t.length, idx+30));
                        
                        const d = document.createElement('div'); d.className='search-item';
                        d.innerHTML = `<span>P.${i} ...${snippet}...</span><button class="danger" style="font-size:0.7em;padding:2px 6px;">ğŸ“Œ æ¨™è¨˜</button>`;
                        
                        // é»æ–‡å­—è·³è½‰
                        d.querySelector('span').onclick = () => jumpToPage(i);
                        // é»æŒ‰éˆ•é€Ÿæ¨™
                        d.querySelector('button').onclick = (e) => {
                            e.stopPropagation(); quickMark(i, snippet);
                            e.target.innerText='âœ”'; e.target.disabled=true; e.target.className='primary';
                        };
                        list.appendChild(d);
                    }
                } catch(e) { console.error(e); }

                // è®“ç€è¦½å™¨å–˜å£æ°£ (Yield to UI)
                if(i % CHUNK_SIZE === 0) await new Promise(r => setTimeout(r, 0));
            }
            
            title.innerText = `æœå°‹å®Œæˆ (å…± ${count} ç­†)`;
            stopBtn.style.display = 'none';
            if(count === 0) list.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">æ‰¾ä¸åˆ°ç›¸é—œå…§å®¹</div>';
        }
        
        function closeSearch() { 
            stopSearching = true;
            document.getElementById('searchPanel').style.display='none'; 
        }
        
        function quickMark(page, text) {
            const id = Date.now().toString();
            annotations.push({
                id, type:'text', page, text, rect:null, code:'é‡é»é€Ÿæ¨™', color:'#dc3545',
                rtmId:'-', priority:'High', status:'New', memo:'æœå°‹æ¨™è¨˜', timestamp:new Date().toISOString()
            });
            renderSidebar(); saveToLocal();
        }

        function jumpToPage(p) {
            const tb = Math.floor((p-1)/BATCH_SIZE);
            if(tb !== currentBatchIndex) { 
                currentBatchIndex=tb; 
                renderCurrentBatch().then(()=>setTimeout(()=>scrollToP(p),500)); 
            } else {
                scrollToP(p);
            }
        }
        function scrollToP(p) { 
            const el=document.querySelector(`.pdf-page[data-page-number="${p}"]`); 
            if(el) {
                el.scrollIntoView({behavior:'smooth'});
                // è¦–è¦ºæç¤ºï¼šé–ƒçˆé‚Šæ¡†
                el.style.transition = 'box-shadow 0.3s';
                el.style.boxShadow = '0 0 0 5px rgba(0,123,255,0.5)';
                setTimeout(() => el.style.boxShadow = '', 1000);
            }
        }

        // --- æ¨™ç±¤ç®¡ç† (Settings) ---
        function loadPresets() { const s=localStorage.getItem(PRESETS_KEY); if(s) tagPresets=JSON.parse(s); }
        function savePresets() { localStorage.setItem(PRESETS_KEY, JSON.stringify(tagPresets)); }
        function openSettings() {
            const list = document.getElementById('presetList'); list.innerHTML='';
            tagPresets.forEach((t,i) => {
                const d=document.createElement('div'); d.className='tag-row';
                d.innerHTML=`<div style="width:20px;height:20px;background:${t.color};border-radius:50%;"></div><span style="flex:1;">${t.name}</span><button class="danger" onclick="removePreset(${i})">åˆªé™¤</button>`;
                list.appendChild(d);
            });
            document.getElementById('settingsModal').style.display='flex';
        }
        function addPreset() {
            const n=document.getElementById('newTagName').value; const c=document.getElementById('newTagColor').value;
            if(n) { tagPresets.push({name:n, color:c}); savePresets(); openSettings(); document.getElementById('newTagName').value=''; }
        }
        function removePreset(i) { tagPresets.splice(i,1); savePresets(); openSettings(); }
        
        function renderQuickTags() {
            const area = document.getElementById('quickTagArea'); area.innerHTML='';
            tagPresets.forEach(t => {
                const c=document.createElement('div'); c.className='tag-chip';
                c.innerHTML=`<div class="tag-dot" style="background:${t.color}"></div>${t.name}`;
                c.onclick=()=>{ 
                    document.getElementById('codeName').value=t.name; 
                    document.getElementById('codeColor').value=t.color; 
                };
                area.appendChild(c);
            });
        }

        // --- Modal æ“ä½œ ---
        function openModal(text, existing=null) {
            const m = document.getElementById('editorModal');
            renderQuickTags();
            
            if(isReaderMode) {
                m.querySelectorAll('input,select,textarea').forEach(el=>el.disabled=true);
                m.querySelector('.btn-save').style.display='none';
                m.querySelector('.btn-delete').style.display='none';
            } else {
                m.querySelectorAll('input,select,textarea').forEach(el=>el.disabled=false);
                m.querySelector('.btn-save').style.display='block';
                m.querySelector('.btn-delete').style.display='block';
            }

            const isArea = currentSelection.type==='area';
            document.getElementById('quoteText').innerHTML = isArea ? `<span style="color:#dc3545">ğŸ–¼ï¸ åœ–è¡¨æ¨™è¨˜ (P.${currentSelection.page})</span>` : currentSelection.text;
            document.getElementById('codeName').placeholder = isArea ? "è¼¸å…¥åœ–è¡¨åç¨±" : "è¼¸å…¥éœ€æ±‚æ¨™ç±¤";

            if(existing) {
                // ç·¨è¼¯èˆŠæœ‰çš„
                document.getElementById('rtmId').value = existing.rtmId||'';
                document.getElementById('codeName').value = existing.code;
                document.getElementById('codeColor').value = existing.color;
                document.getElementById('rtmPriority').value = existing.priority||'Medium';
                document.getElementById('rtmStatus').value = existing.status||'New';
                document.getElementById('codeMemo').value = existing.memo;
                document.getElementById('modalTitle').querySelector('span').innerText = "âœï¸ ç·¨è¼¯";
                currentSelection.id = existing.id;
            } else {
                // æ–°å¢ï¼šä½¿ç”¨ Last Used Settings (è‡ªå‹•è¨˜æ†¶)
                document.getElementById('rtmId').value = '';
                document.getElementById('codeName').value = lastUsedSettings.code;
                document.getElementById('codeColor').value = lastUsedSettings.color;
                document.getElementById('rtmPriority').value = lastUsedSettings.priority;
                document.getElementById('rtmStatus').value = lastUsedSettings.status;
                document.getElementById('codeMemo').value = '';
                document.getElementById('modalTitle').querySelector('span').innerText = "ğŸ“ æ–°å¢";
            }

            m.style.display = 'flex';
            // è‡ªå‹• Focus åˆ° RTM ID (å¦‚æœå·²æœ‰ Tag) æˆ– Tag (å¦‚æœæ˜¯ç©ºçš„)
            setTimeout(() => {
                if(document.getElementById('codeName').value) document.getElementById('rtmId').focus();
                else document.getElementById('codeName').focus();
            }, 100);
        }

        function closeModal() { document.getElementById('editorModal').style.display = 'none'; }

        function confirmAnnotation() {
            if(isReaderMode) return closeModal();
            
            const name = document.getElementById('codeName').value || (currentSelection.type==='area'?'åœ–è¡¨':'æœªå‘½å');
            const color = document.getElementById('codeColor').value;
            const priority = document.getElementById('rtmPriority').value;
            const status = document.getElementById('rtmStatus').value;

            // æ›´æ–°è¨˜æ†¶
            lastUsedSettings = { code: name, color: color, priority: priority, status: status };

            const newData = {
                type: currentSelection.type, page: currentSelection.page, text: currentSelection.text, rect: currentSelection.rect,
                rtmId: document.getElementById('rtmId').value,
                code: name, color: color,
                priority: priority, status: status,
                memo: document.getElementById('codeMemo').value,
                timestamp: new Date().toISOString()
            };

            if(currentSelection.id) {
                const i = annotations.findIndex(a=>a.id===currentSelection.id);
                if(i!==-1) annotations[i] = {...annotations[i], ...newData};
            } else {
                annotations.push({ id:Date.now().toString(), ...newData });
            }
            renderSidebar(); saveToLocal(); closeModal(); renderCurrentBatch();
        }

        function deleteAnnotation() {
            if(!isReaderMode && currentSelection.id) {
                if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ¨™è¨»ï¼Ÿ")) {
                    annotations = annotations.filter(a=>a.id!==currentSelection.id);
                    renderSidebar(); saveToLocal(); closeModal(); renderCurrentBatch();
                }
            }
        }

        // --- å´é‚Šæ¬„ ---
        function renderSidebar() {
            const list = document.getElementById('sidebarList'); document.getElementById('count').innerText=annotations.length; list.innerHTML='';
            annotations.sort((a,b)=>a.page-b.page);
            annotations.forEach(a => {
                const d = document.createElement('div'); d.className='list-item';
                d.style.borderLeftColor = a.color;
                
                let pColor = '#ccc';
                if(a.priority === 'High') pColor = '#dc3545';
                if(a.priority === 'Low') pColor = '#28a745';
                if(a.priority === 'Medium') pColor = '#ffc107';

                const icon = a.type==='area'?'ğŸ–¼ï¸':'ğŸ“';
                d.innerHTML = `
                    <div style="display:flex;justify-content:space-between;font-size:0.85em;color:#888;">
                        <span>P.${a.page} ${icon}</span>
                        <span style="display:flex;align-items:center;">
                            <div class="priority-dot" style="background:${pColor}"></div>
                            ${a.rtmId||''} ${a.priority}
                        </span>
                    </div>
                    <div style="font-weight:bold;margin:4px 0;">${a.code}</div>
                    <div style="font-size:0.85em;color:#666;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">${a.type==='area'?'(ä½ç½®æ¨™è¨˜)':a.text}</div>
                `;
                d.onclick=()=>{
                    const tb = Math.floor((a.page-1)/BATCH_SIZE);
                    if(tb!==currentBatchIndex) { 
                        if(confirm(`è·³è½‰è‡³ P.${a.page}?`)){ 
                            currentBatchIndex=tb; 
                            renderCurrentBatch().then(()=>setTimeout(()=>scrollToAnnotation(a),600)); 
                        } 
                    }
                    else scrollToAnnotation(a);
                };
                list.appendChild(d);
            });
        }
        
        function scrollToAnnotation(a) {
            const el = document.querySelector(`.pdf-page[data-page-number="${a.page}"]`);
            if(el) { 
                el.scrollIntoView({behavior:'smooth'}); 
                // è§¸ç™¼é«˜äº®é–ƒçˆ
                if(a.type==='area'){ 
                    const ar=document.getElementById('area-'+a.id); 
                    if(ar){ 
                        ar.classList.add('highlight-flash'); 
                        setTimeout(()=>ar.classList.remove('highlight-flash'), 2000);
                    }
                } else {
                    // æ–‡å­—é¡å‹çš„é–ƒçˆç¨å¾®é›£ä¸€é»ï¼Œé€™è£¡ç°¡å–®è™•ç†
                    el.classList.add('highlight-flash');
                    setTimeout(()=>el.classList.remove('highlight-flash'), 2000);
                }
            }
        }

        // --- å­˜æª”èˆ‡åŒ¯å‡º ---
        function saveToLocal() { 
            if(!isReaderMode) {
                const data = { annotations: annotations, timestamp: Date.now() };
                localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
            }
        }

        function checkAutoSave() {
            const s = localStorage.getItem(AUTOSAVE_KEY);
            if(s) { 
                try{
                    const d = JSON.parse(s);
                    const dataList = Array.isArray(d) ? d : d.annotations;
                    const ts = Array.isArray(d) ? 0 : d.timestamp;
                    
                    if(dataList && dataList.length>0) {
                        const dateStr = ts ? new Date(ts).toLocaleString() : "æœªçŸ¥æ™‚é–“";
                        const isRecent = ts ? (Date.now() - ts < 86400000) : true;
                        if(isRecent && confirm(`ç™¼ç¾æœªå­˜æª”æ¨™è¨» (${dateStr})ï¼Œå…± ${dataList.length} ç­†ï¼Œæ˜¯å¦å¾©åŸ?`)) {
                            annotations=dataList; renderSidebar();
                        }
                    }
                }catch(e){}
            }
        }

        function clearAutoSave() { 
            if(confirm("ç¢ºå®šæ¸…é™¤å¿«å–ï¼Ÿé€™ä¸æœƒåˆªé™¤å·²ä¸‹è¼‰çš„æª”æ¡ˆã€‚")) {
                localStorage.removeItem(AUTOSAVE_KEY); annotations=[]; renderSidebar(); renderCurrentBatch(); 
            }
        }

        function saveProject() { 
            const d = { annotations, presets:tagPresets };
            download(JSON.stringify(d), `Project_${getDateStr()}.json`, 'application/json'); 
        }
        
        function handleProjectLoad(input) {
            const f=input.files[0]; if(!f)return;
            const r=new FileReader(); r.onload=e=>{
                const d=JSON.parse(e.target.result); annotations=d.annotations||[];
                if(d.presets) { tagPresets=d.presets; savePresets(); }
                renderSidebar(); saveToLocal(); alert("å°ˆæ¡ˆè¼‰å…¥æˆåŠŸï¼è«‹åŒ¯å…¥ PDFã€‚");
            }; r.readAsText(f); input.value='';
        }

        function exportReaderHtml() {
            if(annotations.length===0) return alert("ç„¡è³‡æ–™");
            let html = document.documentElement.outerHTML;
            const d = JSON.stringify({ annotations, presets:tagPresets });
            // ä½¿ç”¨ replace æ›´ç©©å®šçš„æ–¹å¼
            html = html.replace(/<script id="embedded-data" type="application\/json">.*?<\/script>/, `<script id="embedded-data" type="application/json">${d}<\/script>`);
            download(html, `Reader_Report_${getDateStr()}.html`, 'text/html');
        }
        
        function checkEmbeddedData() {
            const s=document.getElementById('embedded-data');
            if(s && s.textContent.trim()) {
                const d=JSON.parse(s.textContent); annotations=d.annotations||[];
                isReaderMode=true; document.body.classList.add('mode-read');
                renderSidebar(); alert("é–±è®€æ¨¡å¼é–‹å•Ÿï¼Œè«‹åŒ¯å…¥åŸå§‹ PDFã€‚");
            }
        }

        async function exportExcel() {
            if(annotations.length===0) return alert("ç„¡è³‡æ–™");
            const wb = new ExcelJS.Workbook(); const ws = wb.addWorksheet('RTM');
            
            ws.columns = [
                {header:'ID',key:'rtmId', width: 15},
                {header:'Page',key:'page', width: 8},
                {header:'Type',key:'type', width: 8},
                {header:'Tag',key:'code', width: 20},
                {header:'Priority',key:'priority', width: 12},
                {header:'Status',key:'status', width: 12},
                {header:'Text',key:'text', width: 50},
                {header:'Memo',key:'memo', width: 40}
            ];

            ws.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
            ws.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF444444' } };

            annotations.forEach(a => {
                const displayText = a.type === 'area' ? `(åœ–è¡¨å€åŸŸ) ${Math.round(a.rect.width)}x${Math.round(a.rect.height)}` : a.text;
                const row = ws.addRow({
                    rtmId: a.rtmId, page: a.page, type: a.type,
                    code: a.code, priority: a.priority, status: a.status,
                    text: displayText, memo: a.memo
                });
                
                if(a.color) {
                    const cleanColor = a.color.replace('#','');
                    row.getCell('code').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF'+cleanColor } };
                }
            });

            download(await wb.xlsx.writeBuffer(), `RTM_Report_${getDateStr()}.xlsx`, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        }

        function download(content, name, type) { const b=new Blob([content],{type}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=name; a.click(); }
        function setMode(m) { editMode=m; document.getElementById('modeText').classList.toggle('active', m==='text'); document.getElementById('modeArea').classList.toggle('active', m==='area'); document.querySelectorAll('.pdf-page').forEach(p=>p.style.cursor=m==='text'?'text':'crosshair'); }
        function showLoader(t) { document.getElementById('loader').style.display='flex'; document.getElementById('loaderText').innerText=t; }
        function hideLoader() { document.getElementById('loader').style.display='none'; }
        function getDateStr() { return new Date().toISOString().slice(0,10); }

        function prevBatch() { if(currentBatchIndex>0) { currentBatchIndex--; renderCurrentBatch(); } }
        function nextBatch() { if(currentBatchIndex<totalBatches-1) { currentBatchIndex++; renderCurrentBatch(); } }
        function updateNavUI(s, e) {
            if(pdfDoc) {
                document.getElementById('batchInfo').innerText = `Page ${s} - ${e} / ${pdfDoc.numPages}`;
                document.getElementById('btnPrev').disabled = currentBatchIndex===0; document.getElementById('btnPrev').style.opacity = currentBatchIndex===0?.5:1;
                document.getElementById('btnNext').disabled = currentBatchIndex>=totalBatches-1; document.getElementById('btnNext').style.opacity = currentBatchIndex>=totalBatches-1?.5:1;
            }
        }
    </script>
</body>
</html>
