<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF é–±è®€åœ°åœ– (Ultimate V7.1)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <style>
        /* --- 1. åŸºç¤ä½ˆå±€ --- */
        body { margin: 0; padding: 0; background: #333; font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* --- 2. å·¥å…·åˆ— --- */
        .toolbar { background: #222; color: white; padding: 10px 20px; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 100; flex-shrink: 0; flex-wrap: wrap; }
        .reader-toolbar { background: #202b38; color: white; padding: 15px 20px; display: none; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 101; flex-shrink: 0; }
        h1 { margin: 0; font-size: 1.1em; color: #fff; margin-right: 10px; display:flex; align-items:center; gap:5px; user-select: none; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; background: #444; color: white; transition: 0.2s; white-space: nowrap; font-size: 0.9em; display: inline-flex; align-items: center; gap: 4px; }
        button:hover { background: #666; transform: translateY(-1px); }
        button.primary { background: #28a745; } button.primary:hover { background: #218838; }
        button.export { background: #17a2b8; }
        button.info { background: #138496; }
        button.warning { background: #ffc107; color: #333; }
        button.danger { background: #dc3545; }
        
        .mode-switch { display: flex; background: #444; border-radius: 20px; padding: 2px; border: 1px solid #555; margin-right: 10px; }
        .mode-btn { padding: 4px 12px; border-radius: 15px; cursor: pointer; font-size: 0.85em; color: #ccc; transition: 0.2s; user-select: none; }
        .mode-btn.active { background: #007bff; color: white; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        .search-box { display: flex; align-items: center; background: white; border-radius: 4px; overflow: hidden; margin-left: auto; }
        .search-input { border: none; padding: 6px 10px; outline: none; font-size: 0.9em; width: 140px; color:#333; }
        .search-btn { background: #ffc107; color: #333; border-radius: 0; padding: 6px 10px; }
        .search-btn:hover { background: #e0a800; }

        /* --- 3. å·¥ä½œå€ --- */
        .workspace { display: flex; flex: 1; overflow: hidden; position: relative; }
        #viewerContainer { flex: 1; overflow-y: auto; position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; padding-bottom: 120px; background: #525659; user-select: none; }
        
        .pdf-page { position: relative; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); background: white; cursor: crosshair; }
        .selection-marquee { position: absolute; border: 2px dashed #007bff; background-color: rgba(0, 123, 255, 0.2); pointer-events: none; z-index: 100; }
        .textLayer { opacity: 1; line-height: 1.0; }
        .textLayer span { color: transparent; position: absolute; white-space: pre; cursor: crosshair; }
        
        .highlight-text { background-color: rgba(255, 235, 59, 0.4); border-bottom: 2px solid #e6a800; cursor: pointer; }
        .highlight-area { position: absolute; border: 3px solid #dc3545; background-color: rgba(220, 53, 69, 0.1); cursor: pointer; z-index: 50; transition: 0.2s; }
        .highlight-area:hover { background-color: rgba(220, 53, 69, 0.3); }
        .highlight-flash { animation: flash 1s ease-in-out; }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; background-color: red; } }
        
        /* --- 4. å´é‚Šæ¬„èˆ‡ç¯©é¸å™¨ --- */
        .sidebar { width: 320px; background: #f8f9fa; border-left: 1px solid #ccc; display: flex; flex-direction: column; z-index: 90; }
        .sidebar-header { padding: 10px; background: white; border-bottom: 1px solid #ddd; display:flex; flex-direction:column; gap:8px; }
        .sidebar-filter { width: 100%; padding: 5px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 4px; }
        .sidebar-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .list-item { background: white; padding: 10px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; border-left: 5px solid #ccc; transition:0.2s; position: relative; padding-right: 50px; }
        .list-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); background-color: #fafafa; }
        .item-actions { position: absolute; top: 5px; right: 5px; display: flex; flex-direction: column; gap: 2px; }
        .icon-btn { width: 24px; height: 24px; border: none; background: transparent; border-radius: 4px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 14px; color: #666; transition: 0.2s; }
        .icon-btn:hover { background: #eee; color: #000; }
        .btn-edit:hover { color: #007bff; background: #e7f1ff; }
        .btn-del:hover { color: #dc3545; background: #ffeeee; }

        /* --- 5. æœå°‹é¢æ¿ --- */
        #searchPanel { position: absolute; top: 60px; right: 340px; width: 320px; max-height: 500px; background: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: none; flex-direction: column; z-index: 2000; }
        .search-header { padding: 10px; background: #f1f3f5; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; font-weight: bold; color:#333; }
        .search-results { overflow-y: auto; padding: 5px; flex:1; }
        .search-item { padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 0.9em; display:flex; gap:10px; align-items:center; justify-content:space-between; }
        .search-item:hover { background: #f8f9fa; }
        .search-tag { background: #e9ecef; color: #333; border: 1px solid #ced4da; font-size: 0.8em; padding: 4px 10px; border-radius: 15px; cursor:pointer; }
        .search-tag:hover { background: #007bff; color: white; border-color: #007bff; }

        /* --- 6. åº•éƒ¨å°è¦½ --- */
        .floating-nav { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(33, 37, 41, 0.95); padding: 8px 15px; border-radius: 50px; display: flex; gap: 15px; align-items: center; color: white; box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 200; backdrop-filter: blur(4px); border: 1px solid #555; }
        
        /* --- 7. Modal é€šç”¨ --- */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); display:none; z-index:3000; justify-content: flex-end; align-items: center; }
        .modal-card { background:white; width:450px; padding:20px; border-radius:12px 0 0 12px; display:flex; flex-direction:column; gap:12px; box-shadow: -5px 0 30px rgba(0,0,0,0.3); height: 95vh; margin-right: 0; overflow-y: auto; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        input, select { width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; box-sizing:border-box; font-family: inherit; }
        .preview-box { background:#f0f0f0; padding:10px; font-size:0.9em; max-height:150px; overflow-y:auto; border-radius:4px; margin-bottom:10px; display:flex; justify-content:center; align-items:center; }
        .preview-box img { max-width: 100%; max-height: 130px; border: 1px solid #ccc; }
        .memo-toolbar { display: flex; gap: 5px; margin-bottom: 5px; background: #eee; padding: 5px; border-radius: 4px; }
        .memo-btn { font-size: 0.8em; padding: 3px 8px; background: white; color: #333; border: 1px solid #ccc; }
        .rich-memo { width: 100%; min-height: 100px; max-height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; overflow-y: auto; background: white; line-height: 1.5; font-size: 0.95em; }
        .rich-memo:focus { outline: 2px solid #007bff; border-color: transparent; }
        .custom-fields-area { border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 5px; }
        
        #settingsModal { justify-content: center; }
        #settingsModal .modal-card { width: 600px; border-radius: 12px; height: auto; max-height: 85vh; margin-right: 0; }
        
        #globalMemoModal { justify-content: center; }
        #globalMemoModal .modal-card { width: 600px; border-radius: 12px; height: 70vh; margin-right: 0; }

        /* é è¦½è¡¨æ ¼ Modal */
        #previewModal { justify-content: center; align-items: center; }
        #previewModal .modal-card { width: 90%; max-width: 1200px; border-radius: 12px; margin-right: 0; height: 90vh; }
        .preview-table-container { flex: 1; overflow: auto; border: 1px solid #eee; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        .data-table th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; font-weight: bold; color: #333; }
        .data-table tr:nth-child(even) { background-color: #f9f9f9; }
        .data-table tr:hover { background-color: #f1f1f1; }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 4000; }
        .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom:15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        body.mode-read .toolbar { display: none; }
        body.mode-read .reader-toolbar { display: flex; }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div><h3 id="loaderText">è™•ç†ä¸­...</h3></div>

    <div class="toolbar" id="editToolbar">
        <h1>ğŸ› ï¸ é–±è®€åœ°åœ– <span style="font-size:0.5em; opacity:0.6;">V7.1</span></h1>
        
        <div class="mode-switch">
            <div class="mode-btn active" id="modeText" onclick="setMode('text')">ğŸ“ æŠ“æ–‡å­—</div>
            <div class="mode-btn" id="modeArea" onclick="setMode('area')">ğŸ–¼ï¸ æ¡†åœ–è¡¨</div>
        </div>

        <button onclick="openSettings()">âš™ï¸ è¨­å®š</button>
        <button class="warning" onclick="openGlobalMemo()">ğŸ’¡ éˆæ„Ÿ</button>

        <button onclick="document.getElementById('pdfInput').click()">ğŸ“‚ PDF</button>
        <input type="file" id="pdfInput" accept="application/pdf" style="display:none" onchange="handlePdfUpload(this)">
        <button onclick="document.getElementById('projectInput').click()">ğŸ“¥ å°ˆæ¡ˆ</button>
        <input type="file" id="projectInput" accept=".json" style="display:none" onchange="handleProjectLoad(this)">
        
        <div style="flex:1"></div> 
        
        <button class="primary" onclick="saveProject()">ğŸ’¾ å­˜æª”</button>
        <button class="export" onclick="exportReaderHtml()">ğŸ“¦ æ‰“åŒ…</button>
        <button class="info" onclick="openDataPreview()">ğŸ‘€ é è¦½</button>
        <button class="danger" onclick="exportExcel()">ğŸ“Š Excel</button>

        <div class="search-box">
            <input type="text" id="globalSearchInput" class="search-input" placeholder="å…¨åŸŸæœå°‹..." onkeydown="if(event.key==='Enter') performGlobalSearch()">
            <button class="search-btn" onclick="performGlobalSearch()">ğŸ”</button>
        </div>
    </div>

    <div class="reader-toolbar" id="readToolbar">
        <div style="display:flex; align-items:center; gap:15px;">
            <h1 style="color:#28a745;">ğŸ“– æˆæœé–±è®€å™¨</h1>
            <span style="font-size:0.9em; color:#bbb;" id="readerFileName">å°šæœªè¼‰å…¥æ–‡ä»¶...</span>
        </div>
        <div>
            <button class="primary" onclick="document.getElementById('readerPdfInput').click()">ğŸ“‚ é–‹å•ŸåŸå§‹ PDF</button>
            <input type="file" id="readerPdfInput" accept="application/pdf" style="display:none" onchange="handlePdfUpload(this)">
        </div>
    </div>

    <div class="workspace">
        <div id="viewerContainer">
            <div style="margin-top:100px; color:#aaa; text-align:center;" id="placeholder">
                <h3>è«‹åŒ¯å…¥ PDF</h3>
                <p>åŠŸèƒ½å‡ç´šï¼šè·¨è£ç½®é€²åº¦è¨˜æ†¶ã€æ•¸æ“šé è¦½ã€å…¨åŸŸç­†è¨˜</p>
            </div>
            <div id="searchPanel">
                <div class="search-header">
                    <span>âš¡ é€ŸæŸ¥é€Ÿæ¨™</span>
                    <span style="cursor:pointer; font-size:1.2em;" onclick="closeSearch()">Ã—</span>
                </div>
                <div style="padding:10px; background:#f8f9fa; border-bottom:1px solid #eee; display:flex; gap:5px; flex-wrap:wrap;">
                    <button class="search-tag" onclick="searchKeyword('äº¤ä»˜')">äº¤ä»˜</button>
                    <button class="search-tag" onclick="searchKeyword('é©—æ”¶')">é©—æ”¶</button>
                    <button class="search-tag" onclick="searchKeyword('ç½°å‰‡')">ç½°å‰‡</button>
                    <button class="search-tag" onclick="searchKeyword('è³‡å®‰')">è³‡å®‰</button>
                </div>
                <div class="search-results" id="searchResultsList"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:bold;">ç´¢å¼•åˆ—è¡¨ (<span id="count">0</span>)</span>
                    <button style="font-size:0.75em; padding:2px 6px; background:#6c757d;" onclick="clearAutoSave()">æ¸…ç©ºåˆ—è¡¨</button>
                </div>
                <select class="sidebar-filter" id="sidebarFilter" onchange="renderSidebar()">
                    <option value="all">é¡¯ç¤ºå…¨éƒ¨</option>
                    <option value="High">ğŸ”´ åªé¡¯ç¤º High</option>
                    <option value="Pending">ğŸ•’ åªé¡¯ç¤º Pending</option>
                    <option value="Image">ğŸ–¼ï¸ åªé¡¯ç¤ºåœ–ç‰‡</option>
                </select>
            </div>
            <div class="sidebar-list" id="sidebarList"></div>
        </div>
    </div>

    <div class="floating-nav" id="bottomNav" style="display:none;">
        <button id="btnPrev" onclick="prevBatch()" style="border-radius:20px; padding:6px 15px;">â¬…</button>
        <select id="jumpSelect" onchange="jumpToBatch(this.value)" style="width:auto; padding:4px; background:#333; color:white; border:none; margin:0 5px;">
            <option value="0">Page 1 - ...</option>
        </select>
        <button id="btnNext" onclick="nextBatch()" style="border-radius:20px; padding:6px 15px;" class="primary">â¡</button>
        <div style="width:1px; height:15px; background:#666; margin:0 5px;"></div>
        <select id="batchSizeSelect" onchange="changeBatchSize()" style="width:auto; padding:4px; font-size:0.85em; background:#333; color:white; border:none;">
            <option value="10">10 é </option>
            <option value="20">20 é </option>
            <option value="50">50 é </option>
        </select>
    </div>

    <div class="modal" id="editorModal">
        <div class="modal-card">
            <h3 id="modalTitle" style="margin:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ–ï¸ ç·¨è¼¯æ¨™è¨»</h3>
            <label style="font-size:0.8em; color:#666; margin-top:10px;">å…§å®¹é è¦½</label>
            <div id="quotePreview" class="preview-box"></div>

            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>RTM ID</label>
                    <input type="text" id="rtmId" placeholder="ä¾‹: REQ-001">
                </div>
                <div style="flex:2">
                    <label>åˆ†é¡æ¨™ç±¤ (Tag)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="codeName" placeholder="è¼¸å…¥æˆ–é¸ä¸‹æ–¹...">
                        <input type="color" id="codeColor" value="#ffeb3b" style="height:35px; width:40px; padding:0; border:none; cursor:pointer;">
                    </div>
                </div>
            </div>
            
            <div id="quickTagArea" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
            <div id="customFieldsContainer" class="custom-fields-area" style="display:none;"></div>

            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>å„ªå…ˆç´š</label>
                    <select id="rtmPriority">
                        <option value="High">ğŸ”´ High</option>
                        <option value="Medium">ğŸŸ¡ Medium</option>
                        <option value="Low">ğŸŸ¢ Low</option>
                    </select>
                </div>
                <div style="flex:1">
                    <label>ç‹€æ…‹</label>
                    <select id="rtmStatus">
                        <option value="New">New</option>
                        <option value="Pending">Pending</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
            </div>

            <div>
                <label>ç­†è¨˜ (Memo)</label>
                <div class="memo-toolbar">
                    <button class="memo-btn" onclick="memoExec('hilite')">ğŸ–Šï¸ è¢å…‰ç­†</button>
                    <button class="memo-btn" onclick="memoExec('checkbox')">â˜‘ï¸ å¾…è¾¦</button>
                    <button class="memo-btn" onclick="memoExec('clear')">ğŸ§¹ æ¸…æ ¼å¼</button>
                </div>
                <div id="codeMemo" class="rich-memo" contenteditable="true"></div>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:auto; border-top:1px solid #eee; padding-top:15px;">
                <button onclick="closeModal()">å–æ¶ˆ (Esc)</button>
                <button class="primary btn-save" onclick="confirmAnnotation()">ç¢ºå®š (Enter)</button>
            </div>
        </div>
    </div>

    <div class="modal" id="globalMemoModal">
        <div class="modal-card">
            <h3 style="margin:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ’¡ å…¨å±€éˆæ„Ÿç­†è¨˜ (Global Scratchpad)</h3>
            <div class="memo-toolbar">
                <button class="memo-btn" onclick="globalMemoExec('hilite')">ğŸ–Šï¸ è¢å…‰ç­†</button>
                <button class="memo-btn" onclick="globalMemoExec('checkbox')">â˜‘ï¸ å¾…è¾¦</button>
                <button class="memo-btn" onclick="globalMemoExec('clear')">ğŸ§¹ æ¸…æ ¼å¼</button>
            </div>
            <div id="globalMemoEditor" class="rich-memo" style="flex:1;" contenteditable="true"></div>
            <div style="text-align:right; margin-top:20px;">
                <button class="primary" onclick="saveGlobalMemo()">å„²å­˜ä¸¦é—œé–‰</button>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-card">
            <h3 style="margin:0;">âš™ï¸ ç³»çµ±è¨­å®š</h3>
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:#e9ecef; padding:10px; border-radius:5px;">
                <span>ğŸ“‹ æ¨£æ¿ç®¡ç†</span>
                <div>
                    <button class="info" style="font-size:0.8em;" onclick="saveAsTemplate()">å­˜ç‚ºé è¨­æ¨£æ¿</button>
                    <button class="warning" style="font-size:0.8em;" onclick="loadFromTemplate()">è¼‰å…¥æ¨£æ¿</button>
                </div>
            </div>

            <h4 style="margin-bottom:5px; border-bottom:2px solid #eee;">1. å¸¸ç”¨æ¨™ç±¤</h4>
            <div style="background:#f8f9fa; padding:10px; border-radius:8px; display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="newTagName" placeholder="åç¨±..." style="flex:1">
                <input type="color" id="newTagColor" value="#17a2b8" style="width:40px; border:none; height:36px;">
                <button class="primary" onclick="addPreset()">æ–°å¢</button>
            </div>
            <div id="presetList" style="max-height:100px; overflow-y:auto; border:1px solid #eee; padding:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>

            <h4 style="margin-top:15px; margin-bottom:5px; border-bottom:2px solid #eee;">2. è‡ªè¨‚ Excel æ¬„ä½</h4>
            <div style="background:#f0f8ff; padding:10px; border-radius:8px; display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="newFieldKey" placeholder="ä»£ç¢¼ (ä¾‹: date)" style="flex:1">
                <input type="text" id="newFieldLabel" placeholder="åç¨± (ä¾‹: æ—¥æœŸ)" style="flex:1">
                <button class="primary" onclick="addCustomField()">æ–°å¢</button>
            </div>
            <div id="customFieldList" style="max-height:100px; overflow-y:auto; border:1px solid #eee; padding:10px;"></div>

            <div style="margin-top:20px; padding-top:10px; border-top:1px solid #ccc; display:flex; justify-content:space-between;">
                <button class="danger" onclick="resetAllData()">âš ï¸ é‡ç½®ç³»çµ± (æ¸…ç©ºå¿«å–)</button>
                <button onclick="document.getElementById('settingsModal').style.display='none'">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div class="modal" id="previewModal">
        <div class="modal-card">
            <h3 style="margin:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ‘€ æ•¸æ“šé è¦½</h3>
            <div class="preview-table-container"><div id="previewContent"></div></div>
            <div style="text-align:right; margin-top:20px;"><button onclick="document.getElementById('previewModal').style.display='none'">é—œé–‰</button></div>
        </div>
    </div>

    <script id="embedded-data" type="application/json"></script>

    <script>
        // --- 1. å…¨åŸŸè®Šæ•¸ ---
        let pdfDoc = null; let annotations = []; let BATCH_SIZE = 10; let currentBatchIndex = 0; let totalBatches = 0;
        let currentSelection = null; let editMode = 'text'; let isReaderMode = false;
        let globalMemo = ""; 
        let lastUsedSettings = { code: '', color: '#ffeb3b', priority: 'Medium', status: 'New' };
        let customFields = [];
        const AUTOSAVE_KEY = 'pdf_ult_v7_autosave'; 
        const TEMPLATE_KEY = 'pdf_ult_v7_template'; 
        let tagPresets = [{ name: "åŠŸèƒ½éœ€æ±‚", color: "#ffc107" }, { name: "è³‡å®‰è¦ç¯„", color: "#dc3545" }];

        window.onload = function() {
            loadFromTemplate(true); // å˜—è©¦è¼‰å…¥æ¨£æ¿
            checkEmbeddedData(); 
            if(!isReaderMode) checkAutoSave();
            
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') { 
                    ['editorModal','settingsModal','previewModal','searchPanel','globalMemoModal'].forEach(id => document.getElementById(id).style.display='none');
                }
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { 
                    if(document.getElementById('editorModal').style.display === 'flex') confirmAnnotation(); 
                }
            });
        };

        // --- PDF æ ¸å¿ƒ ---
        async function handlePdfUpload(input) {
            const file = input.files[0]; if(!file) return;
            showLoader("æ­£åœ¨è§£æ PDF...");
            if(isReaderMode) document.getElementById('readerFileName').innerText = file.name;
            try {
                const buffer = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument(buffer).promise;
                
                // å„ªå…ˆä½¿ç”¨ JSON è¼‰å…¥çš„é€²åº¦ï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨ LocalStorageï¼Œæœ€å¾Œæ‰æ­¸é›¶
                if(currentBatchIndex === 0 && localStorage.getItem('last_batch_idx')) {
                    currentBatchIndex = parseInt(localStorage.getItem('last_batch_idx'));
                }
                
                calculateBatches();
                document.getElementById('placeholder').style.display = 'none';
                document.getElementById('bottomNav').style.display = 'flex';
                await renderCurrentBatch();
            } catch(e) { alert("è®€å–å¤±æ•—"); console.error(e); } finally { hideLoader(); input.value=''; }
        }

        function calculateBatches() { 
            totalBatches = Math.ceil(pdfDoc.numPages / BATCH_SIZE);
            const select = document.getElementById('jumpSelect'); select.innerHTML = '';
            for(let i=0; i<totalBatches; i++) {
                const s = i * BATCH_SIZE + 1; const e = Math.min((i+1) * BATCH_SIZE, pdfDoc.numPages);
                const opt = document.createElement('option'); opt.value = i; opt.text = `ç¬¬ ${s} - ${e} é `; select.appendChild(opt);
            }
            if(currentBatchIndex >= totalBatches) currentBatchIndex = 0; 
            updateNavUI(); 
        }
        function changeBatchSize() { BATCH_SIZE = parseInt(document.getElementById('batchSizeSelect').value); currentBatchIndex=0; calculateBatches(); renderCurrentBatch(); }
        function jumpToBatch(val) { currentBatchIndex = parseInt(val); renderCurrentBatch(); }

        async function renderCurrentBatch() {
            if(!pdfDoc) return;
            showLoader("è¼‰å…¥é é¢ä¸­...");
            if(!isReaderMode) localStorage.setItem('last_batch_idx', currentBatchIndex); // å­˜å…¥ç€è¦½å™¨å¿«å–
            
            document.querySelectorAll('.pdf-page').forEach(p => p.remove());
            const start = (currentBatchIndex * BATCH_SIZE) + 1; const end = Math.min(start + BATCH_SIZE - 1, pdfDoc.numPages);
            document.getElementById('jumpSelect').value = currentBatchIndex; updateNavUI();
            for(let i=start; i<=end; i++) await renderPage(i);
            hideLoader(); document.getElementById('viewerContainer').scrollTop = 0;
        }

        async function renderPage(num) {
            const page = await pdfDoc.getPage(num); const viewport = page.getViewport({ scale: 1.5 });
            const div = document.createElement('div'); div.className='pdf-page'; 
            div.style.width=`${viewport.width}px`; div.style.height=`${viewport.height}px`; div.dataset.pageNumber=num;
            div.style.cursor = editMode === 'text' ? 'text' : 'crosshair';
            const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
            cvs.width=viewport.width; cvs.height=viewport.height;
            const textLayer = document.createElement('div'); textLayer.className='textLayer';
            textLayer.style.width=`${viewport.width}px`; textLayer.style.height=`${viewport.height}px`;
            div.append(cvs, textLayer); document.getElementById('viewerContainer').appendChild(div);
            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            const content = await page.getTextContent();
            pdfjsLib.renderTextLayer({ textContent: content, container: textLayer, viewport: viewport, textDivs: [] });
            if(!isReaderMode) enableBoxSelection(div, num);
            restoreHighlights(num, div);
        }

        // --- äº’å‹• (Magic Box) ---
        let isDrawing = false, startX, startY, marquee = null, activePageElement = null;
        function enableBoxSelection(pageDiv, pageNum) {
            pageDiv.addEventListener('mousedown', (e) => {
                if(e.target.closest('.highlight-text') || e.target.closest('.highlight-area')) return;
                isDrawing = true; activePageElement = pageDiv;
                const rect = pageDiv.getBoundingClientRect(); startX = e.clientX - rect.left; startY = e.clientY - rect.top;
                marquee = document.createElement('div'); marquee.className = 'selection-marquee';
                marquee.style.left = startX + 'px'; marquee.style.top = startY + 'px'; pageDiv.appendChild(marquee);
            });
            pageDiv.addEventListener('mousemove', (e) => {
                if (!isDrawing || activePageElement !== pageDiv) return;
                const rect = pageDiv.getBoundingClientRect();
                const curX = e.clientX - rect.left; const curY = e.clientY - rect.top;
                marquee.style.width = Math.abs(curX - startX) + 'px'; marquee.style.height = Math.abs(curY - startY) + 'px';
                marquee.style.left = Math.min(curX, startX) + 'px'; marquee.style.top = Math.min(curY, startY) + 'px';
            });
            pageDiv.addEventListener('mouseup', (e) => {
                if (!isDrawing || activePageElement !== pageDiv) return; isDrawing = false;
                const mRect = { left: parseFloat(marquee.style.left), top: parseFloat(marquee.style.top), width: parseFloat(marquee.style.width), height: parseFloat(marquee.style.height) };
                if (mRect.width > 5 && mRect.height > 5) {
                    if (editMode === 'text') {
                        const spans = pageDiv.querySelectorAll('.textLayer span'); let captured = "";
                        const mR = mRect.left + mRect.width; const mB = mRect.top + mRect.height;
                        let hitSpans = [];
                        spans.forEach(s => { if (!(s.offsetLeft+s.offsetWidth < mRect.left || s.offsetLeft > mR || s.offsetTop+s.offsetHeight < mRect.top || s.offsetTop > mB)) hitSpans.push(s); });
                        hitSpans.sort((a,b) => (Math.abs(a.offsetTop - b.offsetTop) < 10) ? a.offsetLeft - b.offsetLeft : a.offsetTop - b.offsetTop);
                        hitSpans.forEach(s => captured += s.innerText + " ");
                        if(captured.trim()) { currentSelection = { id:null, type:'text', page:pageNum, text:captured.trim(), rect:null }; openModal(); }
                    } else {
                        const canvas = pageDiv.querySelector('canvas'); const tempCvs = document.createElement('canvas');
                        tempCvs.width = mRect.width; tempCvs.height = mRect.height;
                        tempCvs.getContext('2d').drawImage(canvas, mRect.left, mRect.top, mRect.width, mRect.height, 0, 0, mRect.width, mRect.height);
                        currentSelection = { id:null, type:'area', page:pageNum, text:'[åœ–ç‰‡æ¨™è¨˜]', rect:mRect, imageData: tempCvs.toDataURL() }; openModal();
                    }
                }
                marquee.remove();
            });
        }

        // --- å…¨å±€ç­†è¨˜ (Global Memo) ---
        function openGlobalMemo() {
            document.getElementById('globalMemoEditor').innerHTML = globalMemo;
            document.getElementById('globalMemoModal').style.display = 'flex';
        }
        function saveGlobalMemo() {
            globalMemo = document.getElementById('globalMemoEditor').innerHTML;
            saveToLocal(); 
            document.getElementById('globalMemoModal').style.display = 'none';
        }
        function globalMemoExec(cmd) {
            document.getElementById('globalMemoEditor').focus();
            document.execCommand(cmd === 'hilite' ? 'hiliteColor' : (cmd==='checkbox'?'insertHTML':'removeFormat'), false, cmd==='hilite'?'#ffeb3b':(cmd==='checkbox'?'&#x2610; ':null)); 
        }

        // --- æœå°‹ ---
        function searchKeyword(k) { document.getElementById('globalSearchInput').value=k; performGlobalSearch(); }
        async function performGlobalSearch() {
            if(!pdfDoc) return;
            const q = document.getElementById('globalSearchInput').value.trim(); if(!q) return;
            const list = document.getElementById('searchResultsList');
            document.getElementById('searchPanel').style.display='flex';
            list.innerHTML='<div style="text-align:center;padding:10px;">æœå°‹ä¸­...</div>';
            let res = [];
            for(let i=1; i<=pdfDoc.numPages; i++) {
                const p = await pdfDoc.getPage(i); const c = await p.getTextContent();
                const t = c.items.map(x=>x.str).join('');
                if(t.toLowerCase().includes(q.toLowerCase())) {
                    const idx = t.toLowerCase().indexOf(q.toLowerCase());
                    res.push({page:i, snippet: t.substring(idx-10, idx+25)});
                }
                if(i % 10 === 0) await new Promise(r => setTimeout(r,0));
            }
            list.innerHTML = res.length ? '' : '<div style="text-align:center;">ç„¡çµæœ</div>';
            res.forEach(r => {
                const d = document.createElement('div'); d.className='search-item';
                d.innerHTML = `<span>P.${r.page} ...${r.snippet}...</span><button class="danger" style="font-size:0.7em;padding:2px 6px;">ğŸ“Œ æ¨™è¨˜</button>`;
                d.querySelector('span').onclick = () => jumpToPage(r.page);
                d.querySelector('button').onclick = (e) => { e.stopPropagation(); quickMark(r.page, r.snippet); e.target.innerText='âœ”'; e.target.disabled=true; e.target.className='primary'; };
                list.appendChild(d);
            });
        }
        function closeSearch() { document.getElementById('searchPanel').style.display='none'; }
        function quickMark(page, text) {
            const id = Date.now().toString();
            annotations.push({ id, type:'text', page, text, rect:null, code:'é‡é»é€Ÿæ¨™', color:'#dc3545', rtmId:'-', priority:'High', status:'New', memo:'æœå°‹æ¨™è¨˜', timestamp:new Date().toISOString() });
            renderSidebar(); saveToLocal();
        }
        function jumpToPage(p) {
            const tb = Math.floor((p-1)/BATCH_SIZE);
            if(tb !== currentBatchIndex) { currentBatchIndex=tb; renderCurrentBatch().then(()=>setTimeout(()=>scrollToP(p),500)); }
            else scrollToP(p);
        }
        function scrollToP(p) { const el=document.querySelector(`.pdf-page[data-page-number="${p}"]`); if(el) el.scrollIntoView({behavior:'smooth'}); }

        // --- ç·¨è¼¯ Modal ---
        function openModal(existing=null) {
            const m = document.getElementById('editorModal');
            renderQuickTags(); renderCustomFieldsInModal(existing ? existing.customData : null);
            if(isReaderMode) {
                m.querySelectorAll('input,select').forEach(el=>el.disabled=true); document.getElementById('codeMemo').contentEditable="false"; m.querySelector('.btn-save').style.display='none';
            } else {
                m.querySelectorAll('input,select').forEach(el=>el.disabled=false); document.getElementById('codeMemo').contentEditable="true"; m.querySelector('.btn-save').style.display='block';
            }
            const pv = document.getElementById('quotePreview');
            if(currentSelection.type === 'area' && currentSelection.imageData) pv.innerHTML = `<img src="${currentSelection.imageData}">`;
            else pv.innerHTML = currentSelection.text || '(ç„¡å…§å®¹)';

            if(existing) {
                document.getElementById('rtmId').value = existing.rtmId||''; document.getElementById('codeName').value = existing.code;
                document.getElementById('codeColor').value = existing.color; document.getElementById('rtmPriority').value = existing.priority||'Medium';
                document.getElementById('rtmStatus').value = existing.status||'New'; document.getElementById('codeMemo').innerHTML = existing.memo;
                currentSelection.id = existing.id;
            } else {
                document.getElementById('rtmId').value = ''; document.getElementById('codeName').value = lastUsedSettings.code;
                document.getElementById('codeColor').value = lastUsedSettings.color; document.getElementById('rtmPriority').value = lastUsedSettings.priority;
                document.getElementById('rtmStatus').value = lastUsedSettings.status; document.getElementById('codeMemo').innerHTML = '';
            }
            m.style.display = 'flex';
        }
        function closeModal() { document.getElementById('editorModal').style.display = 'none'; }
        function memoExec(cmd) { document.getElementById('codeMemo').focus(); document.execCommand(cmd === 'hilite' ? 'hiliteColor' : (cmd==='checkbox'?'insertHTML':'removeFormat'), false, cmd==='hilite'?'#ffeb3b':(cmd==='checkbox'?'&#x2610; ':null)); }
        function renderCustomFieldsInModal(data={}) {
            const c = document.getElementById('customFieldsContainer'); c.innerHTML='';
            if(customFields.length>0) {
                c.style.display='block';
                customFields.forEach(f => {
                    const w = document.createElement('div'); w.style.marginTop='8px';
                    w.innerHTML=`<label style="font-size:0.9em;color:#666;">${f.label}</label>`;
                    const i = document.createElement('input'); i.type='text'; i.dataset.key=f.key; i.value=(data&&data[f.key])?data[f.key]:'';
                    w.appendChild(i); c.appendChild(w);
                });
            } else c.style.display='none';
        }
        function confirmAnnotation() {
            if(isReaderMode) return closeModal();
            const name = document.getElementById('codeName').value || (currentSelection.type==='area'?'åœ–ç‰‡':'æœªå‘½å');
            const color = document.getElementById('codeColor').value; const priority = document.getElementById('rtmPriority').value; const status = document.getElementById('rtmStatus').value;
            let cData = {}; document.querySelectorAll('#customFieldsContainer input').forEach(i => cData[i.dataset.key] = i.value);
            lastUsedSettings = { code: name, color, priority, status };
            const newData = {
                type: currentSelection.type, page: currentSelection.page, text: currentSelection.text, rect: currentSelection.rect, imageData: currentSelection.imageData,
                rtmId: document.getElementById('rtmId').value, code: name, color, priority, status, memo: document.getElementById('codeMemo').innerHTML,
                customData: cData, timestamp: new Date().toISOString()
            };
            if(currentSelection.id) {
                const i = annotations.findIndex(a=>a.id===currentSelection.id);
                if(i!==-1) annotations[i] = {...annotations[i], ...newData};
            } else annotations.push({ id:Date.now().toString(), ...newData });
            renderSidebar(); saveToLocal(); closeModal(); renderCurrentBatch();
        }

        // --- é è¦½èˆ‡å´é‚Šæ¬„ ---
        function openDataPreview() {
            if(annotations.length === 0) return alert("ç›®å‰æ²’æœ‰è³‡æ–™å¯ä»¥é è¦½");
            let html = '<table class="data-table"><thead><tr>';
            const headers = ['ID', 'Page', 'Tag', 'Priority', 'Status', 'Text/Content'];
            customFields.forEach(f => headers.push(f.label)); headers.push('Memo');
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            annotations.forEach(a => {
                html += '<tr>';
                html += `<td>${a.rtmId || ''}</td><td>${a.page}</td><td>${a.code}</td><td>${a.priority}</td><td>${a.status}</td>`;
                html += `<td>${a.type==='area' ? '[åœ–ç‰‡]' : a.text}</td>`;
                customFields.forEach(f => { html += `<td>${(a.customData && a.customData[f.key]) ? a.customData[f.key] : ''}</td>`; });
                html += `<td>${a.memo}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('previewContent').innerHTML = html;
            document.getElementById('previewModal').style.display = 'flex';
        }

        function renderSidebar() {
            const list = document.getElementById('sidebarList'); document.getElementById('count').innerText=annotations.length; list.innerHTML='';
            const filterVal = document.getElementById('sidebarFilter').value;
            let filtered = annotations.filter(a => {
                if(filterVal === 'all') return true;
                if(filterVal === 'High') return a.priority === 'High';
                if(filterVal === 'Pending') return a.status === 'Pending';
                if(filterVal === 'Image') return a.type === 'area';
                return true;
            });
            filtered.sort((a,b)=>a.page-b.page);
            filtered.forEach(a => {
                const d = document.createElement('div'); d.className='list-item'; d.style.borderLeftColor = a.color;
                const icon = a.type==='area'?'ğŸ–¼ï¸':'ğŸ“';
                let info = a.customData && Object.keys(a.customData).length>0 ? ` | ${a.customData[Object.keys(a.customData)[0]]}` : '';
                d.innerHTML = `
                    <div style="display:flex;justify-content:space-between;font-size:0.85em;color:#888;"><span>P.${a.page} ${icon}</span><span>${a.priority}</span></div>
                    <div style="font-weight:bold;margin:4px 0;">${a.code} <span style="font-weight:normal;font-size:0.8em;color:#666;">${info}</span></div>
                    <div style="font-size:0.85em;color:#666;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">${a.rtmId?`<b>[${a.rtmId}]</b> `:''}${a.text}</div>
                    <div class="item-actions">
                        <button class="icon-btn btn-edit" onclick="event.stopPropagation();jumpAndEdit('${a.id}')">âœï¸</button>
                        <button class="icon-btn btn-del" onclick="event.stopPropagation();deleteItem('${a.id}')">ğŸ—‘ï¸</button>
                    </div>`;
                d.onclick=()=>scrollToAnnotation(a); list.appendChild(d);
            });
        }
        function scrollToAnnotation(a) {
            const tb = Math.floor((a.page-1)/BATCH_SIZE);
            if(tb !== currentBatchIndex) { if(confirm(`è·³è½‰è‡³ P.${a.page}?`)){ currentBatchIndex=tb; renderCurrentBatch().then(()=>setTimeout(()=>doScroll(a),500)); } }
            else doScroll(a);
        }
        function doScroll(a) {
            const el = document.querySelector(`.pdf-page[data-page-number="${a.page}"]`);
            if(el) {
                el.scrollIntoView({behavior:'smooth'});
                if(a.type==='area') {
                    const area = document.createElement('div'); area.className='highlight-area highlight-flash';
                    area.style.left=a.rect.left+'px'; area.style.top=a.rect.top+'px'; area.style.width=a.rect.width+'px'; area.style.height=a.rect.height+'px';
                    el.appendChild(area); setTimeout(()=>area.remove(),1000);
                } else { el.classList.add('highlight-flash'); setTimeout(()=>el.classList.remove('highlight-flash'),1000); }
            }
        }
        function jumpAndEdit(id) { const a=annotations.find(x=>x.id===id); if(a) { currentSelection={...a}; scrollToAnnotation(a); setTimeout(()=>openModal(a),600); } }
        function deleteItem(id) { if(confirm("åˆªé™¤ï¼Ÿ")){ annotations=annotations.filter(a=>a.id!==id); renderSidebar(); saveToLocal(); renderCurrentBatch(); } }
        function restoreHighlights(pageNum, pageDiv) {
            annotations.filter(a=>a.page===pageNum).forEach(ann => {
                if(ann.type==='text') {
                    pageDiv.querySelectorAll('.textLayer span').forEach(s => {
                        if(s.innerText.length>1 && ann.text.includes(s.innerText)) { s.classList.add('highlight-text'); s.style.borderBottomColor=ann.color; s.style.backgroundColor=ann.color+'44'; s.onclick=(e)=>{e.stopPropagation(); jumpAndEdit(ann.id);} }
                    });
                } else {
                    const area = document.createElement('div'); area.className='highlight-area'; area.id='area-'+ann.id;
                    area.style.left=ann.rect.left+'px'; area.style.top=ann.rect.top+'px'; area.style.width=ann.rect.width+'px'; area.style.height=ann.rect.height+'px'; area.style.borderColor=ann.color;
                    area.onclick=(e)=>{e.stopPropagation(); jumpAndEdit(ann.id);}; pageDiv.appendChild(area);
                }
            });
        }

        // --- è¨­å®š (æ¨£æ¿ + é‡ç½®) ---
        function openSettings() {
            const pl=document.getElementById('presetList'); pl.innerHTML='';
            tagPresets.forEach((t,i) => { pl.innerHTML+=`<div class="mode-btn" style="border:1px solid ${t.color}"><span style="color:${t.color}">â—</span> ${t.name} <span style="cursor:pointer;color:red;" onclick="removePreset(${i})">Ã—</span></div>`; });
            const cl=document.getElementById('customFieldList'); cl.innerHTML='';
            customFields.forEach((f,i) => { cl.innerHTML+=`<div style="padding:5px;border-bottom:1px solid #eee;"><b>${f.label}</b> (${f.key}) <button class="danger" style="font-size:0.7em;float:right;" onclick="removeField(${i})">åˆªé™¤</button></div>`; });
            document.getElementById('settingsModal').style.display='flex';
        }
        function addPreset() { const n=document.getElementById('newTagName').value; const c=document.getElementById('newTagColor').value; if(n){ tagPresets.push({name:n, color:c}); openSettings(); } }
        function removePreset(i) { tagPresets.splice(i,1); openSettings(); }
        function addCustomField() { const k=document.getElementById('newFieldKey').value; const l=document.getElementById('newFieldLabel').value; if(k&&l){ customFields.push({key:k, label:l}); openSettings(); } }
        function removeField(i) { customFields.splice(i,1); openSettings(); }
        function renderQuickTags() {
            const a=document.getElementById('quickTagArea'); a.innerHTML='';
            tagPresets.forEach(t => { a.innerHTML+=`<div class="mode-btn" style="border:1px solid ${t.color};margin-right:5px;" onclick="document.getElementById('codeName').value='${t.name}';document.getElementById('codeColor').value='${t.color}'"><span style="color:${t.color}">â—</span> ${t.name}</div>`; });
        }
        
        function saveAsTemplate() {
            const tpl = { presets: tagPresets, customFields: customFields };
            localStorage.setItem(TEMPLATE_KEY, JSON.stringify(tpl));
            alert("âœ… ç›®å‰è¨­å®šå·²å„²å­˜ç‚ºã€Œé è¨­æ¨£æ¿ã€ï¼\nä¸‹æ¬¡é–‹å•Ÿæ–°æ–‡ä»¶å¯ç›´æ¥è¼‰å…¥ã€‚");
        }
        function loadFromTemplate(silent=false) {
            const tpl = localStorage.getItem(TEMPLATE_KEY);
            if(tpl) {
                const d = JSON.parse(tpl);
                tagPresets = d.presets || tagPresets;
                customFields = d.customFields || customFields;
                if(!silent) { openSettings(); alert("âœ… å·²è¼‰å…¥æ¨£æ¿è¨­å®šï¼"); }
            } else if(!silent) { alert("âš ï¸ å°šæœªå„²å­˜ä»»ä½•æ¨£æ¿ã€‚"); }
        }
        function resetAllData() {
            if(confirm("ğŸ›‘ è­¦å‘Šï¼šé€™å°‡æ¸…é™¤ç€è¦½å™¨ä¸­çš„ã€Œæ‰€æœ‰ã€å¿«å–è³‡æ–™ï¼ˆåŒ…å«æœªå­˜æª”çš„å°ˆæ¡ˆèˆ‡æ¨£æ¿ï¼‰ã€‚\n\nç¢ºå®šè¦é‡ç½®å—ï¼Ÿ")) {
                localStorage.clear();
                location.reload(); 
            }
        }

        // --- å­˜æª”èˆ‡åŒ¯å‡º ---
        function saveToLocal() { if(!isReaderMode) localStorage.setItem(AUTOSAVE_KEY, JSON.stringify({ annotations, globalMemo, timestamp: Date.now() })); }
        function checkAutoSave() {
            const s=localStorage.getItem(AUTOSAVE_KEY);
            if(s) { try{ const d=JSON.parse(s); if(d.annotations.length>0 && confirm("ç™¼ç¾æœªå­˜æª”ç´€éŒ„ï¼Œæ˜¯å¦å¾©åŸ?")) { annotations=d.annotations; globalMemo=d.globalMemo||""; renderSidebar(); } }catch(e){} }
        }
        function clearAutoSave() { if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰æ¨™è¨»è³‡æ–™ï¼Ÿ(ä¸æœƒåˆªé™¤æ¨£æ¿)")) { annotations=[]; globalMemo=""; saveToLocal(); renderSidebar(); renderCurrentBatch(); } }
        
        // å­˜æª”é‚è¼¯ (åŠ å…¥ lastBatch)
        function saveProject() { 
            download(JSON.stringify({ 
                annotations, presets: tagPresets, customFields, globalMemo, 
                lastBatch: currentBatchIndex // è¨˜éŒ„ç•¶å‰åˆ†é 
            }), `Project_${new Date().toISOString().slice(0,10)}.json`, 'application/json'); 
        }
        
        // è®€æª”é‚è¼¯ (æ¢å¾© lastBatch)
        function handleProjectLoad(input) {
            const f=input.files[0]; if(!f)return; const r=new FileReader();
            r.onload=e=>{
                const d=JSON.parse(e.target.result); annotations=d.annotations||[]; 
                if(d.presets) tagPresets=d.presets; if(d.customFields) customFields=d.customFields;
                if(d.globalMemo) globalMemo = d.globalMemo;
                if(typeof d.lastBatch !== 'undefined') currentBatchIndex = d.lastBatch; // æ¢å¾©åˆ†é 
                
                renderSidebar(); saveToLocal(); 
                if(pdfDoc) { renderCurrentBatch(); alert("å°ˆæ¡ˆè¼‰å…¥æˆåŠŸï¼å·²è·³è½‰è‡³ä¸Šæ¬¡é€²åº¦ã€‚"); }
                else { alert("å°ˆæ¡ˆè¼‰å…¥æˆåŠŸï¼è«‹åŒ¯å…¥ PDFã€‚"); }
            }; r.readAsText(f); input.value='';
        }
        
        async function exportExcel() {
            if(annotations.length===0) return alert("ç„¡è³‡æ–™");
            const wb = new ExcelJS.Workbook(); const ws = wb.addWorksheet('RTM');
            let cols = [{header:'ID',key:'rtmId',width:15},{header:'Page',key:'page',width:8},{header:'Tag',key:'code',width:20},{header:'Priority',key:'priority'},{header:'Status',key:'status'},{header:'Text',key:'text',width:50},{header:'Memo',key:'memo',width:40}];
            customFields.forEach(f=>cols.push({header:f.label, key:f.key, width:20}));
            ws.columns = cols;
            ws.getRow(1).font={bold:true,color:{argb:'FFFFFFFF'}}; ws.getRow(1).fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF444444'}};
            annotations.forEach(a=>{
                let d = {rtmId:a.rtmId, page:a.page, code:a.code, priority:a.priority, status:a.status, text:a.type==='area'?'[åœ–ç‰‡]':a.text, memo:a.memo};
                if(a.customData) customFields.forEach(f => d[f.key] = a.customData[f.key]||'');
                const r=ws.addRow(d); r.getCell('code').fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF'+a.color.replace('#','')}};
            });
            download(await wb.xlsx.writeBuffer(), `RTM_Report.xlsx`, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        }
        function exportReaderHtml() {
            let h = document.documentElement.outerHTML;
            const d = JSON.stringify({ annotations, presets:tagPresets, customFields, globalMemo });
            h = h.replace(/<script id="embedded-data" type="application\/json">.*?<\/script>/, `<script id="embedded-data" type="application/json">${d}<\/script>`);
            download(h, `Reader_Report.html`, 'text/html');
        }
        function checkEmbeddedData() {
            const s=document.getElementById('embedded-data');
            if(s && s.textContent.trim()) {
                const d=JSON.parse(s.textContent); annotations=d.annotations||[]; customFields=d.customFields||[]; globalMemo=d.globalMemo||"";
                isReaderMode=true; document.body.classList.add('mode-read'); renderSidebar(); alert("é–±è®€æ¨¡å¼");
            }
        }
        function download(c, n, t) { const b=new Blob([c],{type:t}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=n; a.click(); }
        function setMode(m) { editMode=m; document.getElementById('modeText').classList.toggle('active', m==='text'); document.getElementById('modeArea').classList.toggle('active', m==='area'); document.querySelectorAll('.pdf-page').forEach(p=>p.style.cursor=m==='text'?'text':'crosshair'); }
        function showLoader(t) { document.getElementById('loader').style.display='flex'; document.getElementById('loaderText').innerText=t; }
        function hideLoader() { document.getElementById('loader').style.display='none'; }
        function prevBatch() { if(currentBatchIndex>0) { currentBatchIndex--; renderCurrentBatch(); } }
        function nextBatch() { if(currentBatchIndex<totalBatches-1) { currentBatchIndex++; renderCurrentBatch(); } }
        function updateNavUI() {
             document.getElementById('btnPrev').disabled = currentBatchIndex===0; document.getElementById('btnPrev').style.opacity = currentBatchIndex===0?.5:1;
             document.getElementById('btnNext').disabled = currentBatchIndex>=totalBatches-1; document.getElementById('btnNext').style.opacity = currentBatchIndex>=totalBatches-1?.5:1;
        }
    </script>
</body>
</html>
